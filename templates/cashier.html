{% extends "base.html" %}
{% block title %}Kasse{% endblock %}
{% block header %}{% endblock %}
{% block content %}

<style>
  .cashier-page {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-height: calc(100vh - 180px);
  }
  .cashier-page > .card:last-child { margin-bottom: 0; }
  .cashier-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
    gap:0.6rem;
    align-items:start;
  }
  .cashier-grid a {
    display:block;
    height:100%;
  }
  .cashier-tile {
    background:#1f2a44;
    border:1px solid var(--border);
    border-radius:10px;
    padding:0.65rem 0.75rem 0.7rem;
    box-sizing:border-box;
    min-height:90px;
    height:100%;
    display:flex;
    flex-direction:column;
    justify-content:center;
    gap:.3rem;
    color:#e2e8f0;
    box-shadow:0 8px 20px rgba(0,0,0,0.25);
    transition: transform 0.12s ease, box-shadow 0.12s ease;
    height:100%;
  }
  .cashier-tile:hover { transform: translateY(-2px); box-shadow:0 12px 30px rgba(0,0,0,0.3); }
  .action-buttons { display:flex; gap:0.75rem; flex-wrap: wrap; }
  .action-buttons button { padding:0.9rem 1.1rem; font-size:1rem; }
  .checkout-btn { padding:1.25rem 1.65rem; font-size:1.1rem; min-height:72px; }
  .summary-card { display:flex; flex-direction:column; gap:0.45rem; min-height: 200px; }
  .summary-top { display:flex; align-items:center; justify-content:space-between; flex-wrap: wrap; gap: .4rem; }
  .event-name { margin-left:auto; font-weight:600; color:#e2e8f0; }
  .summary-meta { display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; }
  .summary-body { display:flex; gap:0.6rem; align-items:stretch; }
  .order-list-wrap {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 130px;
    max-height: 200px;
    overflow: auto;
    border: 1px dashed var(--border);
    border-radius: 10px;
    padding: 0.4rem 0.55rem 0.45rem;
    background: rgba(255,255,255,0.02);
  }
  .order-list {
    list-style:none;
    padding-left:0;
    margin:0.25rem 0 0;
    display:flex;
    flex-direction:column;
    gap:0.25rem;
  }
  .order-list li { padding:0.15rem 0.1rem; }
  .summary-actions {
    display:flex;
    flex-direction:column;
    gap:0.4rem;
    flex:0 0 200px;
    align-self:flex-start;
  }
  .summary-actions a { width:100%; }
  .summary-actions button {
    width: 100%;
    min-height:60px;
    font-size:1rem;
    padding:0.85rem 1.2rem;
  }
  .hint { font-size: 0.9rem; color: #cbd5e1; }
  .terminal-panel {
    border: 1px dashed var(--border);
    border-radius: 10px;
    padding: 0.65rem;
    background: rgba(255,255,255,0.03);
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
  .terminal-status {
    font-size: 0.95rem;
    color: #cbd5e1;
    min-height: 1.4rem;
  }
  .terminal-status.success { color: #22c55e; }
  .terminal-status.error { color: #f87171; }
  .products-card { flex:0 0 auto; display:flex; flex-direction:column; justify-content:flex-end; }
  
  /* Category grouping (compact) */
  .category-section {
    margin-bottom: 0.6rem;
  }
  .category-section:last-child {
    margin-bottom: 0;
  }
  .category-title {
    margin: 0 0 0.25rem 0;
    font-size: 0.85rem;
    font-weight: 600;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  
  @media (orientation: portrait) {
    .cashier-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    .action-buttons { flex-direction:column; align-items:stretch; }
    .action-buttons a { width:100%; }
    .action-buttons button { width:100%; }
  }
  @media (max-width: 720px) {
    .cashier-grid { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); }
    .summary-body { flex-direction:column; }
    .summary-actions { width:100%; flex:0 0 auto; }
  }
</style>

<div class="cashier-page">
  <div class="card summary-card">
    <div class="summary-top">
      <div class="summary-meta">
        <div class="badge badge-blue">Aktives Event</div>
        <div style="font-size:1.3rem;">Total: <strong data-cart-total>{{ total }}</strong> CHF</div>
      </div>
      <div class="event-name">{{ event.name }}</div>
    </div>

    <div class="summary-body">
      <div class="order-list-wrap">
        <div style="display:flex; align-items:center; justify-content: space-between; gap:0.4rem; margin-bottom:0.1rem;">
          <h3 style="margin:0;">Bestellliste</h3>
          {% if items %}<span class="badge badge-blue">{{ items|length }} Positionen</span>{% endif %}
        </div>
        {% if items %}
          <ul class="order-list">
            {% for item in items %}
              <li>{{ item.qty }}× {{ item.name }} — {{ item.price }} CHF ({{ item.line_total }} CHF)</li>
            {% endfor %}
          </ul>
        {% else %}
          <p style="margin:0;">Noch keine Artikel im Warenkorb.</p>
        {% endif %}
      </div>
      <div class="summary-actions">
        <div class="terminal-panel">
          <strong>Terminalzahlung</strong>
          {% if not sumup_configured %}
            <div class="hint">SumUp Zugangsdaten fehlen. Bitte im Adminbereich hinterlegen.</div>
          {% else %}
            {% if assigned_terminal %}
              <div class="pill">Terminal: {{ assigned_terminal.name }}</div>
              <input type="hidden" id="terminal-select" value="{{ assigned_terminal.id }}">
            {% else %}
              <label class="stack">
                <span>Freies Terminal wählen</span>
                <select id="terminal-select">
                  <option value="">Bitte wählen</option>
                  {% for terminal in available_terminals %}
                    <option value="{{ terminal.id }}">{{ terminal.name }}</option>
                  {% endfor %}
                </select>
              </label>
            {% endif %}
            {% if inactive_terminal %}
              <div class="hint">Zugewiesenes Terminal ist inaktiv: {{ inactive_terminal.name }}</div>
            {% endif %}
            {% if not assigned_terminal and not available_terminals %}
              <div class="hint">Kein freies Terminal verfügbar.</div>
            {% endif %}
            <button class="primary" id="terminal-pay-btn" type="button">Zahlung am Terminal starten</button>
            <div id="terminal-payment-status" class="terminal-status">Bereit.</div>
          {% endif %}
        </div>
        <a href="{{ url_for('remove_last') }}" id="remove-last-link"><button class="secondary">Letzter Artikel löschen</button></a>
        <a href="{{ url_for('checkout') }}"><button class="checkout-btn">Bestellung abschliessen</button></a>
      </div>
    </div>
  </div>

  <div class="card products-card">
    {% if buttons_by_category %}
      {% for category, category_buttons in buttons_by_category.items() %}
        <div class="category-section" data-category="{{ category }}">
          <div class="category-title">{{ category }}</div>
          <div class="cashier-grid">
            {% for button in category_buttons %}
              <a href="{{ url_for('add_item') }}?name={{ button.name }}" class="cashier-add-link" data-item-name="{{ button.name }}" style="text-decoration:none;">
                <div class="cashier-tile" style="background: {{ button.color or '#1f2a44' }};">
                  <div style="font-weight:700;">{{ button.label }}</div>
                  <div style="opacity:0.8;">{{ button.price_with_depot }} CHF</div>
                </div>
              </a>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="cashier-grid">
        {% for button in buttons %}
          <a href="{{ url_for('add_item') }}?name={{ button.name }}" class="cashier-add-link" data-item-name="{{ button.name }}" style="text-decoration:none;">
            <div class="cashier-tile" style="background: {{ button.color or '#1f2a44' }};">
              <div style="font-weight:700;">{{ button.label }}</div>
              <div style="opacity:0.8;">{{ button.price_with_depot }} CHF</div>
            </div>
          </a>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>
<script>
  // Auto-reload mode setting from server
  const AUTO_RELOAD = {{ 'true' if auto_reload else 'false' }};
  
  (function() {
    const wrap = document.querySelector(".order-list-wrap");
    if (wrap) {
      wrap.scrollTop = wrap.scrollHeight;
    }
    
    // Setup AJAX mode if auto_reload is disabled
    if (!AUTO_RELOAD) {
      setupAjaxMode();
    }
  })();
  
  function setupAjaxMode() {
    // Handle add item clicks
    document.querySelectorAll('.cashier-add-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const url = new URL(this.href, window.location.origin);
        url.searchParams.set('ajax', '1');
        fetch(url)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              updateCart(data.cart);
            }
          })
          .catch(error => {
            console.error('Error adding item:', error);
            // Fallback to regular redirect on error
            window.location.href = this.href;
          });
      });
    });
    
    // Handle remove last item click
    const removeLink = document.getElementById('remove-last-link');
    if (removeLink) {
      removeLink.addEventListener('click', function(e) {
        e.preventDefault();
        const url = new URL(this.href, window.location.origin);
        url.searchParams.set('ajax', '1');
        fetch(url)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              updateCart(data.cart);
            }
          })
          .catch(error => {
            console.error('Error removing item:', error);
            // Fallback to regular redirect on error
            window.location.href = this.href;
          });
      });
    }
  }
  
  function updateCart(cartData) {
    // Update total
    const totalElement = document.querySelector('[data-cart-total]');
    if (totalElement) {
      totalElement.textContent = cartData.total;
    }

    updateTerminalPayState();
    
    // Update item count badge
    const badgeContainer = document.querySelector('.order-list-wrap h3').parentElement;
    let badge = badgeContainer.querySelector('.badge');
    if (cartData.item_count > 0) {
      if (!badge) {
        badge = document.createElement('span');
        badge.className = 'badge badge-blue';
        badgeContainer.appendChild(badge);
      }
      badge.textContent = cartData.items.length + ' Positionen';
    } else if (badge) {
      badge.remove();
    }
    
    // Update order list
    const orderListWrap = document.querySelector('.order-list-wrap');
    const existingList = orderListWrap.querySelector('.order-list');
    const existingMessage = orderListWrap.querySelector('p');
    
    if (cartData.items.length > 0) {
      if (existingMessage) {
        existingMessage.remove();
      }
      
      let list = existingList;
      if (!list) {
        list = document.createElement('ul');
        list.className = 'order-list';
        orderListWrap.appendChild(list);
      }
      
      list.innerHTML = cartData.items.map(item => 
        `<li>${item.qty}× ${item.name} — ${item.price} CHF (${item.line_total} CHF)</li>`
      ).join('');
      
      // Scroll to bottom
      orderListWrap.scrollTop = orderListWrap.scrollHeight;
    } else {
      if (existingList) {
        existingList.remove();
      }
      if (!existingMessage) {
        const message = document.createElement('p');
        message.style.margin = '0';
        message.textContent = 'Noch keine Artikel im Warenkorb.';
        orderListWrap.appendChild(message);
      }
    }
  }

  const terminalButton = document.getElementById('terminal-pay-btn');
  const terminalSelect = document.getElementById('terminal-select');
  const terminalStatus = document.getElementById('terminal-payment-status');
  let terminalPoller = null;
  let activePaymentId = null;

  function getCartTotal() {
    const totalElement = document.querySelector('[data-cart-total]');
    return totalElement ? parseFloat(totalElement.textContent || '0') : 0;
  }

  function getSelectedTerminal() {
    if (!terminalSelect) {
      return null;
    }
    return terminalSelect.value || null;
  }

  function setTerminalStatus(message, state) {
    if (!terminalStatus) return;
    terminalStatus.textContent = message;
    terminalStatus.classList.remove('success', 'error');
    if (state) {
      terminalStatus.classList.add(state);
    }
  }

  function updateTerminalPayState() {
    if (!terminalButton) return;
    const total = getCartTotal();
    const terminalId = getSelectedTerminal();
    const disabled = total <= 0 || !terminalId || activePaymentId !== null;
    terminalButton.disabled = disabled;
  }

  function stopPolling() {
    if (terminalPoller) {
      clearInterval(terminalPoller);
      terminalPoller = null;
    }
  }

  async function pollTerminalStatus(paymentId) {
    try {
      const response = await fetch(`/api/terminal-payments/${paymentId}`);
      const data = await response.json();
      if (!data.success) {
        setTerminalStatus(data.error || 'Status konnte nicht geladen werden.', 'error');
        stopPolling();
        activePaymentId = null;
        updateTerminalPayState();
        return;
      }
      if (data.status === 'pending') {
        setTerminalStatus('Zahlung läuft am Terminal …');
        return;
      }
      if (data.status === 'success') {
        setTerminalStatus('Zahlung erfolgreich. Bestellung wird abgeschlossen …', 'success');
        stopPolling();
        window.location.href = '/cashier/checkout';
        return;
      }
      const statusText = {
        failed: 'Zahlung fehlgeschlagen.',
        aborted: 'Zahlung abgebrochen.',
        timeout: 'Zahlung abgelaufen.',
      }[data.status] || 'Zahlung beendet.';
      setTerminalStatus(statusText, 'error');
      stopPolling();
      activePaymentId = null;
      updateTerminalPayState();
    } catch (error) {
      console.error('Status-Fehler:', error);
      setTerminalStatus('Status konnte nicht geladen werden.', 'error');
      stopPolling();
      activePaymentId = null;
      updateTerminalPayState();
    }
  }

  if (terminalSelect) {
    terminalSelect.addEventListener('change', updateTerminalPayState);
  }

  if (terminalButton) {
    updateTerminalPayState();
    terminalButton.addEventListener('click', async () => {
      const terminalId = getSelectedTerminal();
      const total = getCartTotal();
      if (!terminalId || total <= 0) {
        setTerminalStatus('Bitte Terminal wählen und Betrag prüfen.', 'error');
        return;
      }
      terminalButton.disabled = true;
      setTerminalStatus('Zahlung wird gestartet …');
      try {
        const response = await fetch('/api/terminal-payments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            terminal_id: parseInt(terminalId, 10),
            amount_cents: Math.round(total * 100),
            currency: 'CHF',
          }),
        });
        const data = await response.json();
        if (!data.success) {
          setTerminalStatus(data.error || 'Zahlung konnte nicht gestartet werden.', 'error');
          terminalButton.disabled = false;
          return;
        }
        activePaymentId = data.payment_id;
        setTerminalStatus('Zahlung läuft am Terminal …');
        stopPolling();
        terminalPoller = setInterval(() => pollTerminalStatus(activePaymentId), 2000);
        await pollTerminalStatus(activePaymentId);
      } catch (error) {
        console.error('Start-Fehler:', error);
        setTerminalStatus('Zahlung konnte nicht gestartet werden.', 'error');
        terminalButton.disabled = false;
      }
    });
  }
</script>
{% endblock %}
