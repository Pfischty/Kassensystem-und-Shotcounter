<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Rangliste</title>
    <!-- CSS-Datei laden -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- Socket.io (ohne integrity-Attribut) -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js" crossorigin="anonymous"></script>
</head>
<body>
    <!-- Canvas für den animierten Hintergrund -->
    <canvas id="backgroundCanvas"></canvas>
    <!-- Logo-Bereich -->
    <div class="logo-area">
        <!-- Pfad zum Logo muss angepasst werden -->
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo">
    </div>
    
    <!-- Titel -->
    <h1>Winterfäscht Beachparty Shotcounter</h1>
    <div id="refresh-indicator">
        Live-Update aktiv. Letzte Aktualisierung: <span id="last-update">-</span>
    </div>

    <!-- Tabelle -->
    <table id="leaderboard-table">
        <thead>
            <tr>
                <th>Rang</th>
                <th>Team</th>
                <th>Shots</th>
            </tr>
        </thead>
        <tbody id="leaderboard-body">
            {% for team in teams %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ team.team }}</td>
                <td>{{ team.score }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Socket.io Script -->
    <script>
        const tableBody = document.getElementById('leaderboard-body');
        const lastUpdate = document.getElementById('last-update');
        let updateTimer = null;

        function updateIndicator(timestamp) {
            const date = new Date(timestamp * 1000);
            lastUpdate.textContent = date.toLocaleTimeString();
            if (updateTimer) {
                clearInterval(updateTimer);
            }
            let seconds = 0;
            updateTimer = setInterval(() => {
                seconds += 1;
                lastUpdate.textContent = `${date.toLocaleTimeString()} (+${seconds}s)`;
            }, 1000);
        }

        function renderLeaderboard(payload) {
            if (!payload || !payload.teams) return;
            tableBody.innerHTML = '';
            payload.teams.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.rank}</td>
                    <td>${entry.team}</td>
                    <td>${entry.score}</td>
                `;
                tableBody.appendChild(row);
            });
            if (payload.generated_at) {
                updateIndicator(payload.generated_at);
            }
        }

        function fetchInitial() {
            fetch('{{ url_for("leaderboard_data") }}')
                .then(response => response.json())
                .then(renderLeaderboard)
                .catch(() => {});
        }

        function startSocket() {
            const socket = io();
            socket.on('leaderboard_data', renderLeaderboard);
            socket.on('connect_error', startSSE);
            socket.on('disconnect', startSSE);
        }

        function startSSE() {
            const source = new EventSource('{{ url_for("leaderboard_stream") }}');
            source.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    renderLeaderboard(data);
                } catch (e) {
                    console.error('Fehler beim Parsen des SSE-Events', e);
                }
            };
            source.onerror = () => {
                source.close();
            };
        }

        fetchInitial();
        startSocket();
    </script>
    

    <!-- JavaScript für die Hintergrundanimation -->
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>
