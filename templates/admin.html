{% extends "base.html" %}
{% block title %}Admin{% endblock %}
{% block content %}
<style>
  /* General Styles */
  .muted { color: #94a3b8; font-size: 0.95rem; }
  .hint { font-size:0.9rem; color:#cbd5e1; margin-top:0.2rem; }
  .stack { display:flex; flex-direction:column; gap:0.35rem; }
  .field-inline { display:flex; gap:0.6rem; flex-wrap:wrap; align-items:center; }
  
  /* Tab Navigation Styles */
  .admin-tabs {
    background: rgba(255,255,255,0.02);
    border-bottom: 2px solid var(--border);
    margin-bottom: 2rem;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(10px);
  }
  
  .admin-tabs__nav {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    overflow-x: auto;
    flex-wrap: wrap;
  }
  
  .admin-tabs__tab {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: #94a3b8;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.2s ease;
    white-space: nowrap;
  }
  
  .admin-tabs__tab:hover {
    color: #e2e8f0;
    background: rgba(255,255,255,0.05);
  }
  
  .admin-tabs__tab.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    background: rgba(59, 130, 246, 0.1);
  }
  
  /* Tab Content */
  .admin-tabs__content {
    display: none;
    animation: fadeIn 0.3s ease;
  }
  
  .admin-tabs__content.active {
    display: block;
  }
  
  /* Section Styles */
  .admin-section {
    background: #0b1222;
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .admin-section__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }
  
  .admin-section__title {
    margin: 0;
    font-size: 1.25rem;
  }
  
  .admin-section__subtitle {
    color: #94a3b8;
    font-size: 0.9rem;
    margin-top: 0.25rem;
  }
  
  /* Subsection Styles */
  .admin-subsection {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(255,255,255,0.05);
  }
  
  .admin-subsection:first-child {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
  }
  
  .admin-subsection__title {
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
    color: #e2e8f0;
  }
  
  /* Form Styles */
  .admin-form__group {
    margin-bottom: 1rem;
  }
  
  .admin-form__label {
    display: block;
    margin-bottom: 0.5rem;
    color: #cbd5e1;
    font-size: 0.95rem;
  }
  
  .admin-form__input,
  .admin-form__select,
  .admin-form__textarea {
    width: 100%;
    padding: 0.75rem;
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: #e2e8f0;
    font-size: 1rem;
  }
  
  .admin-form__input:focus,
  .admin-form__select:focus,
  .admin-form__textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    background: rgba(59, 130, 246, 0.05);
  }
  
  /* Auto-save indicator */
  .save-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.9rem;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .save-indicator.saving {
    opacity: 1;
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
  }
  
  .save-indicator.saved {
    opacity: 1;
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
  }
  
  .save-indicator.error {
    opacity: 1;
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
  }
  
  /* Event Card Styles */
  .event-card {
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.2s ease;
  }
  
  .event-card:hover {
    border-color: rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.04);
  }
  
  .event-card__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .event-card__name {
    font-size: 1.1rem;
    font-weight: 600;
  }
  
  .event-card__actions {
    display: flex;
    gap: 0.5rem;
  }
  
  /* Badge Styles */
  .badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 500;
  }
  
  .badge-green {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.5);
  }
  
  .badge-red {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.5);
  }
  
  .badge-yellow {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
    border: 1px solid rgba(245, 158, 11, 0.5);
  }
  
  .badge-blue {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
    border: 1px solid rgba(59, 130, 246, 0.5);
  }
  
  /* Grid Layout for Settings */
  .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
  }
  
  /* Color Input */
  .color-input {
    height: 44px;
    padding: 0.25rem;
    cursor: pointer;
  }
  
  /* Product Editor */
  .product-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1rem;
  }
  
  .product-item {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 1rem;
    align-items: center;
    padding: 0.75rem;
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 8px;
  }
  
  .product-item:hover {
    border-color: rgba(255,255,255,0.1);
  }
  
  /* Animation */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  .spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
</style>

<h1>Adminbereich</h1>

<!-- Tab Navigation -->
<div class="admin-tabs">
  <nav class="admin-tabs__nav">
    <button type="button" class="admin-tabs__tab active" data-tab="system">
      Systemeinstellungen
    </button>
    <button type="button" class="admin-tabs__tab" data-tab="security">
      Sicherheit
    </button>
    <button type="button" class="admin-tabs__tab" data-tab="events">
      Eventauswahl
    </button>
    {% if active_event %}
    <button type="button" class="admin-tabs__tab" data-tab="event-settings">
      Eventeinstellungen
    </button>
    {% endif %}
  </nav>
</div>

<!-- Tab: Systemeinstellungen -->
<div class="admin-tabs__content active" data-tab-content="system">
  
  <!-- 1.1 Netzwerk -->
  <div class="admin-section">
    <div class="admin-section__header">
      <div>
        <h2 class="admin-section__title">1.1 Netzwerk</h2>
        <p class="admin-section__subtitle">LAN (eth0) und WLAN (wlan0) Schnittstellen verwalten</p>
      </div>
      <span class="save-indicator" data-save-indicator="network"></span>
    </div>
    <div id="network-status" data-auto-load="/admin/network">
      <p class="muted">Lade Netzwerkinformationen...</p>
    </div>
  </div>
  
  <!-- 1.2 Update -->
  <div class="admin-section">
    <div class="admin-section__header">
      <div>
        <h2 class="admin-section__title">1.2 Update</h2>
        <p class="admin-section__subtitle">Git-Repository aktualisieren und Service neu starten</p>
      </div>
      <span class="save-indicator" data-save-indicator="update"></span>
    </div>
    <div id="git-status" data-auto-load="/admin/system/git-status">
      <p class="muted">Lade Git-Informationen...</p>
    </div>
  </div>
  
</div>

<!-- Tab: Sicherheit -->
<div class="admin-tabs__content" data-tab-content="security">
  
  <!-- 2.1 Admin Zugangsdaten -->
  <div class="admin-section">
    <div class="admin-section__header">
      <div>
        <h2 class="admin-section__title">2.1 Admin Zugangsdaten</h2>
        <p class="admin-section__subtitle">Benutzername und Passwort für den Admin-Bereich verwalten</p>
      </div>
      <span class="save-indicator" data-save-indicator="credentials"></span>
    </div>
    
    <form data-auto-save data-endpoint="/admin/credentials" data-indicator="credentials">
      <div class="admin-form__group">
        <label class="admin-form__label" for="admin_username">Benutzername</label>
        <input 
          class="admin-form__input" 
          id="admin_username" 
          name="admin_username" 
          type="text"
          value="{% if admin_username %}{{ admin_username }}{% endif %}" 
          placeholder="admin" 
          required
        >
        <div class="hint">Der Benutzername für die Admin-Authentifizierung</div>
      </div>
      
      <div class="admin-form__group">
        <label class="admin-form__label" for="admin_password">Passwort</label>
        <input 
          class="admin-form__input" 
          id="admin_password" 
          name="admin_password" 
          type="password"
          placeholder="Neues Passwort (mind. 8 Zeichen)"
        >
        <div class="hint">
          {% if has_password %}
            Leer lassen, um das aktuelle Passwort beizubehalten
          {% else %}
            Setzen Sie ein Passwort, um den Admin-Bereich zu schützen
          {% endif %}
        </div>
      </div>
      
      <div class="muted" style="margin-top: 1rem;">
        <strong>Hinweis:</strong> Die Zugangsdaten werden in der Datei <code>instance/credentials.json</code> gespeichert.
        {% if not has_password %}
        Solange kein Passwort gesetzt ist, ist der Admin-Bereich ohne Authentifizierung zugänglich.
        {% endif %}
      </div>
    </form>
  </div>
  
</div>

<!-- Tab: Eventauswahl -->
<div class="admin-tabs__content" data-tab-content="events">
  
  <!-- 3.1 Event Liste und Erstellung -->
  <div class="admin-section">
    <div class="admin-section__header">
      <div>
        <h2 class="admin-section__title">3.1 Event Verwaltung</h2>
        <p class="admin-section__subtitle">Events erstellen, aktivieren und verwalten</p>
      </div>
      <button type="button" class="primary" id="create-event-btn">+ Neues Event</button>
    </div>
    
    <div class="event-list">
      {% if not events %}
        <p class="muted">Es wurden noch keine Events angelegt.</p>
      {% else %}
        {% for event in events %}
        <div class="event-card">
          <div class="event-card__header">
            <div>
              <span class="event-card__name">{{ event.name }}</span>
              {% if event.is_active %}
                <span class="badge badge-green">Aktiv</span>
              {% endif %}
              {% if event.is_archived %}
                <span class="badge badge-red">Archiviert</span>
              {% endif %}
              {% if event.kassensystem_enabled %}
                <span class="badge badge-blue">Kasse</span>
              {% endif %}
              {% if event.shotcounter_enabled %}
                <span class="badge badge-yellow">Shotcounter</span>
              {% endif %}
              <div class="muted" style="margin-top: 0.25rem;">
                Letzte Änderung: {{ event.updated_at.strftime("%d.%m.%Y %H:%M") if event.updated_at else "–" }}
              </div>
            </div>
            <div class="event-card__actions">
              <form method="post" action="{{ url_for('activate_event', event_id=event.id) if (event.is_archived or not event.is_active) else url_for('archive_event', event_id=event.id) }}" style="display: inline;">
                <button type="submit" class="secondary">
                  {% if event.is_archived %}
                    Aktivieren
                  {% elif event.is_active %}
                    Archivieren
                  {% else %}
                    Aktivieren
                  {% endif %}
                </button>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      {% endif %}
    </div>
    
    <!-- Event Creation Form (Initially Hidden) -->
    <div id="event-creation-form" style="display: none; margin-top: 2rem; padding: 1.5rem; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
      <h3 style="margin-top: 0;">Neues Event erstellen</h3>
      <form method="post" action="{{ url_for('create_event') }}">
        <div class="admin-form__group">
          <label class="admin-form__label" for="event_name">Event Name</label>
          <input class="admin-form__input" id="event_name" name="name" placeholder="z.B. Sommerfest 2026" required>
        </div>
        
        <div class="field-inline" style="margin: 1rem 0;">
          <label>
            <input type="checkbox" name="kassensystem_enabled" checked>
            Kassensystem aktiv
          </label>
          <label>
            <input type="checkbox" name="shotcounter_enabled" checked>
            Shotcounter aktiv
          </label>
        </div>
        
        <div class="field-inline" style="margin: 1rem 0;">
          <button type="submit" class="primary">Event erstellen</button>
          <button type="button" class="secondary" id="cancel-event-btn">Abbrechen</button>
        </div>
      </form>
    </div>
    
  </div>
  
</div>

<!-- Tab: Eventeinstellungen (Only if active event exists) -->
{% if active_event %}
<div class="admin-tabs__content" data-tab-content="event-settings">
  
  <!-- 4.1 Eventparameter -->
  <div class="admin-section">
    <div class="admin-section__header">
      <div>
        <h2 class="admin-section__title">4.1 Eventparameter</h2>
        <p class="admin-section__subtitle">Aktives Event: <strong>{{ active_event.name }}</strong></p>
      </div>
      <span class="save-indicator" data-save-indicator="event-params"></span>
    </div>
    
    <form data-auto-save data-endpoint="/admin/events/{{ active_event.id }}/parameters" data-indicator="event-params">
      <div class="settings-grid">
        <div class="admin-form__group">
          <label class="admin-form__label">
            <input type="checkbox" name="kassensystem_enabled" {% if active_event.kassensystem_enabled %}checked{% endif %}>
            Kassensystem aktiviert
          </label>
        </div>
        
        <div class="admin-form__group">
          <label class="admin-form__label">
            <input type="checkbox" name="shotcounter_enabled" {% if active_event.shotcounter_enabled %}checked{% endif %}>
            Shotcounter aktiviert
          </label>
        </div>
      </div>
      
      <div class="admin-form__group" style="margin-top: 1rem;">
        <label class="admin-form__label" for="default_font_size">Standard Schriftgröße (rem)</label>
        <input class="admin-form__input" type="number" id="default_font_size" name="default_font_size" 
               min="0.5" max="5" step="0.1" value="1.0">
        <div class="hint">Globale Schriftgröße für alle Ansichten</div>
      </div>
    </form>
  </div>
  
  <!-- 4.2 Kassensystem -->
  <div class="admin-section">
    <div class="admin-section__header">
      <div>
        <h2 class="admin-section__title">4.2 Kassensystem</h2>
        <p class="admin-section__subtitle">Styling und Einstellungen für das Kassensystem</p>
      </div>
      <span class="save-indicator" data-save-indicator="kassensystem"></span>
    </div>
    
    <div class="admin-subsection">
      <h3 class="admin-subsection__title">Styling</h3>
      <form data-auto-save data-endpoint="/admin/events/{{ active_event.id }}/kassensystem/styling" data-indicator="kassensystem">
        <div class="settings-grid">
          <div class="admin-form__group">
            <label class="admin-form__label" for="kasse_bg_color">Hintergrundfarbe</label>
            <input class="admin-form__input color-input" type="color" id="kasse_bg_color" name="background_color" value="#0b1222">
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label" for="kasse_primary_color">Primärfarbe</label>
            <input class="admin-form__input color-input" type="color" id="kasse_primary_color" name="primary_color" value="#3b82f6">
          </div>
        </div>
      </form>
    </div>
    
    <div class="admin-subsection">
      <h3 class="admin-subsection__title">Einstellungen</h3>
      <form data-auto-save data-endpoint="/admin/events/{{ active_event.id }}/kassensystem/settings" data-indicator="kassensystem">
        <div class="admin-form__group">
          <label class="admin-form__label">
            <input type="checkbox" name="auto_reload_on_add" checked>
            Auto-Reload beim Hinzufügen
          </label>
          <div class="hint">Kasse automatisch neu laden, wenn Artikel hinzugefügt werden</div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- 4.3 Preisliste -->
  <div class="admin-section">
    <div class="admin-section__header">
      <div>
        <h2 class="admin-section__title">4.3 Preisliste</h2>
        <p class="admin-section__subtitle">Styling und Einstellungen für die Preisliste</p>
      </div>
      <span class="save-indicator" data-save-indicator="preisliste"></span>
    </div>
    
    <div class="admin-subsection">
      <h3 class="admin-subsection__title">Styling</h3>
      <form data-auto-save data-endpoint="/admin/events/{{ active_event.id }}/price-list/styling" data-indicator="preisliste">
        <div class="settings-grid">
          <div class="admin-form__group">
            <label class="admin-form__label" for="pl_font_size">Schriftgröße (rem)</label>
            <input class="admin-form__input" type="number" id="pl_font_size" name="font_size" 
                   min="0.6" max="6" step="0.1" value="1.2">
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label" for="pl_rotation">Rotationsintervall (Sekunden)</label>
            <input class="admin-form__input" type="number" id="pl_rotation" name="rotation_seconds" 
                   min="2" max="120" step="1" value="10">
          </div>
        </div>
      </form>
    </div>
    
    <div class="admin-subsection">
      <h3 class="admin-subsection__title">Hintergrund</h3>
      <form data-auto-save data-endpoint="/admin/events/{{ active_event.id }}/price-list/background" data-indicator="preisliste" enctype="multipart/form-data">
        <div class="admin-form__group">
          <label class="admin-form__label" for="pl_bg_mode">Hintergrund Modus</label>
          <select class="admin-form__select" id="pl_bg_mode" name="background_mode">
            <option value="none">Keiner</option>
            <option value="custom">Eigenes Bild</option>
          </select>
        </div>
        
        <div class="admin-form__group" id="pl-image-upload" style="display: none;">
          <label class="admin-form__label" for="pl_bg_image">Hintergrundbild hochladen</label>
          <input class="admin-form__input" type="file" id="pl_bg_image" name="background_image" accept="image/*">
          <div class="hint">Unterstützte Formate: PNG, JPG, GIF, WebP (max. 5MB)</div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- 4.4 Shotcounter -->
  <div class="admin-section">
    <div class="admin-section__header">
      <div>
        <h2 class="admin-section__title">4.4 Shotcounter</h2>
        <p class="admin-section__subtitle">Styling und Einstellungen für den Shotcounter</p>
      </div>
      <span class="save-indicator" data-save-indicator="shotcounter"></span>
    </div>
    
    <div class="admin-subsection">
      <h3 class="admin-subsection__title">Styling</h3>
      <form data-auto-save data-endpoint="/admin/events/{{ active_event.id }}/shotcounter/styling" data-indicator="shotcounter">
        <div class="settings-grid">
          <div class="admin-form__group">
            <label class="admin-form__label" for="shot_bg_color">Hintergrundfarbe</label>
            <input class="admin-form__input color-input" type="color" id="shot_bg_color" name="background_color" 
                   value="{{ (shot_settings_map[active_event.id] or {}).get('background_color', '#0b1222') }}">
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label" for="shot_primary_color">Primärfarbe</label>
            <input class="admin-form__input color-input" type="color" id="shot_primary_color" name="primary_color" 
                   value="{{ (shot_settings_map[active_event.id] or {}).get('primary_color', '#3b82f6') }}">
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label" for="shot_secondary_color">Sekundärfarbe</label>
            <input class="admin-form__input color-input" type="color" id="shot_secondary_color" name="secondary_color" 
                   value="{{ (shot_settings_map[active_event.id] or {}).get('secondary_color', '#10b981') }}">
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label" for="shot_tertiary_color">Tertiärfarbe</label>
            <input class="admin-form__input color-input" type="color" id="shot_tertiary_color" name="tertiary_color" 
                   value="{{ (shot_settings_map[active_event.id] or {}).get('tertiary_color', '#f59e0b') }}">
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label" for="shot_title_size">Titel Schriftgröße (rem)</label>
            <input class="admin-form__input" type="number" id="shot_title_size" name="title_size" 
                   min="1" max="10" step="0.1" value="{{ (shot_settings_map[active_event.id] or {}).get('title_size', 3) }}">
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label" for="shot_team_size">Team Schriftgröße (rem)</label>
            <input class="admin-form__input" type="number" id="shot_team_size" name="team_size" 
                   min="1" max="10" step="0.1" value="{{ (shot_settings_map[active_event.id] or {}).get('team_size', 2) }}">
          </div>
        </div>
      </form>
    </div>
    
    <div class="admin-subsection">
      <h3 class="admin-subsection__title">Einstellungen</h3>
      <form data-auto-save data-endpoint="/admin/events/{{ active_event.id }}/shotcounter/settings" data-indicator="shotcounter">
        <div class="settings-grid">
          <div class="admin-form__group">
            <label class="admin-form__label" for="shot_leaderboard_limit">Anzahl Teams im Leaderboard</label>
            <input class="admin-form__input" type="number" id="shot_leaderboard_limit" name="leaderboard_limit" 
                   min="1" max="50" step="1" value="{{ (shot_settings_map[active_event.id] or {}).get('leaderboard_limit', 10) }}">
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label" for="shot_layout">Leaderboard Layout</label>
            <select class="admin-form__select" id="shot_layout" name="leaderboard_layout">
              <option value="stacked" {% if (shot_settings_map[active_event.id] or {}).get('leaderboard_layout') == 'stacked' %}selected{% endif %}>Gestapelt</option>
              <option value="inline" {% if (shot_settings_map[active_event.id] or {}).get('leaderboard_layout') == 'inline' %}selected{% endif %}>Inline</option>
            </select>
          </div>
        </div>
      </form>
    </div>
    
    <div class="admin-subsection">
      <h3 class="admin-subsection__title">Hintergrund</h3>
      <form data-auto-save data-endpoint="/admin/events/{{ active_event.id }}/shotcounter/background" data-indicator="shotcounter" enctype="multipart/form-data">
        <div class="admin-form__group">
          <label class="admin-form__label" for="shot_bg_image">Hintergrundbild hochladen</label>
          <input class="admin-form__input" type="file" id="shot_bg_image" name="background_image" accept="image/*">
          <div class="hint">Unterstützte Formate: PNG, JPG, GIF, WebP (max. 5MB)</div>
        </div>
        
        {% if (shot_settings_map[active_event.id] or {}).get('background_image') %}
        <div class="muted" style="margin-top: 0.5rem;">
          Aktuelles Bild: <code>{{ (shot_settings_map[active_event.id] or {}).get('background_image') }}</code>
        </div>
        {% endif %}
      </form>
    </div>
  </div>
  
  <!-- 4.5 Produkte -->
  <div class="admin-section">
    <div class="admin-section__header">
      <div>
        <h2 class="admin-section__title">4.5 Produkte & Kategorien</h2>
        <p class="admin-section__subtitle">Produkte und Kategorien verwalten</p>
      </div>
      <button type="button" class="primary" id="add-product-btn">+ Neues Produkt</button>
    </div>
    
    <div class="admin-subsection">
      <h3 class="admin-subsection__title">Kategorien</h3>
      <div class="muted" style="margin-bottom: 1rem;">
        Kategorien werden automatisch aus den Produkten generiert. Sie können die Sichtbarkeit pro System steuern.
      </div>
      <div id="category-list">
        <p class="muted">Lade Kategorien...</p>
      </div>
    </div>
    
    <div class="admin-subsection">
      <h3 class="admin-subsection__title">Produktliste</h3>
      <div class="product-list" id="product-list">
        {% if event_buttons.get(active_event.id) %}
          {% for product in event_buttons[active_event.id] %}
          <div class="product-item">
            <div>
              <strong>{{ product.name }}</strong>
              <div class="muted">{{ product.category or 'Keine Kategorie' }}</div>
            </div>
            <div>
              <span class="badge badge-blue">{{ (product.price / 100) | round(2) }} €</span>
            </div>
            <div>
              <button type="button" class="secondary small" data-edit-product="{{ product.name }}">Bearbeiten</button>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <p class="muted">Noch keine Produkte angelegt.</p>
        {% endif %}
      </div>
    </div>
    
    <div class="admin-subsection">
      <h3 class="admin-subsection__title">Medienmanagement</h3>
      <div class="muted" style="margin-bottom: 1rem;">
        Bilder hochladen und verwalten für Hintergründe und Produktbilder.
      </div>
      <form data-endpoint="/admin/media/upload" enctype="multipart/form-data">
        <div class="admin-form__group">
          <label class="admin-form__label" for="media_upload">Neue Medien hochladen</label>
          <input class="admin-form__input" type="file" id="media_upload" name="media_files" accept="image/*" multiple>
          <div class="hint">Mehrere Dateien können gleichzeitig hochgeladen werden</div>
        </div>
        <button type="submit" class="primary">Hochladen</button>
      </form>
      
      <div id="media-list" style="margin-top: 1.5rem;">
        <p class="muted">Lade Mediendateien...</p>
      </div>
    </div>
  </div>
  
</div>
{% endif %}

<script>
// Tab Switching
document.querySelectorAll('.admin-tabs__tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const tabName = tab.dataset.tab;
    
    // Update active tab
    document.querySelectorAll('.admin-tabs__tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    // Update active content
    document.querySelectorAll('.admin-tabs__content').forEach(c => c.classList.remove('active'));
    const content = document.querySelector(`[data-tab-content="${tabName}"]`);
    if (content) {
      content.classList.add('active');
    }
  });
});

// Auto-load content for specific sections
document.querySelectorAll('[data-auto-load]').forEach(elem => {
  const url = elem.dataset.autoLoad;
  fetch(url)
    .then(res => res.text())
    .then(html => {
      elem.innerHTML = html;
    })
    .catch(err => {
      elem.innerHTML = `<p class="muted" style="color: #ef4444;">Fehler beim Laden: ${err.message}</p>`;
    });
});

// Auto-save functionality
document.querySelectorAll('[data-auto-save]').forEach(form => {
  const endpoint = form.dataset.endpoint;
  const indicatorName = form.dataset.indicator;
  const indicator = document.querySelector(`[data-save-indicator="${indicatorName}"]`);
  
  let saveTimeout;
  
  const showIndicator = (state, message) => {
    if (!indicator) return;
    
    indicator.className = 'save-indicator ' + state;
    indicator.innerHTML = message;
    
    if (state === 'saved' || state === 'error') {
      setTimeout(() => {
        indicator.classList.remove('saved', 'error');
      }, 3000);
    }
  };
  
  const saveForm = () => {
    showIndicator('saving', '<span class="spinner"></span> Speichere...');
    
    const formData = new FormData(form);
    
    fetch(endpoint, {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showIndicator('saved', '✓ Gespeichert');
      } else {
        showIndicator('error', '✗ Fehler: ' + (data.error || 'Unbekannter Fehler'));
      }
    })
    .catch(err => {
      showIndicator('error', '✗ Fehler: ' + err.message);
    });
  };
  
  // Listen to all input changes
  form.addEventListener('input', () => {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(saveForm, 1000); // Debounce 1 second
  });
  
  form.addEventListener('change', () => {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(saveForm, 500); // Faster save on explicit change (e.g., checkbox, select)
  });
});

// Event creation toggle
const createEventBtn = document.getElementById('create-event-btn');
const eventCreationForm = document.getElementById('event-creation-form');
const cancelEventBtn = document.getElementById('cancel-event-btn');

if (createEventBtn) {
  createEventBtn.addEventListener('click', () => {
    eventCreationForm.style.display = 'block';
    createEventBtn.style.display = 'none';
  });
}

if (cancelEventBtn) {
  cancelEventBtn.addEventListener('click', () => {
    eventCreationForm.style.display = 'none';
    createEventBtn.style.display = 'inline-block';
  });
}

// Show/hide price list image upload based on mode
const plBgMode = document.getElementById('pl_bg_mode');
const plImageUpload = document.getElementById('pl-image-upload');

if (plBgMode && plImageUpload) {
  plBgMode.addEventListener('change', () => {
    plImageUpload.style.display = plBgMode.value === 'custom' ? 'block' : 'none';
  });
  
  // Initial state
  if (plBgMode.value === 'custom') {
    plImageUpload.style.display = 'block';
  }
}
</script>

{% endblock %}
