{% extends "base.html" %}
{% block title %}Admin{% endblock %}
{% block content %}
<h1>Adminbereich</h1>

<style>
  .muted { color: #94a3b8; font-size: 0.95rem; }
  .event-card { background: #0b1222; border: 1px solid rgba(255,255,255,0.05); }
  .hint { font-size:0.9rem; color:#cbd5e1; margin-top:0.2rem; }
  .stack { display:flex; flex-direction:column; gap:0.35rem; }
  .field-inline { display:flex; gap:0.6rem; flex-wrap:wrap; align-items:center; }
  .collapsible { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .collapsible__header { display:flex; justify-content:space-between; align-items:center; gap:0.8rem; padding: 0.75rem 1rem; background: rgba(255,255,255,0.04); }
  .collapsible__content { padding: 1rem; border-top: 1px solid var(--border); background: rgba(255,255,255,0.02); }
  .collapsible [data-toggle] { min-width: 130px; }
  .inline-actions { display:flex; gap:0.4rem; flex-wrap:wrap; align-items:center; }
  .product-editor {
    margin-top: 0.6rem;
    border: 1px dashed var(--border);
    border-radius: 10px;
    padding: 0.9rem;
    background: rgba(255,255,255,0.02);
  }
  .product-editor__top { display:flex; align-items:center; justify-content:space-between; gap:0.6rem; flex-wrap:wrap; }
  .product-editor__preview {
    margin-top: 0.8rem;
    display: grid;
    gap: 0.6rem;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }
  .product-preview-card {
    border-radius: 12px;
    padding: 0.85rem;
    color: #e2e8f0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.08);
    cursor: grab;
    transition: transform 0.15s ease, box-shadow 0.2s ease;
  }
  .product-preview-card small { opacity: 0.75; display:block; margin-bottom:0.35rem; }
  .product-preview-card.dragging { opacity: 0.6; transform: scale(0.98); }
  .product-preview-card.drag-over { outline: 2px dashed rgba(255,255,255,0.5); }
  .product-editor__list { margin-top: 1rem; display:flex; flex-direction:column; gap:0.75rem; }
  .product-row {
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap:0.6rem;
    background:#0c1324;
    border:1px solid var(--border);
    border-radius:10px;
    padding:0.75rem;
  }
  .product-row label { font-size: 0.9rem; color: #cbd5e1; display:block; margin-bottom:0.2rem; }
  .product-row .row-actions { display:flex; justify-content:flex-end; align-items:flex-end; }
  .product-row .row-actions button { width:100%; }
  .color-input { width:100%; min-height:44px; padding: 0; }
  .pill { padding: 0.3rem 0.7rem; border-radius: 999px; background: rgba(255,255,255,0.06); border: 1px solid var(--border); font-size: 0.9rem; }
  .shot-settings { margin: 0.8rem 0; }
  .shot-settings__grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:0.6rem; margin-top: 0.4rem; }
  .shot-settings__grid span { font-size: 0.9rem; color: #cbd5e1; }
  .shot-settings__numbers { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:0.6rem; margin-top: 0.6rem; }
</style>

<div class="collapsible card" data-collapsible>
  <div class="collapsible__header">
    <div>
      <h2 style="margin:0;">Neues Event</h2>
      <div class="muted">Optional Vorlage kopieren oder später Details bearbeiten.</div>
    </div>
    <button type="button" class="secondary" data-toggle>Details einblenden</button>
  </div>
  <div class="collapsible__content" hidden>
    <form method="post" action="{{ url_for('create_event') }}" data-event-form data-scope="new">
      <div class="stack">
        <label for="name">Name</label>
        <input id="name" name="name" placeholder="z.B. Sommerfest" required>
      </div>
      <div class="field-inline" style="margin: 0.6rem 0;">
        <label><input type="checkbox" name="kassensystem_enabled" checked> Kassensystem aktiv</label>
        <label><input type="checkbox" name="shotcounter_enabled" checked> Shotcounter aktiv</label>
      </div>
      {% if events %}
      <div class="stack" style="margin: 0.6rem 0;">
        <label>Vorlage kopieren</label>
        <div class="field-inline">
          <select data-copy-select>
            <option value="">Bitte wählen</option>
            {% for template in events %}
              <option value="{{ template.id }}">{{ template.name }}</option>
            {% endfor %}
          </select>
          <button type="button" class="secondary" data-copy-btn>Übernehmen</button>
        </div>
        <div class="muted">Übernimmt Einstellungen, Shotcounter-Optionen und Kassenartikel der gewählten Vorlage.</div>
      </div>
      {% endif %}

      <input type="hidden" name="shared_settings" value='{}'>

      <div
        class="shot-settings"
        data-shot-settings
        data-defaults='{{ shotcounter_defaults | tojson }}'
        data-current='{{ shotcounter_defaults | tojson }}'
      >
        <strong>Shotcounter Styling</strong>
        <div class="muted">Farben, Schriftgrößen und Anzahl Teams im Vollbild.</div>
        <div class="shot-settings__grid">
          <label class="stack">
            <span>Hintergrund</span>
            <input type="color" class="color-input" data-shot-field="background_color">
          </label>
          <label class="stack">
            <span>Primärfarbe (Karten)</span>
            <input type="color" class="color-input" data-shot-field="primary_color">
          </label>
          <label class="stack">
            <span>Sekundärfarbe (Verlauf)</span>
            <input type="color" class="color-input" data-shot-field="secondary_color">
          </label>
          <label class="stack">
            <span>Terziärfarbe (Verlauf)</span>
            <input type="color" class="color-input" data-shot-field="tertiary_color">
          </label>
        </div>
        <div class="shot-settings__numbers">
          <label class="stack">
            <span>Schriftgröße Titel (rem)</span>
            <input type="number" step="0.1" min="0.5" max="10" data-shot-field="title_size">
          </label>
          <label class="stack">
            <span>Schriftgröße Teams (rem)</span>
            <input type="number" step="0.1" min="0.5" max="10" data-shot-field="team_size">
          </label>
          <label class="stack">
            <span>Teams im Leaderboard</span>
            <input type="number" step="1" min="1" max="50" data-shot-field="leaderboard_limit">
          </label>
        </div>
        <input type="hidden" name="shotcounter_settings" value='{{ shotcounter_defaults | tojson }}'>
      </div>

      <input type="hidden" name="kassensystem_settings" value='{{ {"items": default_buttons} | tojson }}'>
      <p class="hint">Kassenartikel lassen sich nach dem Speichern oder per Vorlage übernehmen.</p>
      <div class="field-inline">
        <label class="secondary" style="padding:0.45rem 0.65rem; cursor:pointer;">
          Event-JSON importieren
          <input type="file" accept="application/json" data-import-event hidden>
        </label>
        <button type="button" class="secondary" data-export-event>Event-JSON exportieren</button>
      </div>
      <button type="submit">Event anlegen</button>
    </form>
  </div>
</div>

<!-- Credentials Management Section -->
<div class="collapsible card" data-collapsible>
  <div class="collapsible__header">
    <div>
      <h2 style="margin:0;">Admin-Zugangsdaten</h2>
      <div class="muted">Benutzername und Passwort für den Admin-Bereich verwalten.</div>
    </div>
    <button type="button" class="secondary" data-toggle>Details einblenden</button>
  </div>
  <div class="collapsible__content" hidden>
    <form method="post" action="{{ url_for('update_credentials') }}">
      <div class="stack">
        <label for="admin_username">Benutzername</label>
        <input 
          id="admin_username" 
          name="admin_username" 
          type="text"
          value="{% if admin_username %}{{ admin_username }}{% endif %}" 
          placeholder="admin" 
          required
        >
        <div class="hint">Der Benutzername für die Admin-Authentifizierung.</div>
      </div>
      
      <div class="stack" style="margin-top: 1rem;">
        <label for="admin_password">Passwort</label>
        <input 
          id="admin_password" 
          name="admin_password" 
          type="password"
          placeholder="Neues Passwort eingeben"
        >
        <div class="hint">
          {% if has_password %}
            Leer lassen, um das aktuelle Passwort beizubehalten.
          {% else %}
            Setzen Sie ein Passwort, um den Admin-Bereich zu schützen.
          {% endif %}
        </div>
      </div>

      <div class="field-inline" style="margin-top: 1rem;">
        <button type="submit">Zugangsdaten speichern</button>
      </div>
      
      <div class="muted" style="margin-top: 1rem;">
        <strong>Hinweis:</strong> Die Zugangsdaten werden in der Datei <code>credentials.json</code> gespeichert, 
        die nicht ins Git-Repository übernommen wird. {% if not has_password %}
        Solange kein Passwort gesetzt ist, ist der Admin-Bereich ohne Authentifizierung zugänglich.
        {% endif %}
      </div>
    </form>
  </div>
</div>

<div class="card">
  <h2>Events</h2>
  {% if not events %}
    <p>Es wurden noch keine Events angelegt.</p>
  {% endif %}
  {% for event in events %}
    <div class="event-card collapsible" data-collapsible data-event-card="{{ event.id }}">
      <div class="collapsible__header">
        <div>
          <strong>{{ event.name }}</strong>
          {% if event.is_active %}<span class="badge badge-green">aktiv</span>{% endif %}
          {% if event.is_archived %}<span class="badge badge-red">archiviert</span>{% endif %}
          <div class="muted">Letzte Änderung: {{ event.updated_at.strftime("%d.%m.%Y %H:%M") if event.updated_at else "–" }}</div>
        </div>
        <div class="inline-actions">
          <form class="inline" method="post" action="{{ url_for('activate_event', event_id=event.id) }}">
            <button type="submit" class="secondary">Aktivieren</button>
          </form>
          <form class="inline" method="post" action="{{ url_for('archive_event', event_id=event.id) }}">
            <button type="submit" class="danger">Archivieren</button>
          </form>
          <button type="button" class="secondary" data-toggle>Details</button>
        </div>
      </div>
      <div class="collapsible__content" hidden>
        <form method="post" action="{{ url_for('update_event', event_id=event.id) }}" data-event-form data-scope="{{ event.id }}">
          <div class="field-inline" style="margin: 0.4rem 0;">
            <label><input type="checkbox" name="kassensystem_enabled" {% if event.kassensystem_enabled %}checked{% endif %}> Kassensystem aktiv</label>
            <label><input type="checkbox" name="shotcounter_enabled" {% if event.shotcounter_enabled %}checked{% endif %}> Shotcounter aktiv</label>
          </div>

          {% if events|length > 1 %}
          <div class="stack" style="margin:0.6rem 0;">
            <label>Einstellungen aus Event kopieren</label>
            <div class="field-inline">
              <select data-copy-select>
                <option value="">Bitte wählen</option>
                {% for template in events if template.id != event.id %}
                  <option value="{{ template.id }}">{{ template.name }}</option>
                {% endfor %}
              </select>
              <button type="button" class="secondary" data-copy-btn>Übernehmen</button>
              <span class="pill">kopiert auch Produkte</span>
            </div>
          </div>
          {% endif %}

          <input type="hidden" name="shared_settings" value='{{ (event.shared_settings or {}) | tojson }}'>

          <div
            class="shot-settings"
            data-shot-settings
            data-defaults='{{ shotcounter_defaults | tojson }}'
            data-current='{{ (shot_settings_map.get(event.id) or shotcounter_defaults) | tojson }}'
          >
            <strong>Shotcounter Styling</strong>
            <div class="muted">Steuert Vollbild/Touch: Farben, Schriftgrößen und Teamanzahl.</div>
            <div class="shot-settings__grid">
              <label class="stack">
                <span>Hintergrund</span>
                <input type="color" class="color-input" data-shot-field="background_color">
              </label>
              <label class="stack">
                <span>Primärfarbe (Karten)</span>
                <input type="color" class="color-input" data-shot-field="primary_color">
              </label>
              <label class="stack">
                <span>Sekundärfarbe (Verlauf)</span>
                <input type="color" class="color-input" data-shot-field="secondary_color">
              </label>
              <label class="stack">
                <span>Terziärfarbe (Verlauf)</span>
                <input type="color" class="color-input" data-shot-field="tertiary_color">
              </label>
            </div>
            <div class="shot-settings__numbers">
              <label class="stack">
                <span>Schriftgröße Titel (rem)</span>
                <input type="number" step="0.1" min="0.5" max="10" data-shot-field="title_size">
              </label>
              <label class="stack">
                <span>Schriftgröße Teams (rem)</span>
                <input type="number" step="0.1" min="0.5" max="10" data-shot-field="team_size">
              </label>
              <label class="stack">
                <span>Teams im Leaderboard</span>
                <input type="number" step="1" min="1" max="50" data-shot-field="leaderboard_limit">
              </label>
            </div>
            <input type="hidden" name="shotcounter_settings" value='{{ (shot_settings_map.get(event.id) or shotcounter_defaults) | tojson }}'>
          </div>

          <div class="product-editor" data-product-editor data-items='{{ event_buttons.get(event.id, default_buttons) | tojson }}'>
            <div class="product-editor__top">
              <div>
                <strong>Produkte für dieses Event</strong>
                <div class="muted">Titel, Preis, Farbe bearbeiten. Reihenfolge per Drag & Drop ändern.</div>
              </div>
              <div class="inline-actions">
                <label class="secondary" style="padding:0.45rem 0.65rem; cursor:pointer;">
                  JSON importieren
                  <input type="file" accept="application/json" data-product-import hidden>
                </label>
                <button type="button" class="secondary" data-product-export>Daten exportieren</button>
                <button type="button" class="secondary" data-add-product>+ Produkt</button>
              </div>
            </div>
            <div class="product-editor__preview" data-product-preview></div>
            <div class="product-editor__list" data-product-list></div>
            <input type="hidden" name="kassensystem_settings" value='{{ kass_settings.get(event.id, {"items": event_buttons.get(event.id, default_buttons)}) | tojson }}'>
          </div>

          <div class="field-inline" style="margin-top:0.8rem;">
            <label class="secondary" style="padding:0.45rem 0.65rem; cursor:pointer;">
              Event-JSON importieren
              <input type="file" accept="application/json" data-import-event hidden>
            </label>
            <button type="button" class="secondary" data-export-event>Event-JSON exportieren</button>
            <span class="muted">Import ersetzt die Felder oben, JSON bleibt optional.</span>
          </div>
          <button type="submit">Speichern</button>
        </form>
      </div>
    </div>
  {% endfor %}
</div>

<script id="event-settings-data" type="application/json">
  {{ event_payloads | tojson }}
</script>
<script id="default-buttons-data" type="application/json">
  {{ default_buttons | tojson }}
</script>
<script id="shotcounter-defaults-data" type="application/json">
  {{ shotcounter_defaults | tojson }}
</script>

<script>
  (function () {
    try {
    const fallbackColor = "#1f2a44";
    const defaultCategory = "Standard";

    const getTextContent = (id) => {
      const el = document.getElementById(id);
      return el ? el.textContent : "";
    };

    const parseJson = (value, fallback) => {
      if (!value) return fallback;
      try { return JSON.parse(value); } catch (err) { return fallback; }
    };

    const eventData = parseJson(getTextContent("event-settings-data"), {});
    const defaultButtons = parseJson(getTextContent("default-buttons-data"), []);
    const shotDefaults = parseJson(
      getTextContent("shotcounter-defaults-data"),
      {
        background_color: "#0b1222",
        primary_color: "#1e293b",
        secondary_color: "#38bdf8",
        tertiary_color: "#34d399",
        title_size: 3.2,
        team_size: 1.6,
        leaderboard_limit: 10,
      }
    );

    document.querySelectorAll("[data-collapsible]").forEach((wrap) => {
      const content = wrap.querySelector(".collapsible__content");
      const toggle = wrap.querySelector("[data-toggle]");
      if (!content || !toggle) return;
      const startOpen = wrap.dataset.startOpen === "true";
      if (startOpen) content.hidden = false;
      const syncLabel = () => { toggle.textContent = content.hidden ? "Details einblenden" : "Details ausblenden"; };
      syncLabel();
      toggle.addEventListener("click", () => { content.hidden = !content.hidden; syncLabel(); });
    });

    const sanitizeColor = (value) => {
      if (typeof value !== "string") return fallbackColor;
      const hex = value.trim();
      return /^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})$/.test(hex) ? hex : fallbackColor;
    };

    const clampNumber = (value, fallback, min, max) => {
      const parsed = Number(value);
      if (!Number.isFinite(parsed)) return fallback;
      return Math.min(max, Math.max(min, parsed));
    };

    const normalizeItem = (item, index) => {
      const safeItem = item || {};
      const label = (safeItem.label || safeItem.name || "").trim() || "Produkt " + (index + 1);
      const name = (safeItem.name || label || "produkt-" + (index + 1)).trim();
      const price = Number.isFinite(Number(safeItem.price)) ? Number(safeItem.price) : 0;
      return {
        name,
        label,
        price,
        css_class: safeItem.css_class || "custom",
        color: sanitizeColor(safeItem.color || ""),
        category: safeItem.category || defaultCategory,
      };
    };

    // Shotcounter-Settings
    document.querySelectorAll("[data-shot-settings]").forEach((wrapper) => {
      const hidden = wrapper.querySelector('input[name="shotcounter_settings"]');
      const defaults = { ...shotDefaults, ...parseJson(wrapper.dataset.defaults, shotDefaults) };
      const current = parseJson(wrapper.dataset.current, {});
      let settings = { ...defaults, ...current };

      const syncInputs = () => {
        wrapper.querySelectorAll("[data-shot-field]").forEach((input) => {
          const key = input.dataset.shotField;
          if (!key) return;
          if (input.type === "color") {
            input.value = sanitizeColor(settings[key] || defaults[key] || fallbackColor);
          } else if (input.type === "number") {
            input.value = settings[key] ?? defaults[key] ?? "";
          }
        });
      };

      const syncHidden = () => {
        if (hidden) hidden.value = JSON.stringify(settings);
      };

      wrapper.querySelectorAll("[data-shot-field]").forEach((input) => {
        const key = input.dataset.shotField;
        if (!key) return;
        input.addEventListener("input", () => {
          if (input.type === "color") {
            settings[key] = sanitizeColor(input.value || defaults[key] || fallbackColor);
          } else {
            const min = key === "leaderboard_limit" ? 1 : 0.5;
            const max = key === "leaderboard_limit" ? 50 : 10;
            settings[key] = clampNumber(input.value, defaults[key], min, max);
          }
          syncHidden();
        });
      });

      wrapper.shotSettingsApi = {
        getSettings: () => ({ ...settings }),
        setSettings: (data) => {
          settings = { ...defaults, ...(data || {}) };
          syncInputs();
          syncHidden();
        },
      };

      syncInputs();
      syncHidden();
    });

    // Produkt-Editor
    document.querySelectorAll("[data-product-editor]").forEach((wrapper) => {
      const addButton = wrapper.querySelector("[data-add-product]");
      const preview = wrapper.querySelector("[data-product-preview]");
      const list = wrapper.querySelector("[data-product-list]");
      const hidden = wrapper.querySelector('input[name="kassensystem_settings"]');
      const importInput = wrapper.querySelector("[data-product-import]");
      const exportButton = wrapper.querySelector("[data-product-export]");

      let baseSettings = {};
      try { baseSettings = JSON.parse(hidden.value || "{}"); } catch (err) { baseSettings = {}; }

      let parsedItems = [];
      try { parsedItems = JSON.parse(wrapper.dataset.items || "[]"); } catch (err) { parsedItems = []; }

      let items = Array.isArray(parsedItems) ? parsedItems.map(normalizeItem) : [];
      if (!items.length) {
        items = [normalizeItem({ name: "Produkt", label: "Neues Produkt", price: 0, color: fallbackColor }, 0)];
      }

      const syncHidden = () => {
        hidden.value = JSON.stringify({ ...baseSettings, items });
      };

      const renderPreview = () => {
        preview.innerHTML = "";
        let dragIndex = null;

        items.forEach((item, index) => {
          const card = document.createElement("div");
          card.className = "product-preview-card";
          card.draggable = true;
          card.style.background = sanitizeColor(item.color);
          card.dataset.index = index;
          card.innerHTML = `<small>${item.price} CHF</small><div style="font-weight:700;">${item.label}</div>`;

          card.addEventListener("dragstart", () => {
            dragIndex = index;
            card.classList.add("dragging");
          });
          card.addEventListener("dragend", () => card.classList.remove("dragging"));
          card.addEventListener("dragover", (ev) => {
            ev.preventDefault();
            card.classList.add("drag-over");
          });
          card.addEventListener("dragleave", () => card.classList.remove("drag-over"));
          card.addEventListener("drop", (ev) => {
            ev.preventDefault();
            card.classList.remove("drag-over");
            const targetIndex = Number(card.dataset.index);
            if (Number.isNaN(targetIndex) || dragIndex === null || dragIndex === targetIndex) {
              return;
            }
            const [moved] = items.splice(dragIndex, 1);
            items.splice(targetIndex, 0, moved);
            renderList();
            renderPreview();
            syncHidden();
          });

          preview.appendChild(card);
        });
      };

      const renderList = () => {
        list.innerHTML = "";

        items.forEach((item, index) => {
          const row = document.createElement("div");
          row.className = "product-row";

          const nameContainer = document.createElement("div");
          nameContainer.className = "stack";
          const nameLabel = document.createElement("label");
          nameLabel.textContent = "Schlüssel (interner Name)";
          const nameInput = document.createElement("input");
          nameInput.value = item.name;
          nameInput.placeholder = "unique-key";
          nameInput.addEventListener("input", () => {
            item.name = nameInput.value.trim();
            syncHidden();
          });
          nameContainer.append(nameLabel, nameInput);

          const labelContainer = document.createElement("div");
          labelContainer.className = "stack";
          const labelLabel = document.createElement("label");
          labelLabel.textContent = "Titel (Anzeige)";
          const labelInput = document.createElement("input");
          labelInput.value = item.label;
          labelInput.placeholder = "z.B. Bier";
          labelInput.addEventListener("input", () => {
            item.label = labelInput.value;
            if (!item.name.trim()) {
              item.name = labelInput.value;
              nameInput.value = item.name;
            }
            renderPreview();
            syncHidden();
          });
          labelContainer.append(labelLabel, labelInput);

          const priceContainer = document.createElement("div");
          priceContainer.className = "stack";
          const priceLabel = document.createElement("label");
          priceLabel.textContent = "Preis (CHF)";
          const priceInput = document.createElement("input");
          priceInput.type = "number";
          priceInput.step = "1";
          priceInput.value = item.price;
          priceInput.addEventListener("input", () => {
            const parsed = Number(priceInput.value);
            item.price = Number.isFinite(parsed) ? parsed : 0;
            renderPreview();
            syncHidden();
          });
          priceContainer.append(priceLabel, priceInput);

          const colorContainer = document.createElement("div");
          colorContainer.className = "stack";
          const colorLabel = document.createElement("label");
          colorLabel.textContent = "Hintergrundfarbe";
          const colorInput = document.createElement("input");
          colorInput.type = "color";
          colorInput.className = "color-input";
          colorInput.value = sanitizeColor(item.color);
          colorInput.addEventListener("input", () => {
            item.color = sanitizeColor(colorInput.value);
            renderPreview();
            syncHidden();
          });
          colorContainer.append(colorLabel, colorInput);

          const categoryContainer = document.createElement("div");
          categoryContainer.className = "stack";
          const categoryLabel = document.createElement("label");
          categoryLabel.textContent = "Kategorie";
          const categoryInput = document.createElement("input");
          categoryInput.value = item.category || defaultCategory;
          categoryInput.placeholder = "z.B. Getränke, Alkohol";
          categoryInput.addEventListener("input", () => {
            item.category = categoryInput.value.trim() || defaultCategory;
            syncHidden();
          });
          categoryContainer.append(categoryLabel, categoryInput);

          const actions = document.createElement("div");
          actions.className = "row-actions";
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "danger";
          removeBtn.textContent = "Entfernen";
          removeBtn.addEventListener("click", () => {
            items.splice(index, 1);
            if (!items.length) {
              items.push(normalizeItem({ name: "produkt", label: "Produkt", price: 0, color: fallbackColor }, 0));
            }
            renderList();
            renderPreview();
            syncHidden();
          });
          actions.appendChild(removeBtn);

          row.append(labelContainer, nameContainer, priceContainer, colorContainer, categoryContainer, actions);
          list.appendChild(row);
        });
      };

      if (addButton) {
        addButton.addEventListener("click", () => {
          items.push(
            normalizeItem(
              {
                name: "produkt-" + Date.now(),
                label: "Neues Produkt",
                price: 0,
                color: fallbackColor,
              },
              items.length
            )
          );
          renderList();
          renderPreview();
          syncHidden();
        });
      }

      if (importInput) {
        importInput.addEventListener("change", (ev) => {
          const file = ev.target.files && ev.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            const data = parseJson(reader.result, {});
            const importedItems = Array.isArray(data && data.items) ? data.items : Array.isArray(data) ? data : [];
            baseSettings = data && typeof data === "object" && !Array.isArray(data) ? { ...data } : {};
            items = (importedItems || []).map((it, idx) => normalizeItem(it, idx));
            if (!items.length) items = [normalizeItem({ name: "Produkt", label: "Neues Produkt", price: 0, color: fallbackColor }, 0)];
            renderList();
            renderPreview();
            syncHidden();
          };
          reader.readAsText(file);
        });
      }

      if (exportButton) {
        exportButton.addEventListener("click", () => {
          const blob = new Blob([hidden.value || "{}"], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "produkte.json";
          a.click();
          URL.revokeObjectURL(url);
        });
      }

      wrapper.productApi = {
        getSettings: () => parseJson(hidden.value, { items: items }),
        setSettings: (data) => {
          const importedItems = Array.isArray(data && data.items) ? data.items : [];
          baseSettings = data && typeof data === "object" && !Array.isArray(data) ? { ...data } : {};
          items = importedItems.length ? importedItems.map((it, idx) => normalizeItem(it, idx)) : [normalizeItem({ name: "Produkt", label: "Produkt", price: 0, color: fallbackColor }, 0)];
          renderList();
          renderPreview();
          syncHidden();
        },
      };

      renderList();
      renderPreview();
      syncHidden();
    });

    const collectSnapshot = (form) => {
      const sharedInput = form.querySelector('input[name="shared_settings"]');
      const shotInput = form.querySelector('input[name="shotcounter_settings"]');
      const productEditor = form.querySelector("[data-product-editor]");
      const shotSettingsWrapper = form.querySelector("[data-shot-settings]");
      return {
        kassensystem_enabled: Boolean((form.querySelector('[name="kassensystem_enabled"]') || {}).checked),
        shotcounter_enabled: Boolean((form.querySelector('[name="shotcounter_enabled"]') || {}).checked),
        shared_settings: parseJson(sharedInput ? sharedInput.value : "", {}),
        shotcounter_settings:
          (shotSettingsWrapper && shotSettingsWrapper.shotSettingsApi && shotSettingsWrapper.shotSettingsApi.getSettings()) ||
          parseJson(shotInput ? shotInput.value : "", {}),
        kassensystem_settings:
          (productEditor && productEditor.productApi && productEditor.productApi.getSettings()) ||
          parseJson((form.querySelector('input[name="kassensystem_settings"]') || {}).value, {}),
      };
    };

    const applySnapshot = (form, snapshot) => {
      const kassCheck = form.querySelector('[name="kassensystem_enabled"]');
      const shotCheck = form.querySelector('[name="shotcounter_enabled"]');
      if (kassCheck) kassCheck.checked = Boolean(snapshot.kassensystem_enabled);
      if (shotCheck) shotCheck.checked = Boolean(snapshot.shotcounter_enabled);

      const sharedHidden = form.querySelector('input[name="shared_settings"]');
      const shotHidden = form.querySelector('input[name="shotcounter_settings"]');
      if (sharedHidden) sharedHidden.value = JSON.stringify(snapshot.shared_settings || {});
      if (shotHidden) shotHidden.value = JSON.stringify(snapshot.shotcounter_settings || {});

      const productEditor = form.querySelector("[data-product-editor]");
      const kassInput = form.querySelector('input[name="kassensystem_settings"]');
      const shotSettingsWrapper = form.querySelector("[data-shot-settings]");
      if (shotSettingsWrapper && shotSettingsWrapper.shotSettingsApi) {
        shotSettingsWrapper.shotSettingsApi.setSettings(snapshot.shotcounter_settings || {});
      }
      if (productEditor && productEditor.productApi) {
        productEditor.productApi.setSettings(snapshot.kassensystem_settings || { items: defaultButtons });
      } else if (kassInput) {
        kassInput.value = JSON.stringify(snapshot.kassensystem_settings || { items: defaultButtons });
      }
    };

    const bindCopyAndImport = (form) => {
      const select = form.querySelector("[data-copy-select]");
      const copyBtn = form.querySelector("[data-copy-btn]");
      const importTrigger = form.querySelector("[data-import-event]");
      const exportBtn = form.querySelector("[data-export-event]");

      if (copyBtn) {
        copyBtn.addEventListener("click", () => {
          const selectedId = select ? select.value : null;
          if (!selectedId || !eventData[selectedId]) return;
          applySnapshot(form, eventData[selectedId]);
        });
      }

      if (exportBtn) {
        exportBtn.addEventListener("click", () => {
          const data = collectSnapshot(form);
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "event-settings.json";
          a.click();
          URL.revokeObjectURL(url);
        });
      }

      if (importTrigger) {
        importTrigger.addEventListener("change", (ev) => {
          const file = ev.target.files && ev.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            const data = parseJson(reader.result, null);
            if (!data) return;
            applySnapshot(form, {
              kassensystem_enabled: data.kassensystem_enabled !== undefined ? data.kassensystem_enabled : true,
              shotcounter_enabled: data.shotcounter_enabled !== undefined ? data.shotcounter_enabled : true,
              shared_settings: data.shared_settings || {},
              shotcounter_settings: data.shotcounter_settings || {},
              kassensystem_settings: data.kassensystem_settings || { items: defaultButtons },
            });
          };
          reader.readAsText(file);
        });
      }
    };

    document.querySelectorAll("[data-event-form]").forEach((form) => {
      bindCopyAndImport(form);
    });
    } catch (err) {
      console.error("Admin UI Init Error", err);
      document.querySelectorAll(".collapsible__content").forEach((content) => {
        content.hidden = false;
      });
    }
  })();
</script>

{% endblock %}
