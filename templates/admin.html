{% extends "base.html" %}
{% block title %}Admin{% endblock %}
{% block content %}
<h1>Adminbereich</h1>
<div class="field-inline" style="margin-bottom: 1rem;">
  <a class="button-link" href="{{ url_for('admin_images') }}">Bilderverwaltung</a>
</div>

<style>
  .muted { color: #94a3b8; font-size: 0.95rem; }
  .event-card { background: #0b1222; border: 1px solid rgba(255,255,255,0.05); }
  .hint { font-size:0.9rem; color:#cbd5e1; margin-top:0.2rem; }
  .stack { display:flex; flex-direction:column; gap:0.35rem; }
  .field-inline { display:flex; gap:0.6rem; flex-wrap:wrap; align-items:center; }
  .collapsible { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .collapsible__header { display:flex; justify-content:space-between; align-items:center; gap:0.8rem; padding: 0.75rem 1rem; background: rgba(255,255,255,0.04); }
  .collapsible__content { padding: 1rem; border-top: 1px solid var(--border); background: rgba(255,255,255,0.02); }
  .collapsible [data-toggle] { min-width: 130px; }
  .inline-actions { display:flex; gap:0.4rem; flex-wrap:wrap; align-items:center; }
  .button-link { display:inline-block; background: #334155; color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem 0.75rem; font-weight: 700; }
  .product-editor {
    margin-top: 0.6rem;
    border: 1px dashed var(--border);
    border-radius: 10px;
    padding: 0.9rem;
    background: rgba(255,255,255,0.02);
  }
  .product-editor__top { display:flex; align-items:center; justify-content:space-between; gap:0.6rem; flex-wrap:wrap; }
  .product-editor__preview {
    margin-top: 0.8rem;
    display: grid;
    gap: 0.6rem;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }
  .product-preview-card {
    border-radius: 12px;
    padding: 0.85rem;
    color: #e2e8f0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.08);
    cursor: grab;
    transition: transform 0.15s ease, box-shadow 0.2s ease;
  }
  .product-preview-card small { opacity: 0.75; display:block; margin-bottom:0.35rem; }
  .product-preview-card.dragging { opacity: 0.6; transform: scale(0.98); }
  .product-preview-card.drag-over { outline: 2px dashed rgba(255,255,255,0.5); }
  .product-editor__list { margin-top: 1rem; display:flex; flex-direction:column; gap:0.75rem; }
  .product-category { margin-top: 0.8rem; }
  .product-category__header { display:flex; justify-content:space-between; align-items:center; gap:0.6rem; margin:0.2rem 0 0.4rem; }
  .product-category__list { display:flex; flex-direction:column; gap:0.75rem; }
  .product-row {
    display:grid;
    grid-template-columns:
      minmax(200px, 1.3fr)
      minmax(200px, 1.1fr)
      minmax(170px, 0.8fr)
      minmax(180px, 0.9fr)
      minmax(180px, 0.7fr);
    gap:0.6rem;
    background:#0c1324;
    border:1px solid var(--border);
    border-radius:10px;
    padding:0.75rem;
    align-items:end;
    cursor: grab;
  }
  .product-row.is-dragging { opacity: 0.6; cursor: grabbing; }
  .product-field-group {
    display:grid;
    grid-template-columns: minmax(110px, 1fr) minmax(90px, 1fr);
    gap:0.6rem;
    align-items:end;
  }
  .product-field-group--actions {
    grid-template-columns: minmax(120px, 1fr) minmax(110px, 1fr);
  }
  .product-field-group input[type="number"] {
    max-width: 140px;
  }
  .product-field-group .row-actions button {
    padding: 0.45rem 0.6rem;
  }
  .product-row label { font-size: 0.9rem; color: #cbd5e1; display:block; margin-bottom:0.2rem; }
  .product-row .row-actions { display:flex; justify-content:flex-end; align-items:flex-end; }
  .product-row .row-actions button { width:100%; }
  .visibility-toggle { display:flex; gap:0.4rem; flex-wrap:wrap; }
  .visibility-toggle .pill-toggle {
    display:inline-flex;
    align-items:center;
    gap:0.35rem;
    padding:0.35rem 0.6rem;
    border-radius:999px;
    border:1px solid var(--border);
    background: rgba(255,255,255,0.04);
    cursor:pointer;
    font-size:0.9rem;
  }
  .visibility-toggle .pill-toggle input { margin:0; }
  .color-input { width:100%; min-height:44px; padding: 0; }
  .pill { padding: 0.3rem 0.7rem; border-radius: 999px; background: rgba(255,255,255,0.06); border: 1px solid var(--border); font-size: 0.9rem; }
  .shot-settings { margin: 0.8rem 0; }
  .shot-settings__grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:0.6rem; margin-top: 0.4rem; }
  .shot-settings__grid span { font-size: 0.9rem; color: #cbd5e1; }
  .shot-settings__numbers { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:0.6rem; margin-top: 0.6rem; }
  .badge-yellow { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245,158,11,0.5); }
  
  /* Modal/Popup Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.7);
    animation: fadeIn 0.2s ease;
  }
  .modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .modal-content {
    background: #0b1222;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 2rem;
    max-width: 900px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: slideIn 0.3s ease;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }
  .modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
  }
  .modal-close {
    background: transparent;
    border: none;
    font-size: 2rem;
    color: #94a3b8;
    cursor: pointer;
    padding: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: background 0.2s ease, color 0.2s ease;
  }
  .modal-close:hover {
    background: rgba(255,255,255,0.1);
    color: #fff;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes slideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  /* Status toggle button */
  .status-toggle {
    min-width: 130px;
  }
  .status-toggle.active {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border-color: rgba(34, 197, 94, 0.5);
  }
  .status-toggle.inactive {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.5);
  }
  .status-toggle.archived {
    background: rgba(100, 116, 139, 0.2);
    color: #94a3b8;
    border-color: rgba(100, 116, 139, 0.5);
  }
  
  /* Prevent body scroll when modal is open */
  body.modal-open {
    overflow: hidden;
  }
</style>

<!-- Events Section (moved to top) -->
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2 style="margin: 0;">Events</h2>
    <button type="button" class="primary" id="new-event-btn">+ Neues Event</button>
  </div>
  {% if not events %}
    <p>Es wurden noch keine Events angelegt.</p>
  {% endif %}
  {% for event in events %}
    <div class="event-card" style="margin-bottom: 1rem;" data-event-card="{{ event.id }}">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem;">
        <div>
          <strong>{{ event.name }}</strong>
          {% if event.is_active %}<span class="badge badge-green">aktiv</span>{% endif %}
          {% if event.is_archived %}<span class="badge badge-red">archiviert</span>{% endif %}
          <div class="muted">Letzte Änderung: {{ event.updated_at.strftime("%d.%m.%Y %H:%M") if event.updated_at else "–" }}</div>
        </div>
        <div class="inline-actions">
          <form class="inline" method="post" action="{{ url_for('activate_event', event_id=event.id) if (event.is_archived or not event.is_active) else url_for('archive_event', event_id=event.id) }}">
            <button type="submit" class="status-toggle {% if event.is_active %}active{% elif event.is_archived %}archived{% else %}inactive{% endif %}">
              {% if event.is_archived %}
                Archiviert - Aktivieren
              {% elif event.is_active %}
                Aktiv - Archivieren
              {% else %}
                Inaktiv - Aktivieren
              {% endif %}
            </button>
          </form>
          <a class="button-link" href="{{ url_for('admin_event_settings', event_id=event.id) }}">Einstellungen</a>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<!-- Modal for New Event -->
<div id="new-event-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Neues Event anlegen</h2>
      <button type="button" class="modal-close" data-close-modal="new-event-modal">&times;</button>
    </div>
    <form method="post" action="{{ url_for('create_event') }}" data-event-form data-scope="new">
      <div class="stack">
        <label for="name">Name</label>
        <input id="name" name="name" placeholder="z.B. Sommerfest" required>
      </div>
      <div class="field-inline" style="margin: 0.6rem 0;">
        <label><input type="checkbox" name="kassensystem_enabled" checked> Kassensystem aktiv</label>
        <label><input type="checkbox" name="shotcounter_enabled" checked> Shotcounter aktiv</label>
      </div>
      <div class="field-inline" style="margin: 0.6rem 0;">
        <label><input type="checkbox" name="auto_reload_on_add" checked data-shared-setting> Auto-Reload beim Hinzufügen (Kasse)</label>
      </div>
      <div class="muted" style="margin-bottom: 0.6rem;">Wenn deaktiviert, wird die Kasse nicht neu geladen beim Hinzufügen von Artikeln (performanter).</div>
      {% if events %}
      <div class="stack" style="margin: 0.6rem 0;">
        <label>Vorlage kopieren</label>
        <div class="field-inline">
          <select data-copy-select>
            <option value="">Bitte wählen</option>
            {% for template in events %}
              <option value="{{ template.id }}">{{ template.name }}</option>
            {% endfor %}
          </select>
          <button type="button" class="secondary" data-copy-btn>Übernehmen</button>
        </div>
        <div class="muted">Übernimmt Einstellungen, Shotcounter-Optionen und Kassenartikel der gewählten Vorlage.</div>
      </div>
      {% endif %}

      <input type="hidden" name="shared_settings" value='{{ {"price_list": price_list_defaults} | tojson }}'>

      <div
        class="shot-settings"
        data-shot-settings
        data-defaults='{{ shotcounter_defaults | tojson }}'
        data-current='{{ shotcounter_defaults | tojson }}'
      >
        <strong>Shotcounter Styling</strong>
        <div class="muted">Farben, Schriftgrößen und Anzahl Teams im Vollbild.</div>
        <div class="shot-settings__grid">
          <label class="stack">
            <span>Hintergrund</span>
            <input type="color" class="color-input" data-shot-field="background_color">
          </label>
          <label class="stack">
            <span>Primärfarbe (Karten)</span>
            <input type="color" class="color-input" data-shot-field="primary_color">
          </label>
        </div>
        <div class="shot-settings__numbers">
          <label class="stack">
            <span>Schriftgröße Titel (rem)</span>
            <input type="number" step="0.1" min="0.5" max="10" data-shot-field="title_size">
          </label>
          <label class="stack">
            <span>Schriftgröße Teams (rem)</span>
            <input type="number" step="0.1" min="0.5" max="10" data-shot-field="team_size">
          </label>
          <label class="stack">
            <span>Teams im Leaderboard</span>
            <input type="number" step="1" min="1" max="50" data-shot-field="leaderboard_limit">
          </label>
        </div>
        <div class="shot-settings__numbers" style="margin-top: 0.6rem;">
          <label class="stack">
            <span>Leaderboard Layout</span>
            <select data-shot-field="leaderboard_layout">
              <option value="stacked">Teamname + Shots (2 Zeilen)</option>
              <option value="inline">Teamname – Shots (1 Zeile)</option>
            </select>
          </label>
        </div>
        <input type="hidden" name="shotcounter_settings" value='{{ shotcounter_defaults | tojson }}'>
      </div>

      <div class="collapsible" data-collapsible data-start-open="false" style="margin-top: 0.8rem;">
        <div class="collapsible__header">
          <div>
            <strong>Preisliste</strong>
            <div class="muted">Rotierende Kategorien für die Preisanzeige.</div>
          </div>
          <button type="button" class="secondary" data-toggle>Details einblenden</button>
        </div>
        <div class="collapsible__content" hidden>
          <div
            class="price-settings"
            data-price-settings
            data-defaults='{{ price_list_defaults | tojson }}'
            data-current='{{ price_list_defaults | tojson }}'
          >
            <div class="shot-settings__numbers">
              <label class="stack">
                <span>Schriftgröße (rem)</span>
                <input type="number" step="0.1" min="0.6" max="6" data-price-field="font_size">
              </label>
              <label class="stack">
                <span>Wechsel-Intervall (Sek.)</span>
                <input type="number" step="1" min="2" max="120" data-price-field="rotation_seconds">
              </label>
              <label class="stack">
                <span>Hintergrundbild</span>
                <select data-price-field="background_mode">
                  <option value="none">Kein Bild</option>
                  <option value="custom">Eigenes Bild verwenden</option>
                </select>
              </label>
            </div>
            <div class="shot-settings__numbers" style="margin-top: 0.6rem;">
              <label class="stack">
                <span>Hintergrundfarbe</span>
                <input type="color" class="color-input" data-price-field="background_color">
              </label>
            </div>
            <div class="muted" style="margin-top: 0.4rem;">Hintergrundbild kann nach dem Speichern hochgeladen werden.</div>
          </div>
        </div>
      </div>

      <input type="hidden" name="kassensystem_settings" value='{{ {"items": default_buttons} | tojson }}'>
      <p class="hint">Kassenartikel lassen sich nach dem Speichern oder per Vorlage übernehmen.</p>
      <div class="field-inline">
        <label class="secondary" style="padding:0.45rem 0.65rem; cursor:pointer;">
          Event-JSON importieren
          <input type="file" accept="application/json" data-import-event hidden>
        </label>
        <button type="button" class="secondary" data-export-event>Event-JSON exportieren</button>
      </div>
      <div class="form-actions" style="margin-top: 1rem;">
        <button type="submit" class="primary" data-submit-btn>Event anlegen</button>
        <span class="form-status" data-form-status style="margin-left: 0.8rem; color: #94a3b8; display: none;"></span>
      </div>
    </form>
  </div>
</div>

<!-- Credentials Management Section -->
<div class="collapsible card" data-collapsible>
  <div class="collapsible__header">
    <div>
      <h2 style="margin:0;">Admin-Zugangsdaten</h2>
      <div class="muted">Benutzername und Passwort für den Admin-Bereich verwalten.</div>
    </div>
    <button type="button" class="secondary" data-toggle>Details einblenden</button>
  </div>
  <div class="collapsible__content" hidden>
    <form method="post" action="{{ url_for('update_credentials') }}" data-credentials-form data-has-password="{{ 'true' if has_password else 'false' }}">
      <div class="stack">
        <label for="admin_username">Benutzername</label>
        <input 
          id="admin_username" 
          name="admin_username" 
          type="text"
          value="{% if admin_username %}{{ admin_username }}{% endif %}" 
          placeholder="admin" 
          required
        >
        <div class="hint">Der Benutzername für die Admin-Authentifizierung.</div>
      </div>
      
      <div class="stack" style="margin-top: 1rem;">
        <label for="admin_password">Passwort</label>
        <input 
          id="admin_password" 
          name="admin_password" 
          type="password"
          placeholder="Neues Passwort (mind. 8 Zeichen)"
        >
        <div class="hint">
          {% if has_password %}
            Leer lassen, um das aktuelle Passwort beizubehalten.
          {% else %}
            Setzen Sie ein Passwort, um den Admin-Bereich zu schützen.
          {% endif %}
        </div>
      </div>

      <div class="field-inline" style="margin-top: 1rem;">
        <button type="submit">Zugangsdaten speichern</button>
      </div>
      <div class="flash error" data-credentials-error style="display:none; margin-top: 1rem;"></div>
      
      <div class="muted" style="margin-top: 1rem;">
        <strong>Hinweis:</strong> Die Zugangsdaten werden in der Datei <code>instance/credentials.json</code> gespeichert, 
        die nicht ins Git-Repository übernommen wird. {% if not has_password %}
        Solange kein Passwort gesetzt ist, ist der Admin-Bereich ohne Authentifizierung zugänglich.
        {% endif %}
      </div>
    </form>
  </div>
</div>

<!-- Network Management Section -->
<div class="collapsible card" data-collapsible>
  <div class="collapsible__header">
    <div>
      <h2 style="margin:0;">Netzwerkeinstellungen</h2>
      <div class="muted">LAN (eth0) und WLAN (wlan0) Schnittstellen verwalten.</div>
    </div>
    <button type="button" class="secondary" data-toggle>Details einblenden</button>
  </div>
  <div class="collapsible__content" hidden>
    <div id="network-status">
      <p class="muted">Lade Netzwerkinformationen...</p>
    </div>
  </div>
</div>

<!-- System Update Section -->
<div class="collapsible card" data-collapsible>
  <div class="collapsible__header">
    <div>
      <h2 style="margin:0;">System-Update</h2>
      <div class="muted">Git-Repository aktualisieren und Service neu starten.</div>
    </div>
    <button type="button" class="secondary" data-toggle>Details einblenden</button>
  </div>
  <div class="collapsible__content" hidden>
    <div id="git-status">
      <p class="muted">Lade Git-Informationen...</p>
    </div>
  </div>
</div>

<script id="event-settings-data" type="application/json">
  {{ event_payloads | tojson }}
</script>
<script id="default-buttons-data" type="application/json">
  {{ default_buttons | tojson }}
</script>
<script id="shotcounter-defaults-data" type="application/json">
  {{ shotcounter_defaults | tojson }}
</script>
<script id="price-list-defaults-data" type="application/json">
  {{ price_list_defaults | tojson }}
</script>
<script src="{{ url_for('static', filename='js/admin.js', v='5') }}" defer></script>

{% endblock %}
