{% extends "base.html" %}
{% block title %}Admin{% endblock %}
{% block content %}
<h1>Adminbereich</h1>

<style>
  .muted { color: #94a3b8; font-size: 0.95rem; }
  .event-card { background: #11192e; }
  .product-editor {
    margin-top: 1rem;
    border: 1px dashed var(--border);
    border-radius: 10px;
    padding: 0.9rem;
    background: rgba(255,255,255,0.02);
  }
  .product-editor__top { display:flex; align-items:center; justify-content:space-between; gap:0.6rem; flex-wrap:wrap; }
  .product-editor__preview {
    margin-top: 0.8rem;
    display: grid;
    gap: 0.6rem;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }
  .product-preview-card {
    border-radius: 12px;
    padding: 0.85rem;
    color: #e2e8f0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.08);
    cursor: grab;
    transition: transform 0.15s ease, box-shadow 0.2s ease;
  }
  .product-preview-card small { opacity: 0.75; display:block; margin-bottom:0.35rem; }
  .product-preview-card.dragging { opacity: 0.6; transform: scale(0.98); }
  .product-preview-card.drag-over { outline: 2px dashed rgba(255,255,255,0.5); }
  .product-editor__list { margin-top: 1rem; display:flex; flex-direction:column; gap:0.75rem; }
  .product-row {
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap:0.6rem;
    background:#0c1324;
    border:1px solid var(--border);
    border-radius:10px;
    padding:0.75rem;
  }
  .product-row label { font-size: 0.9rem; color: #cbd5e1; display:block; margin-bottom:0.2rem; }
  .product-row .row-actions { display:flex; justify-content:flex-end; align-items:flex-end; }
  .product-row .row-actions button { width:100%; }
  .hint { font-size:0.9rem; color:#cbd5e1; margin-top:0.4rem; }
  .stack { display:flex; flex-direction:column; gap:0.4rem; }
  .field-inline { display:flex; gap:0.6rem; flex-wrap:wrap; align-items:center; }
  .color-input { width:100%; min-height:44px; padding: 0; }
</style>

<div class="card">
  <h2>Neues Event</h2>
  <form method="post" action="{{ url_for('create_event') }}">
    <label for="name">Name</label><br>
    <input id="name" name="name" placeholder="z.B. Sommerfest" required>
    <div style="margin: 0.6rem 0;">
      <label><input type="checkbox" name="kassensystem_enabled" checked> Kassensystem aktiv</label>
      <label style="margin-left:1rem;"><input type="checkbox" name="shotcounter_enabled" checked> Shotcounter aktiv</label>
    </div>
    <label for="shared_settings">Gemeinsame Einstellungen (JSON)</label>
    <textarea id="shared_settings" name="shared_settings" placeholder='{"waehrung": "CHF"}'></textarea>
    <input type="hidden" name="kassensystem_settings" value='{{ {"items": default_buttons} | tojson }}'>
    <p class="hint">Produkte kannst du nach dem Speichern im jeweiligen Event bearbeiten.</p>
    <label for="shotcounter_settings">Shotcounter Einstellungen (JSON)</label>
    <textarea id="shotcounter_settings" name="shotcounter_settings" placeholder='{"max_shots": 10}'></textarea>
    <button type="submit">Event anlegen</button>
  </form>
</div>

<div class="card">
  <h2>Events</h2>
  {% if not events %}
    <p>Es wurden noch keine Events angelegt.</p>
  {% endif %}
  {% for event in events %}
    <div class="card" style="background: #0b1222;">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: .4rem;">
        <div>
          <strong>{{ event.name }}</strong>
          {% if event.is_active %}<span class="badge badge-green">aktiv</span>{% endif %}
          {% if event.is_archived %}<span class="badge badge-red">archiviert</span>{% endif %}
        </div>
        <div>
          <form class="inline" method="post" action="{{ url_for('activate_event', event_id=event.id) }}">
            <button type="submit" class="secondary">Aktivieren</button>
          </form>
          <form class="inline" method="post" action="{{ url_for('archive_event', event_id=event.id) }}">
            <button type="submit" class="danger">Archivieren</button>
          </form>
        </div>
      </div>

      <form method="post" action="{{ url_for('update_event', event_id=event.id) }}" style="margin-top:.8rem;">
        <div style="margin-bottom:0.6rem;">
          <label><input type="checkbox" name="kassensystem_enabled" {% if event.kassensystem_enabled %}checked{% endif %}> Kassensystem aktiv</label>
          <label style="margin-left:1rem;"><input type="checkbox" name="shotcounter_enabled" {% if event.shotcounter_enabled %}checked{% endif %}> Shotcounter aktiv</label>
        </div>
        <label>Gemeinsame Einstellungen</label>
        <textarea name="shared_settings">{{ (event.shared_settings or {}) | tojson(indent=2) }}</textarea>
        <label>Shotcounter Einstellungen</label>
        <textarea name="shotcounter_settings">{{ (event.shotcounter_settings or {}) | tojson(indent=2) }}</textarea>

        <div class="product-editor" data-product-editor data-items='{{ event_buttons.get(event.id, default_buttons) | tojson }}'>
          <div class="product-editor__top">
            <div>
              <strong>Produkte für dieses Event</strong>
              <div class="muted">Titel, Preis und Hintergrundfarbe bearbeiten. Reihenfolge per Drag & Drop ändern.</div>
            </div>
            <button type="button" class="secondary" data-add-product>+ Produkt</button>
          </div>
          <div class="product-editor__preview" data-product-preview></div>
          <div class="product-editor__list" data-product-list></div>
          <input type="hidden" name="kassensystem_settings" value='{{ kass_settings.get(event.id, {"items": event_buttons.get(event.id, default_buttons)}) | tojson }}'>
        </div>
        <button type="submit">Speichern</button>
      </form>
    </div>
  {% endfor %}
</div>

<script>
  (function () {
    const fallbackColor = "#1f2a44";

    const sanitizeColor = (value) => {
      if (typeof value !== "string") return fallbackColor;
      const hex = value.trim();
      return /^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})$/.test(hex) ? hex : fallbackColor;
    };

    const normalizeItem = (item, index) => {
      const label = (item?.label || item?.name || "").trim() || `Produkt ${index + 1}`;
      const name = (item?.name || label || `produkt-${index + 1}`).trim();
      const price = Number.isFinite(Number(item?.price)) ? Number(item.price) : 0;
      return {
        name,
        label,
        price,
        css_class: item?.css_class || "custom",
        color: sanitizeColor(item?.color || ""),
      };
    };

    document.querySelectorAll("[data-product-editor]").forEach((wrapper) => {
      const addButton = wrapper.querySelector("[data-add-product]");
      const preview = wrapper.querySelector("[data-product-preview]");
      const list = wrapper.querySelector("[data-product-list]");
      const hidden = wrapper.querySelector('input[name="kassensystem_settings"]');

      let baseSettings = {};
      try {
        baseSettings = JSON.parse(hidden.value || "{}");
      } catch (err) {
        baseSettings = {};
      }

      let parsedItems = [];
      try {
        parsedItems = JSON.parse(wrapper.dataset.items || "[]");
      } catch (err) {
        parsedItems = [];
      }

      let items = Array.isArray(parsedItems) ? parsedItems.map(normalizeItem) : [];
      if (!items.length) {
        items = [normalizeItem({ name: "Produkt", label: "Neues Produkt", price: 0, color: fallbackColor }, 0)];
      }

      const syncHidden = () => {
        hidden.value = JSON.stringify({ ...baseSettings, items });
      };

      const renderPreview = () => {
        preview.innerHTML = "";
        let dragIndex = null;

        items.forEach((item, index) => {
          const card = document.createElement("div");
          card.className = "product-preview-card";
          card.draggable = true;
          card.style.background = sanitizeColor(item.color);
          card.dataset.index = index;
          card.innerHTML = `<small>${item.price} CHF</small><div style="font-weight:700;">${item.label}</div>`;

          card.addEventListener("dragstart", () => {
            dragIndex = index;
            card.classList.add("dragging");
          });
          card.addEventListener("dragend", () => card.classList.remove("dragging"));
          card.addEventListener("dragover", (ev) => {
            ev.preventDefault();
            card.classList.add("drag-over");
          });
          card.addEventListener("dragleave", () => card.classList.remove("drag-over"));
          card.addEventListener("drop", (ev) => {
            ev.preventDefault();
            card.classList.remove("drag-over");
            const targetIndex = Number(card.dataset.index);
            if (Number.isNaN(targetIndex) || dragIndex === null || dragIndex === targetIndex) {
              return;
            }
            const [moved] = items.splice(dragIndex, 1);
            items.splice(targetIndex, 0, moved);
            renderList();
            renderPreview();
            syncHidden();
          });

          preview.appendChild(card);
        });
      };

      const renderList = () => {
        list.innerHTML = "";

        items.forEach((item, index) => {
          const row = document.createElement("div");
          row.className = "product-row";

          const nameContainer = document.createElement("div");
          nameContainer.className = "stack";
          const nameLabel = document.createElement("label");
          nameLabel.textContent = "Schlüssel (interner Name)";
          const nameInput = document.createElement("input");
          nameInput.value = item.name;
          nameInput.placeholder = "unique-key";
          nameInput.addEventListener("input", () => {
            item.name = nameInput.value.trim();
            syncHidden();
          });
          nameContainer.append(nameLabel, nameInput);

          const labelContainer = document.createElement("div");
          labelContainer.className = "stack";
          const labelLabel = document.createElement("label");
          labelLabel.textContent = "Titel (Anzeige)";
          const labelInput = document.createElement("input");
          labelInput.value = item.label;
          labelInput.placeholder = "z.B. Bier";
          labelInput.addEventListener("input", () => {
            item.label = labelInput.value;
            if (!item.name.trim()) {
              item.name = labelInput.value;
              nameInput.value = item.name;
            }
            renderPreview();
            syncHidden();
          });
          labelContainer.append(labelLabel, labelInput);

          const priceContainer = document.createElement("div");
          priceContainer.className = "stack";
          const priceLabel = document.createElement("label");
          priceLabel.textContent = "Preis (CHF)";
          const priceInput = document.createElement("input");
          priceInput.type = "number";
          priceInput.step = "1";
          priceInput.value = item.price;
          priceInput.addEventListener("input", () => {
            const parsed = Number(priceInput.value);
            item.price = Number.isFinite(parsed) ? parsed : 0;
            renderPreview();
            syncHidden();
          });
          priceContainer.append(priceLabel, priceInput);

          const colorContainer = document.createElement("div");
          colorContainer.className = "stack";
          const colorLabel = document.createElement("label");
          colorLabel.textContent = "Hintergrundfarbe";
          const colorInput = document.createElement("input");
          colorInput.type = "color";
          colorInput.className = "color-input";
          colorInput.value = sanitizeColor(item.color);
          colorInput.addEventListener("input", () => {
            item.color = sanitizeColor(colorInput.value);
            renderPreview();
            syncHidden();
          });
          colorContainer.append(colorLabel, colorInput);

          const actions = document.createElement("div");
          actions.className = "row-actions";
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "danger";
          removeBtn.textContent = "Entfernen";
          removeBtn.addEventListener("click", () => {
            items.splice(index, 1);
            if (!items.length) {
              items.push(normalizeItem({ name: "produkt", label: "Produkt", price: 0, color: fallbackColor }, 0));
            }
            renderList();
            renderPreview();
            syncHidden();
          });
          actions.appendChild(removeBtn);

          row.append(labelContainer, nameContainer, priceContainer, colorContainer, actions);
          list.appendChild(row);
        });
      };

      addButton?.addEventListener("click", () => {
        items.push(
          normalizeItem(
            {
              name: `produkt-${Date.now()}`,
              label: "Neues Produkt",
              price: 0,
              color: fallbackColor,
            },
            items.length
          )
        );
        renderList();
        renderPreview();
        syncHidden();
      });

      renderList();
      renderPreview();
      syncHidden();
    });
  })();
</script>

{% endblock %}
