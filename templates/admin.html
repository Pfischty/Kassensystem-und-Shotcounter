{% extends "base.html" %}
{% block title %}Admin{% endblock %}
{% block content %}
<h1>Adminbereich</h1>

{% set active_id = active_event.id if active_event else None %}

<style>
  .muted { color: #94a3b8; font-size: 0.95rem; }
  .hint { font-size:0.9rem; color:#cbd5e1; margin-top:0.2rem; }
  .stack { display:flex; flex-direction:column; gap:0.35rem; }
  .field-inline { display:flex; gap:0.6rem; flex-wrap:wrap; align-items:center; }
  .inline-actions { display:flex; gap:0.4rem; flex-wrap:wrap; align-items:center; }
  .card { margin-bottom: 1.2rem; }
  .section-title { display:flex; align-items:center; gap:0.6rem; margin-bottom: 0.6rem; }
  .section-title h2 { margin: 0; }
  .subsection { padding: 0.9rem; border-radius: 12px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); margin-top: 0.8rem; }
  .subsection h3 { margin: 0 0 0.6rem 0; font-size: 1.05rem; }
  .admin-tabs { display:flex; gap:0.6rem; flex-wrap:wrap; margin: 0.8rem 0 1.2rem; }
  .admin-tab {
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.04);
    padding: 0.55rem 0.9rem;
    border-radius: 999px;
    color: #e2e8f0;
    cursor: pointer;
    transition: background 0.2s ease, border 0.2s ease;
  }
  .admin-tab[aria-selected="true"] {
    background: rgba(56,189,248,0.2);
    border-color: rgba(56,189,248,0.6);
    color: #38bdf8;
  }
  .tab-panel { display:none; }
  .tab-panel.active { display:block; }

  .event-card { background: #0b1222; border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; }
  .event-card__row { display:flex; justify-content:space-between; align-items:center; gap:1rem; padding: 0.75rem 1rem; flex-wrap:wrap; }

  .product-editor {
    margin-top: 0.6rem;
    border: 1px dashed var(--border);
    border-radius: 10px;
    padding: 0.9rem;
    background: rgba(255,255,255,0.02);
  }
  .product-editor__top { display:flex; align-items:center; justify-content:space-between; gap:0.6rem; flex-wrap:wrap; }
  .product-editor__preview {
    margin-top: 0.8rem;
    display: grid;
    gap: 0.6rem;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }
  .product-preview-card {
    border-radius: 12px;
    padding: 0.85rem;
    color: #e2e8f0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.08);
    cursor: grab;
    transition: transform 0.15s ease, box-shadow 0.2s ease, opacity 0.2s ease;
  }
  .product-preview-card small { opacity: 0.75; display:block; margin-bottom:0.35rem; }
  .product-preview-card.dragging { opacity: 0.6; transform: scale(0.98); }
  .product-preview-card.drag-over { outline: 2px dashed rgba(255,255,255,0.5); }
  .product-preview-card.is-muted { opacity: 0.55; }
  .product-editor__list { margin-top: 1rem; display:flex; flex-direction:column; gap:0.75rem; }
  .product-row {
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap:0.6rem;
    background:#0c1324;
    border:1px solid var(--border);
    border-radius:10px;
    padding:0.75rem;
  }
  .product-row label { font-size: 0.9rem; color: #cbd5e1; display:block; margin-bottom:0.2rem; }
  .product-row .row-actions { display:flex; justify-content:flex-end; align-items:flex-end; }
  .product-row .row-actions button { width:100%; }
  .product-visibility { display:flex; flex-direction:column; gap:0.3rem; }
  .product-visibility label { margin: 0; display:flex; align-items:center; gap:0.4rem; }

  .color-input { width:100%; min-height:44px; padding: 0; }
  .pill { padding: 0.3rem 0.7rem; border-radius: 999px; background: rgba(255,255,255,0.06); border: 1px solid var(--border); font-size: 0.9rem; }
  .shot-settings { margin: 0.8rem 0; }
  .shot-settings__grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:0.6rem; margin-top: 0.4rem; }
  .shot-settings__grid span { font-size: 0.9rem; color: #cbd5e1; }
  .shot-settings__numbers { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:0.6rem; margin-top: 0.6rem; }
  .badge-yellow { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245,158,11,0.5); }
  .status-toggle { min-width: 130px; }
  .status-toggle.active {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border-color: rgba(34, 197, 94, 0.5);
  }
  .status-toggle.inactive {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.5);
  }
  .status-toggle.archived {
    background: rgba(100, 116, 139, 0.2);
    color: #94a3b8;
    border-color: rgba(100, 116, 139, 0.5);
  }

  .media-grid { display:grid; gap:0.8rem; }
  .media-row { display:flex; gap:0.8rem; align-items:center; flex-wrap:wrap; padding:0.6rem; border:1px solid var(--border); border-radius:10px; background: rgba(255,255,255,0.03); }
  .media-row img { width: 90px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border); }

  .form-feedback { margin-top: 0.8rem; display:none; padding: 0.6rem 0.8rem; border-radius: 8px; border: 1px solid transparent; }
  .form-feedback.error { display:block; color: #fecaca; border-color: rgba(239, 68, 68, 0.6); background: rgba(239,68,68,0.12); }
  .form-feedback.success { display:block; color: #bbf7d0; border-color: rgba(34, 197, 94, 0.5); background: rgba(34,197,94,0.12); }
</style>

<div class="muted" style="margin-bottom: 0.6rem;">
  {% if active_event %}
    Aktives Event: <strong>{{ active_event.name }}</strong>
    {% if active_event.is_archived %}<span class="badge badge-red">archiviert</span>{% endif %}
  {% else %}
    Kein aktives Event ausgewählt.
  {% endif %}
</div>

<nav class="admin-tabs" role="tablist">
  <button class="admin-tab" type="button" role="tab" data-tab="event-selection" aria-selected="true">Eventauswahl</button>
  <button class="admin-tab" type="button" role="tab" data-tab="event-settings">Eventeinstellungen (aktiv)</button>
  <button class="admin-tab" type="button" role="tab" data-tab="system">Systemeinstellungen</button>
  <button class="admin-tab" type="button" role="tab" data-tab="security">Sicherheit</button>
  <button class="admin-tab" type="button" role="tab" data-tab="media">Medienmanagement</button>
</nav>

<section class="tab-panel active" data-tab-panel="event-selection">
  <div class="card">
    <div class="section-title">
      <h2>Eventauswahl</h2>
      <span class="pill">Events verwalten & aktivieren</span>
    </div>
    {% if not events %}
      <p>Es wurden noch keine Events angelegt.</p>
    {% endif %}
    {% for event in events %}
      <div class="event-card" style="margin-bottom: 1rem;">
        <div class="event-card__row">
          <div>
            <strong>{{ event.name }}</strong>
            {% if event.is_active %}<span class="badge badge-green">aktiv</span>{% endif %}
            {% if event.is_archived %}<span class="badge badge-red">archiviert</span>{% endif %}
            <div class="muted">Letzte Änderung: {{ event.updated_at.strftime("%d.%m.%Y %H:%M") if event.updated_at else "–" }}</div>
          </div>
          <div class="inline-actions">
            <form class="inline" method="post" action="{{ url_for('activate_event', event_id=event.id) if (event.is_archived or not event.is_active) else url_for('archive_event', event_id=event.id) }}">
              <button type="submit" class="status-toggle {% if event.is_active %}active{% elif event.is_archived %}archived{% else %}inactive{% endif %}">
                {% if event.is_archived %}
                  Archiviert - Aktivieren
                {% elif event.is_active %}
                  Aktiv - Archivieren
                {% else %}
                  Inaktiv - Aktivieren
                {% endif %}
              </button>
            </form>
            {% if active_event and event.id == active_event.id %}
              <span class="pill">Aktiv</span>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="card">
    <div class="section-title">
      <h2>Neues Event</h2>
      <span class="pill">inkl. Grundeinstellungen</span>
    </div>
    <form method="post" action="{{ url_for('create_event') }}" data-event-form data-scope="new">
      <div class="subsection">
        <h3>Eventbasis</h3>
        <div class="stack">
          <label for="name">Name</label>
          <input id="name" name="name" placeholder="z.B. Sommerfest" required>
        </div>
        <div class="field-inline" style="margin: 0.6rem 0;">
          <label><input type="checkbox" name="kassensystem_enabled" checked> Kassensystem aktiv</label>
          <label><input type="checkbox" name="shotcounter_enabled" checked> Shotcounter aktiv</label>
        </div>
        <div class="field-inline" style="margin: 0.6rem 0;">
          <label><input type="checkbox" name="auto_reload_on_add" checked data-shared-setting> Auto-Reload beim Hinzufügen (Kasse)</label>
        </div>
        <div class="muted">Wenn deaktiviert, wird die Kasse nicht neu geladen beim Hinzufügen von Artikeln (performanter).</div>
      </div>

      {% if events %}
      <div class="subsection">
        <h3>Vorlage kopieren</h3>
        <div class="field-inline">
          <select data-copy-select>
            <option value="">Bitte wählen</option>
            {% for template in events %}
              <option value="{{ template.id }}">{{ template.name }}</option>
            {% endfor %}
          </select>
          <button type="button" class="secondary" data-copy-btn>Übernehmen</button>
        </div>
        <div class="muted">Übernimmt Einstellungen, Shotcounter-Optionen und Kassenartikel der gewählten Vorlage.</div>
      </div>
      {% endif %}

      <input type="hidden" name="shared_settings" value='{{ {"price_list": price_list_defaults} | tojson }}'>

      <div class="subsection">
        <h3>Shotcounter</h3>
        <div
          class="shot-settings"
          data-shot-settings
          data-defaults='{{ shotcounter_defaults | tojson }}'
          data-current='{{ shotcounter_defaults | tojson }}'
        >
          <div class="muted">Farben, Schriftgrößen, Leaderboard und Medienhintergrund.</div>
          <div class="shot-settings__grid">
            <label class="stack">
              <span>Hintergrund</span>
              <input type="color" class="color-input" data-shot-field="background_color">
            </label>
            <label class="stack">
              <span>Primärfarbe (Karten)</span>
              <input type="color" class="color-input" data-shot-field="primary_color">
            </label>
            <label class="stack">
              <span>Sekundärfarbe (Verlauf)</span>
              <input type="color" class="color-input" data-shot-field="secondary_color">
            </label>
            <label class="stack">
              <span>Terziärfarbe (Verlauf)</span>
              <input type="color" class="color-input" data-shot-field="tertiary_color">
            </label>
          </div>
          <div class="shot-settings__numbers">
            <label class="stack">
              <span>Schriftgröße Titel (rem)</span>
              <input type="number" step="0.1" min="0.5" max="10" data-shot-field="title_size">
            </label>
            <label class="stack">
              <span>Schriftgröße Teams (rem)</span>
              <input type="number" step="0.1" min="0.5" max="10" data-shot-field="team_size">
            </label>
            <label class="stack">
              <span>Teams im Leaderboard</span>
              <input type="number" step="1" min="1" max="50" data-shot-field="leaderboard_limit">
            </label>
          </div>
          <div class="shot-settings__numbers" style="margin-top: 0.6rem;">
            <label class="stack">
              <span>Leaderboard Layout</span>
              <select data-shot-field="leaderboard_layout">
                <option value="stacked">Teamname + Shots (2 Zeilen)</option>
                <option value="inline">Teamname – Shots (1 Zeile)</option>
              </select>
            </label>
            <label class="stack">
              <span>Medienhintergrund</span>
              <select data-shot-field="background_image" data-media-select>
                <option value="">Kein Bild</option>
                {% for filename in media_files %}
                  <option value="{{ filename }}">{{ filename }}</option>
                {% endfor %}
              </select>
              <img data-shot-preview src="" alt="Shotcounter Hintergrund Vorschau" style="max-width: 200px; max-height: 120px; border-radius: 8px; border: 1px solid var(--border); display:none; margin-top:0.4rem;">
            </label>
          </div>
          <input type="hidden" name="shotcounter_settings" value='{{ shotcounter_defaults | tojson }}'>
        </div>
      </div>

      <div class="subsection">
        <h3>Preisliste</h3>
        <div
          class="price-settings"
          data-price-settings
          data-defaults='{{ price_list_defaults | tojson }}'
          data-current='{{ price_list_defaults | tojson }}'
        >
          <div class="shot-settings__numbers">
            <label class="stack">
              <span>Schriftgröße (rem)</span>
              <input type="number" step="0.1" min="0.6" max="6" data-price-field="font_size">
            </label>
            <label class="stack">
              <span>Wechsel-Intervall (Sek.)</span>
              <input type="number" step="1" min="2" max="120" data-price-field="rotation_seconds">
            </label>
            <label class="stack">
              <span>Hintergrundmodus</span>
              <select data-price-field="background_mode">
                <option value="none">Kein Bild</option>
                <option value="custom">Eigenes Bild verwenden</option>
              </select>
            </label>
          </div>
          <div class="shot-settings__numbers" style="margin-top: 0.6rem;">
            <label class="stack">
              <span>Hintergrundfarbe</span>
              <input type="color" class="color-input" data-price-field="background_color">
            </label>
          </div>

          <div data-price-custom-bg style="margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid var(--border);">
            <strong>Hintergrund aus Medien</strong>
            <div class="muted">Bild aus dem Medienmanagement auswählen.</div>
            <div class="shot-settings__numbers" style="margin-top: 0.6rem;">
              <label class="stack" style="min-width: 220px;">
                <span>Vorhandenes Bild wählen</span>
                <select data-price-image-select data-media-select>
                  <option value="">Kein Bild</option>
                  {% for filename in media_files %}
                    <option value="{{ filename }}">{{ filename }}</option>
                  {% endfor %}
                </select>
              </label>
              <div style="display:flex; align-items:flex-end; gap:0.6rem;">
                <img data-price-image-preview src="" alt="Preisliste Hintergrund Vorschau" style="max-width: 200px; max-height: 120px; border-radius: 8px; border: 1px solid var(--border); display:none;">
              </div>
            </div>
            <div class="muted" style="margin-top: 0.4rem;">Neue Bilder können im Medienmanagement hochgeladen werden.</div>
          </div>

          <div class="stack" style="margin-top: 0.8rem;">
            <span>Kategorien aktivieren</span>
            <div data-price-categories></div>
            <div class="hint" data-price-error style="display:none; color:#ef4444;"></div>
            <div class="muted">Kategorien kommen aus den Produkten, die für die Preisliste aktiviert sind.</div>
          </div>
        </div>
      </div>

      <input type="hidden" name="kassensystem_settings" value='{{ {"items": default_buttons} | tojson }}'>
      <p class="hint">Kassenartikel lassen sich nach dem Speichern oder per Vorlage übernehmen.</p>
      <div class="field-inline">
        <label class="secondary" style="padding:0.45rem 0.65rem; cursor:pointer;">
          Event-JSON importieren
          <input type="file" accept="application/json" data-import-event hidden>
        </label>
        <button type="button" class="secondary" data-export-event>Event-JSON exportieren</button>
      </div>
      <div class="form-actions" style="margin-top: 1rem;">
        <button type="submit" class="primary" data-submit-btn>Event anlegen</button>
        <span class="form-status" data-form-status style="margin-left: 0.8rem; color: #94a3b8; display: none;"></span>
      </div>
      <div class="form-feedback" data-form-feedback></div>
    </form>
  </div>
</section>

<section class="tab-panel" data-tab-panel="event-settings">
  {% if not active_event %}
    <div class="card">
      <div class="section-title">
        <h2>Eventeinstellungen</h2>
      </div>
      <p>Kein aktives Event ausgewählt. Bitte im Tab „Eventauswahl“ aktivieren.</p>
    </div>
  {% else %}
    {% set current_pl = (active_event.shared_settings or {}).get('price_list', {}) %}
    {% set current_pl_bg = current_pl.get('background_image') %}
    {% set current_bg = shot_settings_map.get(active_event.id, {}).get('background_image') %}

    <div class="card">
      <div class="section-title">
        <h2>Eventeinstellungen – {{ active_event.name }}</h2>
        <span class="pill">Speichert automatisch nach Feldwechsel</span>
      </div>
      <form method="post" action="{{ url_for('update_event', event_id=active_event.id) }}" data-event-form data-scope="{{ active_event.id }}" data-auto-save="true">
        <div class="subsection">
          <h3>Eventparameter</h3>
          <div class="field-inline" style="margin: 0.4rem 0;">
            <label><input type="checkbox" name="kassensystem_enabled" {% if active_event.kassensystem_enabled %}checked{% endif %}> Kassensystem aktiv</label>
            <label><input type="checkbox" name="shotcounter_enabled" {% if active_event.shotcounter_enabled %}checked{% endif %}> Shotcounter aktiv</label>
          </div>
          <div class="field-inline" style="margin: 0.6rem 0;">
            <label><input type="checkbox" name="auto_reload_on_add" {% if active_event.shared_settings and active_event.shared_settings.get('auto_reload_on_add', True) %}checked{% endif %} data-shared-setting> Auto-Reload beim Hinzufügen (Kasse)</label>
          </div>
          <div class="muted">Wenn deaktiviert, wird die Kasse nicht neu geladen beim Hinzufügen von Artikeln (performanter).</div>
        </div>

        {% if events|length > 1 %}
        <div class="subsection">
          <h3>Einstellungen kopieren</h3>
          <div class="field-inline">
            <select data-copy-select>
              <option value="">Bitte wählen</option>
              {% for template in events if template.id != active_event.id %}
                <option value="{{ template.id }}">{{ template.name }}</option>
              {% endfor %}
            </select>
            <button type="button" class="secondary" data-copy-btn>Übernehmen</button>
            <span class="pill">kopiert auch Produkte</span>
          </div>
        </div>
        {% endif %}

        <input type="hidden" name="shared_settings" value='{{ (active_event.shared_settings or {}) | tojson }}'>

        <div class="subsection">
          <h3>Shotcounter</h3>
          <div
            class="shot-settings"
            data-shot-settings
            data-defaults='{{ shotcounter_defaults | tojson }}'
            data-current='{{ (shot_settings_map.get(active_event.id) or shotcounter_defaults) | tojson }}'
          >
            <div class="muted">Vollbild/Touch: Farben, Schriftgrößen, Teamanzahl und Medienhintergrund.</div>
            <div class="shot-settings__grid">
              <label class="stack">
                <span>Hintergrund</span>
                <input type="color" class="color-input" data-shot-field="background_color">
              </label>
              <label class="stack">
                <span>Primärfarbe (Karten)</span>
                <input type="color" class="color-input" data-shot-field="primary_color">
              </label>
              <label class="stack">
                <span>Sekundärfarbe (Verlauf)</span>
                <input type="color" class="color-input" data-shot-field="secondary_color">
              </label>
              <label class="stack">
                <span>Terziärfarbe (Verlauf)</span>
                <input type="color" class="color-input" data-shot-field="tertiary_color">
              </label>
            </div>
            <div class="shot-settings__numbers">
              <label class="stack">
                <span>Schriftgröße Titel (rem)</span>
                <input type="number" step="0.1" min="0.5" max="10" data-shot-field="title_size">
              </label>
              <label class="stack">
                <span>Schriftgröße Teams (rem)</span>
                <input type="number" step="0.1" min="0.5" max="10" data-shot-field="team_size">
              </label>
              <label class="stack">
                <span>Teams im Leaderboard</span>
                <input type="number" step="1" min="1" max="50" data-shot-field="leaderboard_limit">
              </label>
            </div>
            <div class="shot-settings__numbers" style="margin-top: 0.6rem;">
              <label class="stack">
                <span>Leaderboard Layout</span>
                <select data-shot-field="leaderboard_layout">
                  <option value="stacked">Teamname + Shots (2 Zeilen)</option>
                  <option value="inline">Teamname – Shots (1 Zeile)</option>
                </select>
              </label>
              <label class="stack">
                <span>Medienhintergrund</span>
                <select data-shot-field="background_image" data-media-select>
                  <option value="">Kein Bild</option>
                  {% for filename in media_files %}
                    <option value="{{ filename }}">{{ filename }}</option>
                  {% endfor %}
                </select>
                <img data-shot-preview src="" alt="Shotcounter Hintergrund Vorschau" style="max-width: 200px; max-height: 120px; border-radius: 8px; border: 1px solid var(--border); display:none; margin-top:0.4rem;">
              </label>
            </div>

            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
              <strong>Direktupload Hintergrund</strong>
              <div class="muted">Optional: Bild für Leaderboard-Anzeige hochladen.</div>
              {% if current_bg %}
                <div style="margin-top: 0.6rem; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                  <img src="{{ url_for('uploaded_file', filename=current_bg) }}" alt="Aktuelles Hintergrundbild" style="max-width: 200px; max-height: 120px; border-radius: 8px; border: 1px solid var(--border);">
                  <button
                    type="submit"
                    class="danger"
                    form="bg-delete-{{ active_event.id }}"
                    onclick="return confirm('Hintergrundbild wirklich entfernen?');"
                  >Bild entfernen</button>
                </div>
              {% endif %}
              <div style="margin-top: 0.6rem;">
                <div class="field-inline">
                  <input
                    type="file"
                    name="background_image"
                    accept="image/png,image/jpeg,image/gif,image/webp"
                    style="max-width: 300px;"
                    form="bg-upload-{{ active_event.id }}"
                    data-file-upload
                  >
                  <button type="submit" form="bg-upload-{{ active_event.id }}">Hochladen</button>
                </div>
                <div class="muted" style="margin-top: 0.3rem;">Erlaubte Formate: PNG, JPG, GIF, WebP. Max. 5 MB.</div>
              </div>
            </div>

            <input type="hidden" name="shotcounter_settings" value='{{ (shot_settings_map.get(active_event.id) or shotcounter_defaults) | tojson }}'>
          </div>
        </div>

        <div class="subsection">
          <h3>Preisliste</h3>
          <div
            class="price-settings"
            data-price-settings
            data-defaults='{{ price_list_defaults | tojson }}'
            data-current='{{ current_pl | tojson }}'
            data-scope="{{ active_event.id }}"
          >
            <div class="shot-settings__numbers">
              <label class="stack">
                <span>Schriftgröße (rem)</span>
                <input type="number" step="0.1" min="0.6" max="6" data-price-field="font_size">
              </label>
              <label class="stack">
                <span>Wechsel-Intervall (Sek.)</span>
                <input type="number" step="1" min="2" max="120" data-price-field="rotation_seconds">
              </label>
              <label class="stack">
                <span>Hintergrundmodus</span>
                <select data-price-field="background_mode">
                  <option value="none">Kein Bild</option>
                  <option value="custom">Eigenes Bild verwenden</option>
                </select>
              </label>
            </div>
            <div class="shot-settings__numbers" style="margin-top: 0.6rem;">
              <label class="stack">
                <span>Hintergrundfarbe</span>
                <input type="color" class="color-input" data-price-field="background_color">
              </label>
            </div>

            <div data-price-custom-bg style="margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid var(--border);">
              <strong>Hintergrund aus Medien</strong>
              <div class="muted">Bild aus dem Medienmanagement auswählen.</div>
              <div class="shot-settings__numbers" style="margin-top: 0.6rem;">
                <label class="stack" style="min-width: 220px;">
                  <span>Vorhandenes Bild wählen</span>
                  <select data-price-image-select data-media-select>
                    <option value="">Kein Bild</option>
                    {% for filename in media_files %}
                      <option value="{{ filename }}">{{ filename }}</option>
                    {% endfor %}
                  </select>
                </label>
                <div style="display:flex; align-items:flex-end; gap:0.6rem;">
                  <img data-price-image-preview src="" alt="Preisliste Hintergrund Vorschau" style="max-width: 200px; max-height: 120px; border-radius: 8px; border: 1px solid var(--border); display:none;">
                </div>
              </div>

              {% if current_pl_bg %}
                <div style="margin-top: 0.6rem; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                  <img src="{{ url_for('uploaded_file', filename=current_pl_bg) }}" alt="Aktuelles Preisliste-Hintergrundbild" style="max-width: 200px; max-height: 120px; border-radius: 8px; border: 1px solid var(--border);">
                  <button
                    type="submit"
                    class="danger"
                    form="pl-delete-{{ active_event.id }}"
                    onclick="return confirm('Preisliste-Hintergrundbild wirklich entfernen?');"
                  >Bild entfernen</button>
                </div>
              {% endif %}
              <div style="margin-top: 0.6rem;">
                <div class="field-inline">
                  <input
                    type="file"
                    name="price_list_background"
                    accept="image/png,image/jpeg,image/gif,image/webp"
                    style="max-width: 300px;"
                    form="pl-upload-{{ active_event.id }}"
                    data-file-upload
                  >
                  <button type="submit" form="pl-upload-{{ active_event.id }}">Hochladen</button>
                </div>
                <div class="muted" style="margin-top: 0.3rem;">Erlaubte Formate: PNG, JPG, GIF, WebP. Max. 5 MB.</div>
              </div>
            </div>

            <div class="stack" style="margin-top: 0.8rem;">
              <span>Kategorien aktivieren</span>
              <div data-price-categories></div>
              <div class="hint" data-price-error style="display:none; color:#ef4444;"></div>
              <div class="muted">Kategorien kommen aus den Produkten, die für die Preisliste aktiviert sind.</div>
            </div>
          </div>
        </div>

        <div class="subsection">
          <h3>Kassensystem</h3>
          <div class="muted">Produkte, Kategorien und Sichtbarkeit pro Anwendung steuern.</div>
          <div class="product-editor" data-product-editor data-scope="{{ active_event.id }}" data-items='{{ event_buttons.get(active_event.id, default_buttons) | tojson }}'>
            <div class="product-editor__top">
              <div>
                <strong>Produkte für dieses Event</strong>
                <div class="muted">Titel, Preis, Farbe bearbeiten. Reihenfolge per Drag & Drop ändern.</div>
              </div>
              <div class="inline-actions">
                <label class="secondary" style="padding:0.45rem 0.65rem; cursor:pointer;">
                  JSON importieren
                  <input type="file" accept="application/json" data-product-import hidden>
                </label>
                <button type="button" class="secondary" data-product-export>Daten exportieren</button>
                <button type="button" class="secondary" data-add-product>+ Produkt</button>
              </div>
            </div>
            <div class="product-editor__preview" data-product-preview></div>
            <div class="product-editor__list" data-product-list></div>
            <input type="hidden" name="kassensystem_settings" value='{{ kass_settings.get(active_event.id, {"items": event_buttons.get(active_event.id, default_buttons)}) | tojson }}'>
          </div>
        </div>

        <div class="field-inline" style="margin-top:0.8rem;">
          <label class="secondary" style="padding:0.45rem 0.65rem; cursor:pointer;">
            Event-JSON importieren
            <input type="file" accept="application/json" data-import-event hidden>
          </label>
          <button type="button" class="secondary" data-export-event>Event-JSON exportieren</button>
          <span class="muted">Import ersetzt die Felder oben, JSON bleibt optional.</span>
        </div>
        <div class="form-actions" style="margin-top: 1rem;">
          <button type="submit" class="primary" data-submit-btn>Speichern</button>
          <span class="form-status" data-form-status style="margin-left: 0.8rem; color: #94a3b8; display: none;"></span>
        </div>
        <div class="form-feedback" data-form-feedback></div>
      </form>
      <form id="bg-upload-{{ active_event.id }}" method="post" action="{{ url_for('upload_background', event_id=active_event.id) }}" enctype="multipart/form-data"></form>
      <form id="bg-delete-{{ active_event.id }}" method="post" action="{{ url_for('upload_background', event_id=active_event.id) }}">
        <input type="hidden" name="delete_background" value="1">
      </form>
      <form id="pl-upload-{{ active_event.id }}" method="post" action="{{ url_for('upload_price_list_background', event_id=active_event.id) }}" enctype="multipart/form-data"></form>
      <form id="pl-delete-{{ active_event.id }}" method="post" action="{{ url_for('upload_price_list_background', event_id=active_event.id) }}">
        <input type="hidden" name="delete_price_list_background" value="1">
      </form>
    </div>
  {% endif %}
</section>

<section class="tab-panel" data-tab-panel="system">
  <div class="card">
    <div class="section-title">
      <h2>Systemeinstellungen</h2>
      <span class="pill">Netzwerk & Updates</span>
    </div>
    <div class="subsection">
      <h3>Netzwerk</h3>
      <div class="muted">LAN (eth0) und WLAN (wlan0) Schnittstellen verwalten.</div>
      <div id="network-status" style="margin-top:0.8rem;">
        <p class="muted">Lade Netzwerkinformationen...</p>
      </div>
    </div>
    <div class="subsection">
      <h3>Update</h3>
      <div class="muted">Git-Repository aktualisieren und Service neu starten.</div>
      <div id="git-status" style="margin-top:0.8rem;">
        <p class="muted">Lade Git-Informationen...</p>
      </div>
    </div>
  </div>
</section>

<section class="tab-panel" data-tab-panel="security">
  <div class="card">
    <div class="section-title">
      <h2>Sicherheit</h2>
      <span class="pill">Admin-Zugangsdaten</span>
    </div>
    <div class="subsection">
      <h3>Admin Zugangsdaten</h3>
      <div class="muted">Benutzername und Passwort für den Admin-Bereich verwalten.</div>
      <form method="post" action="{{ url_for('update_credentials') }}" data-credentials-form data-has-password="{{ 'true' if has_password else 'false' }}" style="margin-top:0.8rem;">
        <div class="stack">
          <label for="admin_username">Benutzername</label>
          <input
            id="admin_username"
            name="admin_username"
            type="text"
            value="{% if admin_username %}{{ admin_username }}{% endif %}"
            placeholder="admin"
            required
          >
          <div class="hint">Der Benutzername für die Admin-Authentifizierung.</div>
        </div>

        <div class="stack" style="margin-top: 1rem;">
          <label for="admin_password">Passwort</label>
          <input
            id="admin_password"
            name="admin_password"
            type="password"
            placeholder="Neues Passwort (mind. 8 Zeichen)"
          >
          <div class="hint">
            {% if has_password %}
              Leer lassen, um das aktuelle Passwort beizubehalten.
            {% else %}
              Setzen Sie ein Passwort, um den Admin-Bereich zu schützen.
            {% endif %}
          </div>
        </div>

        <div class="field-inline" style="margin-top: 1rem;">
          <button type="submit">Zugangsdaten speichern</button>
        </div>
        <div class="flash error" data-credentials-error style="display:none; margin-top: 1rem;"></div>

        <div class="muted" style="margin-top: 1rem;">
          <strong>Hinweis:</strong> Die Zugangsdaten werden in der Datei <code>instance/credentials.json</code> gespeichert,
          die nicht ins Git-Repository übernommen wird. {% if not has_password %}
          Solange kein Passwort gesetzt ist, ist der Admin-Bereich ohne Authentifizierung zugänglich.
          {% endif %}
        </div>
      </form>
    </div>
  </div>
</section>

<section class="tab-panel" data-tab-panel="media">
  <div class="card">
    <div class="section-title">
      <h2>Medienmanagement</h2>
      <span class="pill">Upload & Umbenennen</span>
    </div>
    <div class="subsection">
      <h3>Neue Bilder hochladen</h3>
      <div class="field-inline" style="margin-top:0.6rem;">
        <input type="file" accept="image/png,image/jpeg,image/gif,image/webp" data-media-upload>
        <button type="button" class="secondary" data-media-upload-btn>Hochladen</button>
      </div>
      <div class="muted">Erlaubte Formate: PNG, JPG, GIF, WebP. Max. 5 MB.</div>
      <div class="form-feedback" data-media-feedback></div>
    </div>
    <div class="subsection">
      <h3>Bestehende Medien</h3>
      <div class="muted">Bilder umbenennen und als Hintergrund verwenden.</div>
      <div class="media-grid" data-media-list style="margin-top:0.8rem;">
        {% if media_files %}
          {% for filename in media_files %}
            <div class="media-row" data-media-row="{{ filename }}">
              <img src="{{ url_for('uploaded_file', filename=filename) }}" alt="{{ filename }}">
              <div style="flex:1; min-width: 180px;">
                <div><strong>{{ filename }}</strong></div>
                <div class="muted">Verwendbar für Shotcounter & Preisliste</div>
              </div>
              <div class="stack" style="min-width: 200px;">
                <label>Neuer Name</label>
                <input type="text" placeholder="z.B. headerbild" data-media-rename-input value="{{ filename.rsplit('.', 1)[0] }}">
              </div>
              <button type="button" class="secondary" data-media-rename-btn>Umbenennen</button>
            </div>
          {% endfor %}
        {% else %}
          <p class="muted">Noch keine Medien hochgeladen.</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<script id="event-settings-data" type="application/json">
  {{ event_payloads | tojson }}
</script>
<script id="default-buttons-data" type="application/json">
  {{ default_buttons | tojson }}
</script>
<script id="shotcounter-defaults-data" type="application/json">
  {{ shotcounter_defaults | tojson }}
</script>
<script id="price-list-defaults-data" type="application/json">
  {{ price_list_defaults | tojson }}
</script>

<script>
  (function () {
    try {
      const fallbackColor = "#1f2a44";
      const defaultCategory = "Standard";
      const autoSaveDelay = 800;

      const getTextContent = (id) => {
        const el = document.getElementById(id);
        return el ? el.textContent : "";
      };

      const parseJson = (value, fallback) => {
        if (!value) return fallback;
        try { return JSON.parse(value); } catch (err) { return fallback; }
      };

      const eventData = parseJson(getTextContent("event-settings-data"), {});
      const defaultButtons = parseJson(getTextContent("default-buttons-data"), []);
      const shotDefaults = parseJson(
        getTextContent("shotcounter-defaults-data"),
        {
          background_color: "#0b1222",
          primary_color: "#1e293b",
          secondary_color: "#38bdf8",
          tertiary_color: "#34d399",
          title_size: 3.2,
          team_size: 1.6,
          leaderboard_limit: 10,
          leaderboard_layout: "stacked",
        }
      );

      const priceDefaults = parseJson(
        getTextContent("price-list-defaults-data"),
        {
          font_size: 1.4,
          rotation_seconds: 10,
          background_mode: "none",
          background_color: "#0b1222",
          background_image: null,
          enabled_categories: [],
        }
      );

      const initTabs = () => {
        const tabs = document.querySelectorAll(".admin-tab");
        const panels = document.querySelectorAll(".tab-panel");
        const stored = window.localStorage.getItem("admin-tab");
        const defaultTab = stored || (tabs[0] ? tabs[0].dataset.tab : "");

        const activate = (tabName) => {
          tabs.forEach((tab) => {
            const isActive = tab.dataset.tab === tabName;
            tab.setAttribute("aria-selected", isActive ? "true" : "false");
          });
          panels.forEach((panel) => {
            panel.classList.toggle("active", panel.dataset.tabPanel === tabName);
          });
          if (tabName) {
            window.localStorage.setItem("admin-tab", tabName);
          }
          if (tabName === "system") {
            loadNetworkStatus();
            loadGitStatus();
          }
        };

        tabs.forEach((tab) => {
          tab.addEventListener("click", () => activate(tab.dataset.tab));
        });

        activate(defaultTab);
      };

      const sanitizeColor = (value) => {
        if (typeof value !== "string") return fallbackColor;
        const hex = value.trim();
        return /^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})$/.test(hex) ? hex : fallbackColor;
      };

      const clampNumber = (value, fallback, min, max) => {
        const parsed = Number(value);
        if (!Number.isFinite(parsed)) return fallback;
        return Math.min(max, Math.max(min, parsed));
      };

      const normalizeItem = (item, index) => {
        const safeItem = item || {};
        const label = (safeItem.label || safeItem.name || "").trim() || "Produkt " + (index + 1);
        const name = (safeItem.name || label || "produkt-" + (index + 1)).trim();
        const price = Number.isFinite(Number(safeItem.price)) ? Number(safeItem.price) : 0;
        return {
          name,
          label,
          price,
          css_class: safeItem.css_class || "custom",
          color: sanitizeColor(safeItem.color || ""),
          category: safeItem.category || defaultCategory,
          show_in_kassensystem: safeItem.show_in_kassensystem !== false,
          show_in_price_list: safeItem.show_in_price_list !== false,
        };
      };

      const setFeedback = (form, message, type) => {
        const box = form.querySelector("[data-form-feedback]");
        if (!box) return;
        if (!message) {
          box.textContent = "";
          box.classList.remove("error", "success");
          box.style.display = "none";
          return;
        }
        box.textContent = message;
        box.classList.remove("error", "success");
        box.classList.add(type === "error" ? "error" : "success");
        box.style.display = "block";
      };

      const setFormStatus = (form, message, color) => {
        const statusEl = form.querySelector("[data-form-status]");
        if (!statusEl) return;
        statusEl.style.display = "inline";
        statusEl.style.color = color || "#94a3b8";
        statusEl.textContent = message;
      };

      const collectSharedSettings = (form) => {
        const sharedInput = form.querySelector('input[name="shared_settings"]');
        if (!sharedInput) return;
        const currentSettings = parseJson(sharedInput.value, {});
        const autoReloadCheckbox = form.querySelector('input[name="auto_reload_on_add"]');
        if (autoReloadCheckbox) {
          currentSettings.auto_reload_on_add = autoReloadCheckbox.checked;
        }
        const priceSettingsWrapper = form.querySelector("[data-price-settings]");
        if (priceSettingsWrapper && priceSettingsWrapper.priceSettingsApi) {
          currentSettings.price_list = priceSettingsWrapper.priceSettingsApi.getSettings();
        }
        sharedInput.value = JSON.stringify(currentSettings);
      };

      const validateEventForm = (form) => {
        const productEditor = form.querySelector("[data-product-editor]");
        if (productEditor && productEditor.productApi) {
          const settings = productEditor.productApi.getSettings();
          const items = settings.items || [];
          const names = items.map(item => item.name);
          const duplicates = names.filter((name, index) => names.indexOf(name) !== index);
          if (duplicates.length > 0) {
            return `Doppelte Produktnamen gefunden: ${duplicates.join(', ')}`;
          }
        }

        const priceSettingsWrapper = form.querySelector("[data-price-settings]");
        if (priceSettingsWrapper && priceSettingsWrapper.priceSettingsApi) {
          const priceSettings = priceSettingsWrapper.priceSettingsApi.getSettings();
          if (!priceSettings.enabled_categories || priceSettings.enabled_categories.length === 0) {
            return "Mindestens eine Preisliste-Kategorie aktivieren.";
          }
        }
        return null;
      };

      const submitForm = async (form) => {
        collectSharedSettings(form);
        const error = validateEventForm(form);
        if (error) {
          setFormStatus(form, `Fehler: ${error}`, "#ef4444");
          setFeedback(form, error, "error");
          return false;
        }

        setFormStatus(form, "Speichere...", "#94a3b8");
        setFeedback(form, "", "success");

        try {
          const response = await fetch(form.action, {
            method: form.method || "POST",
            body: new FormData(form),
            headers: {
              "X-Requested-With": "XMLHttpRequest",
            },
          });
          if (!response.ok) {
            const text = await response.text();
            const message = `Speichern fehlgeschlagen (${response.status}). ${text.slice(0, 200)}`;
            setFormStatus(form, message, "#ef4444");
            setFeedback(form, "Speichern fehlgeschlagen. Bitte Eingaben prüfen.", "error");
            return false;
          }
          setFormStatus(form, "Gespeichert", "#10b981");
          setFeedback(form, "Änderungen wurden gespeichert.", "success");
          return true;
        } catch (err) {
          setFormStatus(form, "Speichern fehlgeschlagen", "#ef4444");
          setFeedback(form, "Speichern fehlgeschlagen. Bitte erneut versuchen.", "error");
          return false;
        }
      };

      const bindAutoSave = (form) => {
        if (!form.dataset.autoSave) return;
        let timer = null;
        const schedule = () => {
          clearTimeout(timer);
          timer = setTimeout(() => submitForm(form), autoSaveDelay);
        };
        form.addEventListener("product-editor:change", schedule);
        form.addEventListener("input", (event) => {
          if (event.target && event.target.type === "file") return;
          schedule();
        });
        form.addEventListener("change", (event) => {
          if (event.target && event.target.type === "file") return;
          schedule();
        });

        form.addEventListener("submit", (event) => {
          event.preventDefault();
          submitForm(form);
        });
      };

      // Shotcounter-Settings
      document.querySelectorAll("[data-shot-settings]").forEach((wrapper) => {
        const hidden = wrapper.querySelector('input[name="shotcounter_settings"]');
        const defaults = { ...shotDefaults, ...parseJson(wrapper.dataset.defaults, shotDefaults) };
        const current = parseJson(wrapper.dataset.current, {});
        let settings = { ...defaults, ...current };

        const preview = wrapper.querySelector("[data-shot-preview]");

        const syncPreview = () => {
          if (!preview) return;
          if (settings.background_image) {
            preview.src = `/uploads/${settings.background_image}`;
            preview.style.display = "block";
          } else {
            preview.removeAttribute("src");
            preview.style.display = "none";
          }
        };

        const syncInputs = () => {
          wrapper.querySelectorAll("[data-shot-field]").forEach((input) => {
            const key = input.dataset.shotField;
            if (!key) return;
            if (input.type === "color") {
              input.value = sanitizeColor(settings[key] || defaults[key] || fallbackColor);
            } else if (input.type === "number") {
              input.value = settings[key] ?? defaults[key] ?? "";
            } else if (input.tagName === "SELECT") {
              input.value = settings[key] ?? "";
            }
          });
          syncPreview();
        };

        const syncHidden = () => {
          if (hidden) hidden.value = JSON.stringify(settings);
        };

        wrapper.querySelectorAll("[data-shot-field]").forEach((input) => {
          const key = input.dataset.shotField;
          if (!key) return;
          input.addEventListener("input", () => {
            if (input.type === "color") {
              settings[key] = sanitizeColor(input.value || defaults[key] || fallbackColor);
            } else if (input.type === "number") {
              const min = key === "leaderboard_limit" ? 1 : 0.5;
              const max = key === "leaderboard_limit" ? 50 : 10;
              settings[key] = clampNumber(input.value, defaults[key], min, max);
            } else if (input.tagName === "SELECT") {
              settings[key] = input.value || null;
            }
            syncHidden();
            syncPreview();
          });
        });

        wrapper.shotSettingsApi = {
          getSettings: () => ({ ...settings }),
          setSettings: (data) => {
            settings = { ...defaults, ...(data || {}) };
            syncInputs();
            syncHidden();
          },
        };

        syncInputs();
        syncHidden();
      });

      // Produkt-Editor
      document.querySelectorAll("[data-product-editor]").forEach((wrapper) => {
        const addButton = wrapper.querySelector("[data-add-product]");
        const preview = wrapper.querySelector("[data-product-preview]");
        const list = wrapper.querySelector("[data-product-list]");
        const hidden = wrapper.querySelector('input[name="kassensystem_settings"]');
        const importInput = wrapper.querySelector("[data-product-import]");
        const exportButton = wrapper.querySelector("[data-product-export]");

        let baseSettings = {};
        try { baseSettings = JSON.parse(hidden.value || "{}"); } catch (err) { baseSettings = {}; }

        let parsedItems = [];
        try { parsedItems = JSON.parse(wrapper.dataset.items || "[]"); } catch (err) { parsedItems = []; }

        let items = Array.isArray(parsedItems) ? parsedItems.map(normalizeItem) : [];
        if (!items.length) {
          items = [normalizeItem({ name: "Produkt", label: "Neues Produkt", price: 0, color: fallbackColor }, 0)];
        }

        const syncHidden = () => {
          hidden.value = JSON.stringify({ ...baseSettings, items });
          const categories = getAllCategories();
          wrapper.dispatchEvent(new CustomEvent("product-editor:change", { detail: { categories }, bubbles: true }));
        };

        const renderPreview = () => {
          preview.innerHTML = "";
          let dragIndex = null;

          items.forEach((item, index) => {
            const card = document.createElement("div");
            card.className = "product-preview-card";
            if (!item.show_in_kassensystem) {
              card.classList.add("is-muted");
            }
            card.draggable = true;
            card.style.background = sanitizeColor(item.color);
            card.dataset.index = index;
            const visibility = !item.show_in_kassensystem ? "<small>Ausgeblendet in Kasse</small>" : "";
            card.innerHTML = `<small>${item.price} CHF</small><div style="font-weight:700;">${item.label}</div>${visibility}`;

            card.addEventListener("dragstart", () => {
              dragIndex = index;
              card.classList.add("dragging");
            });
            card.addEventListener("dragend", () => card.classList.remove("dragging"));
            card.addEventListener("dragover", (ev) => {
              ev.preventDefault();
              card.classList.add("drag-over");
            });
            card.addEventListener("dragleave", () => card.classList.remove("drag-over"));
            card.addEventListener("drop", (ev) => {
              ev.preventDefault();
              card.classList.remove("drag-over");
              const targetIndex = Number(card.dataset.index);
              if (Number.isNaN(targetIndex) || dragIndex === null || dragIndex === targetIndex) {
                return;
              }
              const [moved] = items.splice(dragIndex, 1);
              items.splice(targetIndex, 0, moved);
              renderList();
              renderPreview();
              syncHidden();
            });

            preview.appendChild(card);
          });
        };

        const getAllCategories = () => {
          const categories = new Set();
          items.forEach(item => {
            if (item.show_in_price_list && item.category && item.category.trim()) {
              categories.add(item.category.trim());
            }
          });
          if (!categories.size) {
            categories.add(defaultCategory);
          }
          return Array.from(categories).sort();
        };

        const renderList = () => {
          list.innerHTML = "";

          const datalistId = `categories-datalist-${wrapper.dataset.scope || Date.now()}`;
          const datalist = document.createElement("datalist");
          datalist.id = datalistId;

          const categories = getAllCategories();
          categories.forEach(cat => {
            const option = document.createElement("option");
            option.value = cat;
            datalist.appendChild(option);
          });
          list.appendChild(datalist);

          items.forEach((item, index) => {
            const row = document.createElement("div");
            row.className = "product-row";

            const nameContainer = document.createElement("div");
            nameContainer.className = "stack";
            const nameLabel = document.createElement("label");
            nameLabel.textContent = "Schlüssel (interner Name)";
            const nameInput = document.createElement("input");
            nameInput.value = item.name;
            nameInput.placeholder = "unique-key";
            nameInput.addEventListener("input", () => {
              item.name = nameInput.value.trim();
              syncHidden();
            });
            nameContainer.append(nameLabel, nameInput);

            const labelContainer = document.createElement("div");
            labelContainer.className = "stack";
            const labelLabel = document.createElement("label");
            labelLabel.textContent = "Titel (Anzeige)";
            const labelInput = document.createElement("input");
            labelInput.value = item.label;
            labelInput.placeholder = "z.B. Bier";
            labelInput.addEventListener("input", () => {
              item.label = labelInput.value;
              if (!item.name.trim()) {
                item.name = labelInput.value;
                nameInput.value = item.name;
              }
              renderPreview();
              syncHidden();
            });
            labelContainer.append(labelLabel, labelInput);

            const priceContainer = document.createElement("div");
            priceContainer.className = "stack";
            const priceLabel = document.createElement("label");
            priceLabel.textContent = "Preis (CHF)";
            const priceInput = document.createElement("input");
            priceInput.type = "number";
            priceInput.step = "1";
            priceInput.value = item.price;
            priceInput.addEventListener("input", () => {
              const parsed = Number(priceInput.value);
              item.price = Number.isFinite(parsed) ? parsed : 0;
              renderPreview();
              syncHidden();
            });
            priceContainer.append(priceLabel, priceInput);

            const colorContainer = document.createElement("div");
            colorContainer.className = "stack";
            const colorLabel = document.createElement("label");
            colorLabel.textContent = "Hintergrundfarbe";
            const colorInput = document.createElement("input");
            colorInput.type = "color";
            colorInput.className = "color-input";
            colorInput.value = sanitizeColor(item.color);
            colorInput.addEventListener("input", () => {
              item.color = sanitizeColor(colorInput.value);
              renderPreview();
              syncHidden();
            });
            colorContainer.append(colorLabel, colorInput);

            const categoryContainer = document.createElement("div");
            categoryContainer.className = "stack";
            const categoryLabel = document.createElement("label");
            categoryLabel.textContent = "Kategorie";
            const categoryInput = document.createElement("input");
            categoryInput.setAttribute("list", datalistId);
            categoryInput.value = item.category || defaultCategory;
            categoryInput.placeholder = "Wählen oder neue Kategorie eingeben";
            categoryInput.addEventListener("input", () => {
              item.category = categoryInput.value.trim() || defaultCategory;
              syncHidden();
            });
            categoryInput.addEventListener("change", () => {
              const newCategory = categoryInput.value.trim() || defaultCategory;
              item.category = newCategory;
              syncHidden();
              renderList();
            });
            categoryContainer.append(categoryLabel, categoryInput);

            const visibilityContainer = document.createElement("div");
            visibilityContainer.className = "stack";
            const visibilityLabel = document.createElement("label");
            visibilityLabel.textContent = "Sichtbarkeit";
            const visibilityGroup = document.createElement("div");
            visibilityGroup.className = "product-visibility";
            const kassLabel = document.createElement("label");
            const kassCheckbox = document.createElement("input");
            kassCheckbox.type = "checkbox";
            kassCheckbox.checked = item.show_in_kassensystem !== false;
            kassCheckbox.addEventListener("change", () => {
              item.show_in_kassensystem = kassCheckbox.checked;
              renderPreview();
              syncHidden();
            });
            kassLabel.append(kassCheckbox, document.createTextNode("Kassensystem"));
            const priceLabelToggle = document.createElement("label");
            const priceCheckbox = document.createElement("input");
            priceCheckbox.type = "checkbox";
            priceCheckbox.checked = item.show_in_price_list !== false;
            priceCheckbox.addEventListener("change", () => {
              item.show_in_price_list = priceCheckbox.checked;
              syncHidden();
              renderList();
            });
            priceLabelToggle.append(priceCheckbox, document.createTextNode("Preisliste"));
            visibilityGroup.append(kassLabel, priceLabelToggle);
            visibilityContainer.append(visibilityLabel, visibilityGroup);

            const actions = document.createElement("div");
            actions.className = "row-actions";
            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "danger";
            removeBtn.textContent = "Entfernen";
            removeBtn.addEventListener("click", () => {
              items.splice(index, 1);
              if (!items.length) {
                items.push(normalizeItem({ name: "produkt", label: "Produkt", price: 0, color: fallbackColor }, 0));
              }
              renderList();
              renderPreview();
              syncHidden();
            });
            actions.appendChild(removeBtn);

            row.append(labelContainer, nameContainer, priceContainer, colorContainer, categoryContainer, visibilityContainer, actions);
            list.appendChild(row);
          });
        };

        if (addButton) {
          addButton.addEventListener("click", () => {
            items.push(
              normalizeItem(
                {
                  name: "produkt-" + Date.now(),
                  label: "Neues Produkt",
                  price: 0,
                  color: fallbackColor,
                },
                items.length
              )
            );
            renderList();
            renderPreview();
            syncHidden();
          });
        }

        if (importInput) {
          importInput.addEventListener("change", (ev) => {
            const file = ev.target.files && ev.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
              const data = parseJson(reader.result, {});
              const importedItems = Array.isArray(data && data.items) ? data.items : Array.isArray(data) ? data : [];
              baseSettings = data && typeof data === "object" && !Array.isArray(data) ? { ...data } : {};
              items = (importedItems || []).map((it, idx) => normalizeItem(it, idx));
              if (!items.length) items = [normalizeItem({ name: "Produkt", label: "Neues Produkt", price: 0, color: fallbackColor }, 0)];
              renderList();
              renderPreview();
              syncHidden();
            };
            reader.readAsText(file);
          });
        }

        if (exportButton) {
          exportButton.addEventListener("click", () => {
            const blob = new Blob([hidden.value || "{}"], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "produkte.json";
            a.click();
            URL.revokeObjectURL(url);
          });
        }

        wrapper.productApi = {
          getSettings: () => parseJson(hidden.value, { items: items }),
          setSettings: (data) => {
            const importedItems = Array.isArray(data && data.items) ? data.items : [];
            baseSettings = data && typeof data === "object" && !Array.isArray(data) ? { ...data } : {};
            items = importedItems.length ? importedItems.map((it, idx) => normalizeItem(it, idx)) : [normalizeItem({ name: "Produkt", label: "Produkt", price: 0, color: fallbackColor }, 0)];
            renderList();
            renderPreview();
            syncHidden();
          },
        };

        renderList();
        renderPreview();
        syncHidden();
      });

      // Preisliste-Settings
      document.querySelectorAll("[data-price-settings]").forEach((wrapper) => {
        const form = wrapper.closest("form");
        const sharedInput = form ? form.querySelector('input[name="shared_settings"]') : null;
        const productEditor = form ? form.querySelector("[data-product-editor]") : null;
        const defaults = { ...priceDefaults, ...parseJson(wrapper.dataset.defaults, priceDefaults) };
        const current = parseJson(wrapper.dataset.current, {});

        let shared = parseJson(sharedInput ? sharedInput.value : "", {});
        let settings = { ...defaults, ...(shared.price_list || current) };

        const normalizeSettings = (data) => {
          const next = { ...defaults, ...(data || {}) };
          next.font_size = clampNumber(next.font_size, defaults.font_size, 0.6, 6);
          next.rotation_seconds = clampNumber(next.rotation_seconds, defaults.rotation_seconds, 2, 120);
          next.background_mode = ["none", "custom"].includes(next.background_mode) ? next.background_mode : defaults.background_mode;
          next.background_color = sanitizeColor(next.background_color || defaults.background_color || fallbackColor);
          next.enabled_categories = Array.isArray(next.enabled_categories)
            ? next.enabled_categories.filter((name) => typeof name === "string" && name.trim())
            : [];
          return next;
        };

        const getItemsFromEditor = () => {
          if (productEditor && productEditor.productApi) {
            const settings = productEditor.productApi.getSettings();
            return Array.isArray(settings.items) ? settings.items : [];
          }
          const fallback = form ? form.querySelector('input[name="kassensystem_settings"]') : null;
          const parsed = parseJson(fallback ? fallback.value : "", {});
          return Array.isArray(parsed.items) ? parsed.items : [];
        };

        const getCategories = () => {
          const items = getItemsFromEditor();
          const categories = new Set();
          items.forEach((item) => {
            if (item.show_in_price_list === false) {
              return;
            }
            const category = (item.category || defaultCategory).toString().trim();
            if (category) categories.add(category);
          });
          if (!categories.size) {
            categories.add(defaultCategory);
          }
          return Array.from(categories);
        };

        const updateShared = () => {
          if (!sharedInput) return;
          shared = parseJson(sharedInput.value, {});
          shared.price_list = settings;
          sharedInput.value = JSON.stringify(shared);
        };

        const errorEl = wrapper.querySelector("[data-price-error]");
        const customBg = wrapper.querySelector("[data-price-custom-bg]");
        const imageSelect = wrapper.querySelector("[data-price-image-select]");
        const imagePreview = wrapper.querySelector("[data-price-image-preview]");

        const syncInputs = () => {
          wrapper.querySelectorAll("[data-price-field]").forEach((input) => {
            const key = input.dataset.priceField;
            if (!key) return;
            if (input.type === "number") {
              input.value = settings[key] ?? defaults[key] ?? "";
            } else if (input.type === "color") {
              input.value = sanitizeColor(settings[key] || defaults[key] || fallbackColor);
            } else if (input.tagName === "SELECT") {
              input.value = settings[key] ?? defaults[key] ?? "";
            }
          });
          if (customBg) {
            customBg.style.display = "block";
          }
          if (imageSelect) {
            imageSelect.value = settings.background_image || "";
          }
          if (imagePreview) {
            if (settings.background_image) {
              imagePreview.src = `/uploads/${settings.background_image}`;
              imagePreview.style.display = "block";
            } else {
              imagePreview.removeAttribute("src");
              imagePreview.style.display = "none";
            }
          }
        };

        const renderCategories = () => {
          const container = wrapper.querySelector("[data-price-categories]");
          if (!container) return;
          const categories = getCategories();
          const enabledRaw = settings.enabled_categories.length ? settings.enabled_categories : categories;
          const enabled = enabledRaw.filter((name) => categories.includes(name));
          settings.enabled_categories = enabled;
          container.innerHTML = "";

          categories.forEach((name) => {
            const label = document.createElement("label");
            label.style.display = "inline-flex";
            label.style.alignItems = "center";
            label.style.gap = "0.4rem";
            label.style.marginRight = "0.8rem";
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = enabled.includes(name);
            checkbox.addEventListener("change", () => {
              const selected = Array.from(container.querySelectorAll("input[type='checkbox']"))
                .filter((el) => el.checked)
                .map((el) => el.dataset.category || "")
                .filter(Boolean);

              settings.enabled_categories = selected;
              if (errorEl) {
                if (!selected.length) {
                  errorEl.textContent = "Mindestens eine Kategorie aktivieren.";
                  errorEl.style.display = "block";
                } else {
                  errorEl.textContent = "";
                  errorEl.style.display = "none";
                }
              }
              updateShared();
            });
            checkbox.dataset.category = name;
            label.appendChild(checkbox);
            const span = document.createElement("span");
            span.textContent = name;
            label.appendChild(span);
            container.appendChild(label);
          });

          if (errorEl && !settings.enabled_categories.length) {
            errorEl.textContent = "Mindestens eine Kategorie aktivieren.";
            errorEl.style.display = "block";
          }
        };

        wrapper.querySelectorAll("[data-price-field]").forEach((input) => {
          const key = input.dataset.priceField;
          if (!key) return;
          input.addEventListener("input", () => {
            if (input.type === "number") {
              settings[key] = clampNumber(input.value, defaults[key], key === "rotation_seconds" ? 2 : 0.6, key === "rotation_seconds" ? 120 : 6);
            } else if (input.type === "color") {
              settings[key] = sanitizeColor(input.value || defaults[key] || fallbackColor);
            } else if (input.tagName === "SELECT") {
              settings[key] = input.value;
            }
            settings = normalizeSettings(settings);
            syncInputs();
            updateShared();
          });
        });

        if (imageSelect) {
          imageSelect.addEventListener("change", () => {
            const selected = imageSelect.value || "";
            settings.background_image = selected || null;
            if (selected) {
              settings.background_mode = "custom";
            }
            settings = normalizeSettings(settings);
            syncInputs();
            updateShared();
          });
        }

        if (productEditor) {
          productEditor.addEventListener("product-editor:change", () => {
            renderCategories();
            updateShared();
          });
        }

        wrapper.priceSettingsApi = {
          getSettings: () => ({ ...settings }),
          setSettings: (data) => {
            settings = normalizeSettings(data);
            syncInputs();
            renderCategories();
            updateShared();
          },
        };

        settings = normalizeSettings(settings);
        syncInputs();
        renderCategories();
        updateShared();
      });

      const collectSnapshot = (form) => {
        const sharedInput = form.querySelector('input[name="shared_settings"]');
        const shotInput = form.querySelector('input[name="shotcounter_settings"]');
        const productEditor = form.querySelector("[data-product-editor]");
        const shotSettingsWrapper = form.querySelector("[data-shot-settings]");
        return {
          kassensystem_enabled: Boolean((form.querySelector('[name="kassensystem_enabled"]') || {}).checked),
          shotcounter_enabled: Boolean((form.querySelector('[name="shotcounter_enabled"]') || {}).checked),
          shared_settings: parseJson(sharedInput ? sharedInput.value : "", {}),
          shotcounter_settings:
            (shotSettingsWrapper && shotSettingsWrapper.shotSettingsApi && shotSettingsWrapper.shotSettingsApi.getSettings()) ||
            parseJson(shotInput ? shotInput.value : "", {}),
          kassensystem_settings:
            (productEditor && productEditor.productApi && productEditor.productApi.getSettings()) ||
            parseJson((form.querySelector('input[name="kassensystem_settings"]') || {}).value, {}),
        };
      };

      const applySnapshot = (form, snapshot) => {
        const kassCheck = form.querySelector('[name="kassensystem_enabled"]');
        const shotCheck = form.querySelector('[name="shotcounter_enabled"]');
        if (kassCheck) kassCheck.checked = Boolean(snapshot.kassensystem_enabled);
        if (shotCheck) shotCheck.checked = Boolean(snapshot.shotcounter_enabled);

        const sharedHidden = form.querySelector('input[name="shared_settings"]');
        const shotHidden = form.querySelector('input[name="shotcounter_settings"]');
        const priceSettingsWrapper = form.querySelector("[data-price-settings]");
        if (sharedHidden) sharedHidden.value = JSON.stringify(snapshot.shared_settings || {});
        if (shotHidden) shotHidden.value = JSON.stringify(snapshot.shotcounter_settings || {});

        const autoReloadCheckbox = form.querySelector('input[name="auto_reload_on_add"]');
        if (autoReloadCheckbox && snapshot.shared_settings) {
          autoReloadCheckbox.checked = snapshot.shared_settings.auto_reload_on_add !== false;
        }

        const productEditor = form.querySelector("[data-product-editor]");
        const kassInput = form.querySelector('input[name="kassensystem_settings"]');
        const shotSettingsWrapper = form.querySelector("[data-shot-settings]");
        if (shotSettingsWrapper && shotSettingsWrapper.shotSettingsApi) {
          shotSettingsWrapper.shotSettingsApi.setSettings(snapshot.shotcounter_settings || {});
        }
        if (priceSettingsWrapper && priceSettingsWrapper.priceSettingsApi) {
          const shared = snapshot.shared_settings || {};
          priceSettingsWrapper.priceSettingsApi.setSettings(shared.price_list || {});
        }
        if (productEditor && productEditor.productApi) {
          productEditor.productApi.setSettings(snapshot.kassensystem_settings || { items: defaultButtons });
        } else if (kassInput) {
          kassInput.value = JSON.stringify(snapshot.kassensystem_settings || { items: defaultButtons });
        }
      };

      const bindCopyAndImport = (form) => {
        const select = form.querySelector("[data-copy-select]");
        const copyBtn = form.querySelector("[data-copy-btn]");
        const importTrigger = form.querySelector("[data-import-event]");
        const exportBtn = form.querySelector("[data-export-event]");

        if (copyBtn) {
          copyBtn.addEventListener("click", () => {
            const selectedId = select ? select.value : null;
            if (!selectedId || !eventData[selectedId]) return;
            applySnapshot(form, eventData[selectedId]);
            if (form.dataset.autoSave) {
              submitForm(form);
            }
          });
        }

        if (exportBtn) {
          exportBtn.addEventListener("click", () => {
            const data = collectSnapshot(form);
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "event-settings.json";
            a.click();
            URL.revokeObjectURL(url);
          });
        }

        if (importTrigger) {
          importTrigger.addEventListener("change", (ev) => {
            const file = ev.target.files && ev.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
              const data = parseJson(reader.result, null);
              if (!data) return;
              applySnapshot(form, {
                kassensystem_enabled: data.kassensystem_enabled !== undefined ? data.kassensystem_enabled : true,
                shotcounter_enabled: data.shotcounter_enabled !== undefined ? data.shotcounter_enabled : true,
                shared_settings: data.shared_settings || {},
                shotcounter_settings: data.shotcounter_settings || {},
                kassensystem_settings: data.kassensystem_settings || { items: defaultButtons },
              });
              if (form.dataset.autoSave) {
                submitForm(form);
              }
            };
            reader.readAsText(file);
          });
        }
      };

      document.querySelectorAll("[data-event-form]").forEach((form) => {
        bindCopyAndImport(form);
        bindAutoSave(form);

        if (!form.dataset.autoSave) {
          form.addEventListener('submit', function() {
            collectSharedSettings(form);
          });
        }
      });

      const credentialsForm = document.querySelector("[data-credentials-form]");
      if (credentialsForm) {
        const errorBox = credentialsForm.querySelector("[data-credentials-error]");
        const usernameInput = credentialsForm.querySelector("#admin_username");
        const passwordInput = credentialsForm.querySelector("#admin_password");
        const hasPassword = credentialsForm.dataset.hasPassword === "true";

        const showError = (message) => {
          if (!errorBox) return;
          errorBox.textContent = message;
          errorBox.style.display = "block";
        };

        const clearError = () => {
          if (!errorBox) return;
          errorBox.textContent = "";
          errorBox.style.display = "none";
        };

        credentialsForm.addEventListener("submit", (event) => {
          const username = usernameInput ? usernameInput.value.trim() : "";
          const password = passwordInput ? passwordInput.value : "";

          if (!username) {
            event.preventDefault();
            showError("Benutzername darf nicht leer sein.");
            return;
          }

          if (!hasPassword && !password) {
            event.preventDefault();
            showError("Bitte ein Passwort setzen, damit der Admin-Bereich geschützt ist.");
            return;
          }

          if (password && password.length < 8) {
            event.preventDefault();
            showError("Passwort muss mindestens 8 Zeichen lang sein.");
            return;
          }

          clearError();
        });
      }

      initTabs();
    } catch (err) {
      console.error("Admin UI Init Error", err);
      document.querySelectorAll(".tab-panel").forEach((panel) => {
        panel.classList.add("active");
      });
    }

    async function loadNetworkStatus() {
      const container = document.getElementById('network-status');
      if (!container) return;

      try {
        const response = await fetch('/admin/network');
        const data = await response.json();

        let html = '<div style="display: grid; gap: 1.5rem;">';

        html += '<div class="stack">';
        html += '<h3 style="margin: 0; color: #cbd5e1;">LAN Interface (eth0)</h3>';
        if (data.eth0.exists) {
          html += '<div style="background: rgba(255,255,255,0.04); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">';
          html += `<div class="field-inline" style="margin-bottom: 0.5rem;"><strong>IP-Adresse:</strong> <span>${data.eth0.ip || 'N/A'}</span></div>`;
          html += `<div class="field-inline" style="margin-bottom: 0.5rem;"><strong>Subnetzmaske:</strong> <span>${data.eth0.netmask || 'N/A'}</span></div>`;
          html += `<div class="field-inline"><strong>Status:</strong> <span class="badge ${data.eth0.status === 'up' ? 'badge-green' : 'badge-red'}">${data.eth0.status}</span></div>`;
          html += '</div>';
        } else {
          html += '<p class="muted">Interface nicht gefunden</p>';
        }
        html += '</div>';

        html += '<div class="stack">';
        html += '<h3 style="margin: 0; color: #cbd5e1;">WLAN Interface (wlan0)</h3>';
        if (data.wlan0.exists) {
          html += '<div style="background: rgba(255,255,255,0.04); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">';
          html += `<div class="field-inline" style="margin-bottom: 0.5rem;"><strong>IP-Adresse:</strong> <span>${data.wlan0.ip || 'Nicht verbunden'}</span></div>`;
          html += `<div class="field-inline" style="margin-bottom: 0.5rem;"><strong>SSID:</strong> <span>${data.wlan0.ssid || 'Nicht verbunden'}</span></div>`;
          if (data.wlan0.signal_level) {
            html += `<div class="field-inline" style="margin-bottom: 0.5rem;"><strong>Signalstärke:</strong> <span>${data.wlan0.signal_level}</span></div>`;
          }
          html += `<div class="field-inline"><strong>Status:</strong> <span class="badge ${data.wlan0.status === 'up' ? 'badge-green' : 'badge-red'}">${data.wlan0.status}</span></div>`;
          html += '</div>';

          html += '<div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.02); border: 1px dashed var(--border); border-radius: 8px;">';
          html += '<h4 style="margin: 0 0 0.8rem 0;">Neues WLAN verbinden</h4>';
          html += '<form id="wifi-connect-form">';
          html += '<div class="stack" style="margin-bottom: 0.8rem;">';
          html += '<label>SSID (Netzwerkname)</label>';
          html += '<input type="text" name="ssid" required placeholder="Netzwerkname eingeben">';
          html += '</div>';
          html += '<div class="stack" style="margin-bottom: 0.8rem;">';
          html += '<label>Passwort</label>';
          html += '<input type="password" name="password" placeholder="Passwort (min. 8 Zeichen)">';
          html += '</div>';
          html += '<div class="field-inline">';
          html += '<button type="submit">Verbinden</button>';
          html += '<button type="button" onclick="scanWifi()" class="secondary">Netzwerke scannen</button>';
          html += '</div>';
          html += '<div id="wifi-connect-message" style="margin-top: 0.8rem;"></div>';
          html += '</form>';
          html += '<div id="wifi-scan-results" style="margin-top: 1rem;"></div>';
          html += '</div>';
        } else {
          html += '<p class="muted">Interface nicht gefunden</p>';
        }
        html += '</div>';

        html += '<div class="stack">';
        html += '<h3 style="margin: 0; color: #cbd5e1;">Verbundene Clients (DHCP)</h3>';
        if (data.dhcp_leases && data.dhcp_leases.length > 0) {
          html += '<div style="background: rgba(255,255,255,0.04); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">';
          html += '<table style="width: 100%; border-collapse: collapse;">';
          html += '<thead><tr style="border-bottom: 1px solid var(--border);"><th style="text-align: left; padding: 0.5rem;">IP</th><th style="text-align: left; padding: 0.5rem;">MAC</th><th style="text-align: left; padding: 0.5rem;">Hostname</th></tr></thead>';
          html += '<tbody>';
          data.dhcp_leases.forEach(lease => {
            html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);"><td style="padding: 0.5rem;">${lease.ip}</td><td style="padding: 0.5rem; font-family: monospace;">${lease.mac}</td><td style="padding: 0.5rem;">${lease.hostname}</td></tr>`;
          });
          html += '</tbody></table>';
          html += '</div>';
        } else {
          html += '<p class="muted">Keine verbundenen Clients</p>';
        }
        html += '</div>';

        html += '</div>';

        container.innerHTML = html;

        const wifiForm = document.getElementById('wifi-connect-form');
        if (wifiForm) {
          wifiForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const messageDiv = document.getElementById('wifi-connect-message');
            messageDiv.innerHTML = '<p class="muted">Verbinde...</p>';

            try {
              const response = await fetch('/admin/network/wifi/connect', {
                method: 'POST',
                body: formData
              });
              const result = await response.json();

              if (result.success) {
                messageDiv.innerHTML = `<p style="color: #10b981;">${result.message}</p>`;
                setTimeout(() => loadNetworkStatus(), 5000);
              } else {
                messageDiv.innerHTML = `<p style="color: #ef4444;">Fehler: ${result.error}</p>`;
              }
            } catch (error) {
              messageDiv.innerHTML = `<p style="color: #ef4444;">Fehler: ${error.message}</p>`;
            }
          });
        }
      } catch (error) {
        container.innerHTML = `<p style="color: #ef4444;">Fehler beim Laden: ${error.message}</p>`;
      }
    }

    window.scanWifi = async () => {
      const resultsDiv = document.getElementById('wifi-scan-results');
      if (!resultsDiv) return;

      resultsDiv.innerHTML = '<p class="muted">Scanne nach Netzwerken...</p>';

      try {
        const response = await fetch('/admin/network/wifi/scan');
        const data = await response.json();

        if (data.success && data.networks.length > 0) {
          let html = '<h4 style="margin: 0.8rem 0;">Verfügbare Netzwerke</h4>';
          html += '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
          data.networks.forEach(network => {
            const escapedSsid = network.ssid.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const ssidForJs = network.ssid.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
            html += `<div style="padding: 0.6rem; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;" onclick="document.querySelector('input[name=ssid]').value='${ssidForJs}'">`;
            html += `<div style="display: flex; justify-content: space-between; align-items: center;">`;
            html += `<strong>${escapedSsid}</strong>`;
            html += `<div style="display: flex; gap: 0.5rem; align-items: center;">`;
            html += `<span class="pill">${network.encryption}</span>`;
            html += `<span class="muted" style="font-size: 0.85rem;">${network.quality}%</span>`;
            html += `</div></div></div>`;
          });
          html += '</div>';
          resultsDiv.innerHTML = html;
        } else {
          resultsDiv.innerHTML = '<p class="muted">Keine Netzwerke gefunden</p>';
        }
      } catch (error) {
        resultsDiv.innerHTML = `<p style="color: #ef4444;">Fehler: ${error.message}</p>`;
      }
    };

    async function loadGitStatus() {
      const container = document.getElementById('git-status');
      if (!container) return;

      try {
        const response = await fetch('/admin/system/git-status');
        let data;
        const ct = (response.headers.get('content-type') || '').toLowerCase();
        if (ct.includes('application/json')) {
          data = await response.json();
        } else {
          const text = await response.text();
          throw new Error(`Unerwartete Server-Antwort: ${text}`);
        }

        let html = '<div class="stack">';
        html += '<div style="background: rgba(255,255,255,0.04); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">';
        html += `<div class="field-inline" style="margin-bottom: 0.5rem;"><strong>Branch:</strong> <span>${data.branch || 'N/A'}</span></div>`;
        html += `<div class="field-inline" style="margin-bottom: 0.5rem;"><strong>Commit:</strong> <span style="font-family: monospace;">${data.commit_short || 'N/A'}</span></div>`;
        html += `<div class="field-inline" style="margin-bottom: 0.5rem;"><strong>Nicht committete Änderungen:</strong> <span class="badge ${data.has_changes ? 'badge-red' : 'badge-green'}">${data.has_changes ? 'Ja' : 'Nein'}</span></div>`;

        if (data.behind > 0) {
          html += `<div class="field-inline"><strong>Status:</strong> <span class="badge badge-yellow">${data.behind} Commit(s) hinter Remote</span></div>`;
        } else {
          html += `<div class="field-inline"><strong>Status:</strong> <span class="badge badge-green">Aktuell</span></div>`;
        }
        html += '</div>';

        html += '<div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.02); border: 1px dashed var(--border); border-radius: 8px;">';
        html += '<h4 style="margin: 0 0 0.8rem 0;">Repository aktualisieren</h4>';
        html += '<p class="muted" style="margin-bottom: 0.8rem;">Lädt die neueste Version vom Git-Repository und startet den Service neu.</p>';

        if (data.has_changes) {
          html += '<p style="color: #f59e0b; margin-bottom: 0.8rem;"><strong>⚠️ Warnung:</strong> Es gibt nicht committete Änderungen. Update ist nicht möglich.</p>';
          html += '<button type="button" class="secondary" disabled>Update nicht möglich</button>';
        } else {
          html += '<button type="button" onclick="performGitUpdate()" class="primary">Jetzt aktualisieren</button>';
        }
        html += '<div id="git-update-message" style="margin-top: 0.8rem;"></div>';
        html += '</div>';

        html += '</div>';

        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = `<p style="color: #ef4444;">Fehler beim Laden: ${error.message}</p>`;
      }
    }

    window.performGitUpdate = async () => {
      const messageDiv = document.getElementById('git-update-message');
      if (!messageDiv) return;

      if (!confirm('Möchten Sie wirklich das System aktualisieren? Der Service wird dabei neu gestartet.')) {
        return;
      }

      messageDiv.innerHTML = '<p class="muted">Update wird durchgeführt...</p>';

      try {
        const response = await fetch('/admin/system/git-update', {
          method: 'POST'
        });
        let result;
        const ct = (response.headers.get('content-type') || '').toLowerCase();
        if (ct.includes('application/json')) {
          result = await response.json();
        } else {
          const text = await response.text();
          messageDiv.innerHTML = `<p style="color: #ef4444;">Fehler: Unerwartete Antwort vom Server: ${text}</p>`;
          return;
        }

        if (result.success) {
          messageDiv.innerHTML = `<p style="color: #10b981;">${result.message}</p>`;
          setTimeout(() => {
            messageDiv.innerHTML += '<p class="muted">Seite wird in 5 Sekunden neu geladen...</p>';
            setTimeout(() => location.reload(), 5000);
          }, 2000);
        } else {
          messageDiv.innerHTML = `<p style="color: #ef4444;">Fehler: ${result.error}</p>`;
        }
      } catch (error) {
        messageDiv.innerHTML = `<p style="color: #ef4444;">Fehler: ${error.message}</p>`;
      }
    };

    const mediaFeedback = document.querySelector('[data-media-feedback]');
    const mediaUploadInput = document.querySelector('[data-media-upload]');
    const mediaUploadBtn = document.querySelector('[data-media-upload-btn]');

    const setMediaFeedback = (message, type) => {
      if (!mediaFeedback) return;
      if (!message) {
        mediaFeedback.textContent = "";
        mediaFeedback.classList.remove('error', 'success');
        mediaFeedback.style.display = 'none';
        return;
      }
      mediaFeedback.textContent = message;
      mediaFeedback.classList.remove('error', 'success');
      mediaFeedback.classList.add(type === 'error' ? 'error' : 'success');
      mediaFeedback.style.display = 'block';
    };

    const refreshMediaList = async () => {
      try {
        const response = await fetch('/admin/media/list');
        const data = await response.json();
        if (data.files) {
          updateMediaSelects(data.files);
          updateMediaRows(data.files);
        }
      } catch (err) {
        setMediaFeedback('Fehler beim Laden der Medienliste.', 'error');
      }
    };

    const updateMediaSelects = (files) => {
      document.querySelectorAll('[data-media-select]').forEach((select) => {
        const current = select.value;
        select.innerHTML = '<option value="">Kein Bild</option>';
        files.forEach((file) => {
          const option = document.createElement('option');
          option.value = file;
          option.textContent = file;
          select.appendChild(option);
        });
        if (files.includes(current)) {
          select.value = current;
        }
      });
    };

    const updateMediaRows = (files) => {
      const list = document.querySelector('[data-media-list]');
      if (!list) return;
      if (!files.length) {
        list.innerHTML = '<p class="muted">Noch keine Medien hochgeladen.</p>';
        return;
      }
      list.innerHTML = '';
      files.forEach((filename) => {
        const row = document.createElement('div');
        row.className = 'media-row';
        row.dataset.mediaRow = filename;
        row.innerHTML = `
          <img src="/uploads/${filename}" alt="${filename}">
          <div style="flex:1; min-width: 180px;">
            <div><strong>${filename}</strong></div>
            <div class="muted">Verwendbar für Shotcounter & Preisliste</div>
          </div>
          <div class="stack" style="min-width: 200px;">
            <label>Neuer Name</label>
            <input type="text" placeholder="z.B. headerbild" data-media-rename-input value="${filename.split('.').slice(0, -1).join('.')}">
          </div>
          <button type="button" class="secondary" data-media-rename-btn>Umbenennen</button>
        `;
        list.appendChild(row);
      });
      bindMediaRenameButtons();
    };

    const uploadMedia = async () => {
      if (!mediaUploadInput || !mediaUploadInput.files || !mediaUploadInput.files[0]) {
        setMediaFeedback('Bitte zuerst eine Datei auswählen.', 'error');
        return;
      }
      const formData = new FormData();
      formData.append('media_file', mediaUploadInput.files[0]);
      setMediaFeedback('Upload läuft...', 'success');
      try {
        const response = await fetch('/admin/media/upload', { method: 'POST', body: formData });
        const data = await response.json();
        if (!data.success) {
          setMediaFeedback(data.error || 'Upload fehlgeschlagen.', 'error');
          return;
        }
        setMediaFeedback(`Datei gespeichert: ${data.filename}`, 'success');
        mediaUploadInput.value = '';
        if (data.files) {
          updateMediaSelects(data.files);
          updateMediaRows(data.files);
        }
      } catch (err) {
        setMediaFeedback('Upload fehlgeschlagen. Bitte erneut versuchen.', 'error');
      }
    };

    if (mediaUploadBtn) {
      mediaUploadBtn.addEventListener('click', uploadMedia);
    }
    if (mediaUploadInput) {
      mediaUploadInput.addEventListener('change', () => {
        if (mediaUploadInput.files && mediaUploadInput.files.length) {
          uploadMedia();
        }
      });
    }

    const bindMediaRenameButtons = () => {
      document.querySelectorAll('[data-media-rename-btn]').forEach((button) => {
        button.addEventListener('click', async () => {
          const row = button.closest('[data-media-row]');
          if (!row) return;
          const filename = row.dataset.mediaRow;
          const input = row.querySelector('[data-media-rename-input]');
          if (!input) return;
          const newName = input.value.trim();
          if (!newName) {
            setMediaFeedback('Bitte einen neuen Namen eingeben.', 'error');
            return;
          }
          const formData = new FormData();
          formData.append('filename', filename);
          formData.append('new_name', newName);
          setMediaFeedback('Benenne um...', 'success');
          try {
            const response = await fetch('/admin/media/rename', { method: 'POST', body: formData });
            const data = await response.json();
            if (!data.success) {
              setMediaFeedback(data.error || 'Umbenennen fehlgeschlagen.', 'error');
              return;
            }
            setMediaFeedback(`Datei umbenannt zu: ${data.filename}`, 'success');
            if (data.files) {
              updateMediaSelects(data.files);
              updateMediaRows(data.files);
            } else {
              refreshMediaList();
            }
            document.querySelectorAll('[data-media-select]').forEach((select) => {
              if (select.value === filename) {
                select.value = data.filename;
                select.dispatchEvent(new Event('input', { bubbles: true }));
                select.dispatchEvent(new Event('change', { bubbles: true }));
              }
            });
          } catch (err) {
            setMediaFeedback('Umbenennen fehlgeschlagen. Bitte erneut versuchen.', 'error');
          }
        });
      });
    };

    bindMediaRenameButtons();

    document.querySelectorAll('[data-file-upload]').forEach((input) => {
      input.addEventListener('change', () => {
        const formId = input.getAttribute('form');
        const form = formId ? document.getElementById(formId) : null;
        if (form) {
          form.submit();
        }
      });
    });
  })();
</script>

{% endblock %}
