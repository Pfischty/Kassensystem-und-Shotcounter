{% extends "base.html" %}
{% block title %}Event Einstellungen{% endblock %}
{% block content %}
<h1>{{ event.name }} – Einstellungen</h1>

<style>
  .muted { color: #94a3b8; font-size: 0.95rem; }
  .hint { font-size:0.9rem; color:#cbd5e1; margin-top:0.2rem; }
  .stack { display:flex; flex-direction:column; gap:0.35rem; }
  .field-inline { display:flex; gap:0.6rem; flex-wrap:wrap; align-items:center; }
  .collapsible { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .collapsible__header { display:flex; justify-content:space-between; align-items:center; gap:0.8rem; padding: 0.75rem 1rem; background: rgba(255,255,255,0.04); }
  .collapsible__content { padding: 1rem; border-top: 1px solid var(--border); background: rgba(255,255,255,0.02); }
  .collapsible [data-toggle] { min-width: 130px; }
  .inline-actions { display:flex; gap:0.4rem; flex-wrap:wrap; align-items:center; }
  .product-editor {
    margin-top: 0.6rem;
    border: 1px dashed var(--border);
    border-radius: 10px;
    padding: 0.9rem;
    background: rgba(255,255,255,0.02);
  }
  .product-editor__top { display:flex; align-items:center; justify-content:space-between; gap:0.6rem; flex-wrap:wrap; }
  .product-editor__preview {
    margin-top: 0.8rem;
    display: grid;
    gap: 0.6rem;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }
  .product-editor__preview[data-product-preview="cashier"] {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }
  .product-editor__preview[data-product-preview="cashier"] .price-preview-category {
    width: 100%;
  }
  .category-order {
    margin-top: 0.8rem;
    padding: 0.75rem;
    border: 1px dashed var(--border);
    border-radius: 10px;
    background: rgba(255,255,255,0.02);
  }
  .category-order__list {
    margin-top: 0.6rem;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
  .category-order__item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.6rem;
    padding: 0.35rem 0.6rem;
    border-radius: 8px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    cursor: grab;
  }
  .category-order__item.is-dragging {
    opacity: 0.6;
    cursor: grabbing;
  }
  .category-order__list.is-dragging {
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
  }
  .category-order__name {
    flex: 1;
    min-width: 120px;
    max-width: 220px;
  }
  .category-order__name input {
    width: 100%;
  }
  .category-order__actions { display: flex; gap: 0.35rem; }
  .product-editor__previews {
    display: grid;
    gap: 1rem;
    margin-top: 0.8rem;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  }
  .product-preview-block {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 0.75rem;
    background: rgba(255,255,255,0.02);
  }
  .product-preview-title { font-weight: 700; margin-bottom: 0.5rem; }
  .product-editor__preview--list {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }
  .price-preview-category { border-top: 1px dashed var(--border); padding-top: 0.5rem; }
  .price-preview-category:first-child { border-top: none; padding-top: 0; }
  .price-preview-category h4 { margin: 0 0 0.35rem 0; font-size: 0.95rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.04em; }
  .price-preview-item { display:flex; justify-content:space-between; font-size: 0.95rem; }
  .product-preview-card {
    border-radius: 12px;
    padding: 0.85rem;
    color: #e2e8f0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.08);
    cursor: grab;
    transition: transform 0.15s ease, box-shadow 0.2s ease;
  }
  .product-preview-card small { opacity: 0.75; display:block; margin-bottom:0.35rem; }
  .product-preview-card.dragging { opacity: 0.6; transform: scale(0.98); }
  .product-preview-card.drag-over { outline: 2px dashed rgba(255,255,255,0.5); }
  .product-editor__list { margin-top: 1rem; display:flex; flex-direction:column; gap:0.75rem; }
  .product-category { margin-top: 0.8rem; }
  .product-category__header { display:flex; justify-content:space-between; align-items:center; gap:0.6rem; margin:0.2rem 0 0.4rem; }
  .product-category__list { display:flex; flex-direction:column; gap:0.75rem; }
  .product-row {
    display:grid;
    grid-template-columns:
      minmax(200px, 1.3fr)
      minmax(200px, 1.1fr)
      minmax(170px, 0.8fr)
      minmax(180px, 0.9fr)
      minmax(180px, 0.7fr);
    gap:0.6rem;
    background:#0c1324;
    border:1px solid var(--border);
    border-radius:10px;
    padding:0.75rem;
    align-items:end;
    cursor: grab;
  }
  .product-row.is-dragging { opacity: 0.6; cursor: grabbing; }
  .product-field-group {
    display:grid;
    grid-template-columns: minmax(110px, 1fr) minmax(90px, 1fr);
    gap:0.6rem;
    align-items:end;
  }
  .product-field-group--actions {
    grid-template-columns: minmax(120px, 1fr) minmax(110px, 1fr);
  }
  .product-field-group input[type="number"] {
    max-width: 140px;
  }
  .product-field-group .row-actions button {
    padding: 0.45rem 0.6rem;
  }
  .product-row label { font-size: 0.9rem; color: #cbd5e1; display:block; margin-bottom:0.2rem; }
  .product-row .row-actions { display:flex; justify-content:flex-end; align-items:flex-end; }
  .product-row .row-actions button { width:100%; }
  .color-input { width:100%; min-height:44px; padding: 0; }
  .pill { padding: 0.3rem 0.7rem; border-radius: 999px; background: rgba(255,255,255,0.06); border: 1px solid var(--border); font-size: 0.9rem; }
  .shot-settings { margin: 0.8rem 0; }
  .shot-settings__grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:0.6rem; margin-top: 0.4rem; }
  .shot-settings__grid span { font-size: 0.9rem; color: #cbd5e1; }
  .shot-settings__numbers { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:0.6rem; margin-top: 0.6rem; }
  .visibility-toggle { display:flex; gap:0.4rem; flex-wrap:wrap; }
  .visibility-toggle .pill-toggle {
    display:inline-flex;
    align-items:center;
    gap:0.35rem;
    padding:0.35rem 0.6rem;
    border-radius:999px;
    border:1px solid var(--border);
    background: rgba(255,255,255,0.04);
    cursor:pointer;
    font-size:0.9rem;
  }
  .visibility-toggle .pill-toggle input { margin:0; }
  .button-link { display:inline-block; background: #334155; color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem 0.75rem; font-weight: 700; }
  .tabs { margin-top: 0.8rem; }
  .tabs__nav { display:flex; flex-wrap:wrap; gap:0.4rem; padding: 0.4rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 12px; }
  .tabs__btn { border: 1px solid transparent; background: transparent; color: #cbd5e1; padding: 0.45rem 0.75rem; border-radius: 10px; font-weight: 700; cursor: pointer; }
  .tabs__btn.is-active { background: rgba(56,189,248,0.12); border-color: rgba(56,189,248,0.5); color: #e2e8f0; }
  .tabs[data-tabs-ready="true"] .tabs__panel { display:none; margin-top: 0.9rem; }
  .tabs[data-tabs-ready="true"] .tabs__panel.is-active { display:block; }
</style>

<div class="field-inline" style="margin-bottom: 1rem;">
  <a class="button-link" href="{{ url_for('admin') }}">← Zurück</a>
</div>

<form method="post" action="{{ url_for('update_event', event_id=event.id) }}" data-event-form data-scope="{{ event.id }}">
  <input type="hidden" name="next" value="{{ url_for('admin_event_settings', event_id=event.id) }}">
  <input type="hidden" name="shared_settings" value='{{ (event.shared_settings or {}) | tojson }}'>
  {% set current_shot = (shot_settings_map.get(event.id) or shotcounter_defaults) %}

  <div class="tabs" data-tabs>
    <div class="tabs__nav">
      <button type="button" class="tabs__btn" data-tab-target="general">Allgemein</button>
      <button type="button" class="tabs__btn" data-tab-target="shotcounter">Shotcounter</button>
      <button type="button" class="tabs__btn" data-tab-target="price">Preisliste</button>
      <button type="button" class="tabs__btn" data-tab-target="products">Produkte & Kategorien</button>
      <button type="button" class="tabs__btn" data-tab-target="import">Import/Export</button>
    </div>

    <div class="tabs__panel" data-tab-panel="general">
      <div class="field-inline" style="margin: 0.4rem 0;">
        <label><input type="checkbox" name="kassensystem_enabled" {% if event.kassensystem_enabled %}checked{% endif %}> Kassensystem aktiv</label>
        <label><input type="checkbox" name="shotcounter_enabled" {% if event.shotcounter_enabled %}checked{% endif %}> Shotcounter aktiv</label>
      </div>
      <div class="field-inline" style="margin: 0.6rem 0;">
        <label><input type="checkbox" name="auto_reload_on_add" {% if event.shared_settings and event.shared_settings.get('auto_reload_on_add', True) %}checked{% endif %} data-shared-setting> Auto-Reload beim Hinzufügen (Kasse)</label>
      </div>
      <div class="muted" style="margin-bottom: 0.6rem;">Wenn deaktiviert, wird die Kasse nicht neu geladen beim Hinzufügen von Artikeln (performanter).</div>

      {% if events|length > 1 %}
      <div class="stack" style="margin:0.6rem 0;">
        <label>Einstellungen aus Event kopieren</label>
        <div class="field-inline">
          <select data-copy-select>
            <option value="">Bitte wählen</option>
            {% for template in events if template.id != event.id %}
              <option value="{{ template.id }}">{{ template.name }}</option>
            {% endfor %}
          </select>
          <button type="button" class="secondary" data-copy-btn>Übernehmen</button>
          <span class="pill">kopiert auch Produkte</span>
        </div>
      </div>
      {% endif %}
    </div>

    <div class="tabs__panel" data-tab-panel="shotcounter">
      <div
        class="shot-settings"
        data-shot-settings
        data-defaults='{{ shotcounter_defaults | tojson }}'
        data-current='{{ (shot_settings_map.get(event.id) or shotcounter_defaults) | tojson }}'
      >
        <strong>Shotcounter Styling</strong>
        <div class="muted">Steuert Vollbild/Touch: Farben, Schriftgrößen und Teamanzahl.</div>
        <div class="shot-settings__grid">
          <label class="stack">
            <span>Hintergrund</span>
            <input type="color" class="color-input" data-shot-field="background_color" value="{{ current_shot.get('background_color', shotcounter_defaults.get('background_color')) }}">
          </label>
          <label class="stack">
            <span>Primärfarbe (Karten)</span>
            <input type="color" class="color-input" data-shot-field="primary_color" value="{{ current_shot.get('primary_color', shotcounter_defaults.get('primary_color')) }}">
          </label>
          <label class="stack">
            <span>Sekundärfarbe (Verlauf)</span>
            <input type="color" class="color-input" data-shot-field="secondary_color" value="{{ current_shot.get('secondary_color', shotcounter_defaults.get('secondary_color')) }}">
          </label>
          <label class="stack">
            <span>Terziärfarbe (Verlauf)</span>
            <input type="color" class="color-input" data-shot-field="tertiary_color" value="{{ current_shot.get('tertiary_color', shotcounter_defaults.get('tertiary_color')) }}">
          </label>
        </div>
        <div class="shot-settings__numbers">
          <label class="stack">
            <span>Schriftgröße Titel (rem)</span>
            <input type="number" step="0.1" min="0.5" max="10" data-shot-field="title_size" value="{{ current_shot.get('title_size', shotcounter_defaults.get('title_size')) }}">
          </label>
          <label class="stack">
            <span>Schriftgröße Teams (rem)</span>
            <input type="number" step="0.1" min="0.5" max="10" data-shot-field="team_size" value="{{ current_shot.get('team_size', shotcounter_defaults.get('team_size')) }}">
          </label>
          <label class="stack">
            <span>Teams im Leaderboard</span>
            <input type="number" step="1" min="1" max="50" data-shot-field="leaderboard_limit" value="{{ current_shot.get('leaderboard_limit', shotcounter_defaults.get('leaderboard_limit')) }}">
          </label>
        </div>
        <div class="shot-settings__numbers" style="margin-top: 0.6rem;">
          <label class="stack">
            <span>Leaderboard Layout</span>
            <select data-shot-field="leaderboard_layout">
              <option value="stacked" {% if current_shot.get('leaderboard_layout', shotcounter_defaults.get('leaderboard_layout')) == 'stacked' %}selected{% endif %}>Teamname + Shots (2 Zeilen)</option>
              <option value="inline" {% if current_shot.get('leaderboard_layout', shotcounter_defaults.get('leaderboard_layout')) == 'inline' %}selected{% endif %}>Teamname – Shots (1 Zeile)</option>
            </select>
          </label>
        </div>

        <!-- Background Image Upload -->
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
          <strong>Hintergrundbild</strong>
          <div class="muted">Optional: Bild als Hintergrund für die Leaderboard-Anzeige hochladen.</div>
          {% set current_bg = shot_settings_map.get(event.id, {}).get('background_image') %}
          {% if current_bg %}
            <div style="margin-top: 0.6rem; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
              <img src="{{ url_for('uploaded_file', filename=current_bg) }}" alt="Aktuelles Hintergrundbild" style="max-width: 200px; max-height: 120px; border-radius: 8px; border: 1px solid var(--border);">
              <button
                type="submit"
                class="danger"
                form="bg-delete-{{ event.id }}"
                    data-confirm="Hintergrundbild wirklich entfernen?"
                    data-confirm-text="Entfernen"
                    data-confirm-class="danger"
              >Bild entfernen</button>
            </div>
          {% endif %}
          <div style="margin-top: 0.6rem;">
            <div class="field-inline">
              <input
                type="file"
                name="background_image"
                accept="image/png,image/jpeg,image/gif,image/webp"
                style="max-width: 300px;"
                form="bg-upload-{{ event.id }}"
              >
              <button type="submit" form="bg-upload-{{ event.id }}">Hochladen</button>
            </div>
            <div class="muted" style="margin-top: 0.3rem;">Erlaubte Formate: PNG, JPG, GIF, WebP. Max. 5 MB.</div>
          </div>
        </div>

        <input type="hidden" name="shotcounter_settings" value='{{ (shot_settings_map.get(event.id) or shotcounter_defaults) | tojson }}'>
      </div>
    </div>

    <div class="tabs__panel" data-tab-panel="price">
      {% set current_pl = (event.shared_settings or {}).get('price_list', {}) %}
      {% set current_pl_bg = current_pl.get('background_image') %}
      <div
        class="price-settings"
        data-price-settings
        data-defaults='{{ price_list_defaults | tojson }}'
        data-current='{{ current_pl | tojson }}'
        data-scope="{{ event.id }}"
      >
        <strong>Preisliste</strong>
        <div class="muted" style="margin-bottom: 0.6rem;">Rotierende Kategorien für die Preisanzeige.</div>
        <div class="shot-settings__numbers">
          <label class="stack">
            <span>Schriftgröße (rem)</span>
            <input type="number" step="0.1" min="0.6" max="6" data-price-field="font_size">
          </label>
          <label class="stack">
            <span>Wechsel-Intervall (Sek.)</span>
            <input type="number" step="1" min="2" max="120" data-price-field="rotation_seconds">
          </label>
          <label class="stack">
            <span>Hintergrundbild</span>
            <select data-price-field="background_mode">
              <option value="none">Kein Bild</option>
              <option value="custom">Eigenes Bild verwenden</option>
            </select>
          </label>
        </div>
        <div class="shot-settings__numbers" style="margin-top: 0.6rem;">
          <label class="stack">
            <span>Hintergrundfarbe</span>
            <input type="color" class="color-input" data-price-field="background_color">
          </label>
        </div>

        <div data-price-custom-bg style="margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid var(--border);">
          <strong>Preisliste Hintergrundbild</strong>
          <div class="muted">Optional: eigenes Bild für die Preisliste.</div>
          <div class="shot-settings__numbers" style="margin-top: 0.6rem;">
            <label class="stack" style="min-width: 220px;">
              <span>Vorhandenes Bild wählen</span>
              <select data-price-image-select>
                <option value="">Kein Bild</option>
                {% for filename in price_list_images %}
                  <option value="{{ filename }}">{{ filename }}</option>
                {% endfor %}
              </select>
            </label>
            <div style="display:flex; align-items:flex-end; gap:0.6rem;">
              <img data-price-image-preview src="" alt="Preisliste Hintergrund Vorschau" style="max-width: 200px; max-height: 120px; border-radius: 8px; border: 1px solid var(--border); display:none;">
            </div>
          </div>
          {% if current_pl_bg %}
            <div style="margin-top: 0.6rem; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
              <img src="{{ url_for('uploaded_file', filename=current_pl_bg) }}" alt="Aktuelles Preisliste-Hintergrundbild" style="max-width: 200px; max-height: 120px; border-radius: 8px; border: 1px solid var(--border);">
              <button
                type="submit"
                class="danger"
                form="pl-delete-{{ event.id }}"
                data-confirm="Preisliste-Hintergrundbild wirklich entfernen?"
                data-confirm-text="Entfernen"
                data-confirm-class="danger"
              >Bild entfernen</button>
            </div>
          {% endif %}
          <div style="margin-top: 0.6rem;">
            <div class="field-inline">
              <input
                type="file"
                name="price_list_background"
                accept="image/png,image/jpeg,image/gif,image/webp"
                style="max-width: 300px;"
                form="pl-upload-{{ event.id }}"
              >
              <button type="submit" form="pl-upload-{{ event.id }}">Hochladen</button>
            </div>
            <div class="muted" style="margin-top: 0.3rem;">Erlaubte Formate: PNG, JPG, GIF, WebP. Max. 5 MB.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="tabs__panel" data-tab-panel="products">
      <div class="product-editor" data-product-editor data-scope="{{ event.id }}" data-items='{{ event_buttons.get(event.id, default_buttons) | tojson }}'>
        <div class="product-editor__top">
          <div>
            <strong>Produkte für dieses Event</strong>
            <div class="muted">Titel, Preis und Kategorie bearbeiten (Farben werden nur in der Vorschau angezeigt).</div>
            <div class="field-inline" style="margin-top:0.45rem;">
              <label class="stack" style="min-width: 180px;">
                <span>Depot-Preis (CHF)</span>
                <input type="number" step="1" min="0" data-depot-price>
              </label>
              <span class="muted">Depot gilt global, pro Produkt nur aktivierbar.</span>
            </div>
          </div>
          <div class="inline-actions">
            <button type="button" class="secondary" data-add-product>+ Produkt</button>
          </div>
        </div>
        <div class="product-editor__previews">
          <div class="product-preview-block">
            <div class="product-preview-title">Kasse Vorschau (sichtbare Produkte)</div>
            <div class="product-editor__preview" data-product-preview="cashier"></div>
          </div>
          <div class="product-preview-block">
            <div class="product-preview-title">Preisliste Vorschau (sortiert)</div>
            <div class="product-editor__preview product-editor__preview--list" data-product-preview="price"></div>
          </div>
        </div>
        <div class="category-order" data-category-order>
          <div class="field-inline" style="justify-content: space-between; align-items: center;">
            <div>
              <strong>Kategorieneinstellungen</strong>
              <div class="muted">Reihenfolge + Aktivierung je Kategorie für Kasse & Preisliste.</div>
            </div>
            <button type="button" class="secondary" data-add-category>+ Kategorie</button>
          </div>
          <div class="category-order__list" data-category-order-list></div>
        </div>
        <div class="product-editor__list" data-product-list></div>
        <input type="hidden" name="kassensystem_settings" value='{{ kass_settings.get(event.id, {"items": event_buttons.get(event.id, default_buttons)}) | tojson }}'>
      </div>
    </div>

    <div class="tabs__panel" data-tab-panel="import">
      <div class="field-inline" style="margin-top:0.4rem;">
        <label class="secondary" style="padding:0.45rem 0.65rem; cursor:pointer;">
          Produkte-JSON importieren
          <input type="file" accept="application/json" data-product-import hidden>
        </label>
        <button type="button" class="secondary" data-product-export>Produkte exportieren</button>
      </div>
      <div class="muted" style="margin-top: 0.4rem;">Import ersetzt die Produktliste in diesem Event.</div>

      <div class="field-inline" style="margin-top:0.8rem;">
        <label class="secondary" style="padding:0.45rem 0.65rem; cursor:pointer;">
          Event-JSON importieren
          <input type="file" accept="application/json" data-import-event hidden>
        </label>
        <button type="button" class="secondary" data-export-event>Event-JSON exportieren</button>
      </div>
      <div class="muted" style="margin-top: 0.4rem;">Import ersetzt die Felder oben, JSON bleibt optional.</div>
    </div>
  </div>

  <div class="form-actions" style="margin-top: 1rem;">
    <button type="submit" class="primary" data-submit-btn>Speichern</button>
    <span class="form-status" data-form-status style="margin-left: 0.8rem; color: #94a3b8; display: none;"></span>
  </div>
</form>
<form id="bg-upload-{{ event.id }}" method="post" action="{{ url_for('upload_background', event_id=event.id) }}" enctype="multipart/form-data"></form>
<form id="bg-delete-{{ event.id }}" method="post" action="{{ url_for('upload_background', event_id=event.id) }}">
  <input type="hidden" name="delete_background" value="1">
</form>
<form id="pl-upload-{{ event.id }}" method="post" action="{{ url_for('upload_price_list_background', event_id=event.id) }}" enctype="multipart/form-data"></form>
<form id="pl-delete-{{ event.id }}" method="post" action="{{ url_for('upload_price_list_background', event_id=event.id) }}">
  <input type="hidden" name="delete_price_list_background" value="1">
</form>

<script id="event-settings-data" type="application/json">
  {{ event_payloads | tojson }}
</script>
<script id="default-buttons-data" type="application/json">
  {{ default_buttons | tojson }}
</script>
<script id="shotcounter-defaults-data" type="application/json">
  {{ shotcounter_defaults | tojson }}
</script>
<script id="price-list-defaults-data" type="application/json">
  {{ price_list_defaults | tojson }}
</script>
<script src="{{ url_for('static', filename='js/admin.js', v='4') }}" defer></script>
{% endblock %}
